![MobileSideBar](https://kexue.fm/usr/themes/geekg/images/slide-button.png)

## SEARCH

## MENU

- [打赏](https://kexue.fm/reward.html)
- [公式](https://kexue.fm/latex.html)
- [天象](https://kexue.fm/ac.html)
- [链接](https://kexue.fm/links.html)
- [时光](https://kexue.fm/me.html)
- [博览](https://kexue.fm/science.html)
- [归档](https://kexue.fm/content.html)

## CATEGORIES

- [千奇百怪](https://kexue.fm/category/Everything)
- [天文探索](https://kexue.fm/category/Astronomy)
- [数学研究](https://kexue.fm/category/Mathematics)
- [物理化学](https://kexue.fm/category/Phy-chem)
- [信息时代](https://kexue.fm/category/Big-Data)
- [生物自然](https://kexue.fm/category/Biology)
- [图片摄影](https://kexue.fm/category/Photograph)
- [问题百科](https://kexue.fm/category/Questions)
- [生活/情感](https://kexue.fm/category/Life-Feeling)
- [资源共享](https://kexue.fm/category/Resources)

## NEWPOSTS

- [一道概率不等式：盯着它到显然成立为止！](https://kexue.fm/archives/10902)
- [SVD的导数](https://kexue.fm/archives/10878)
- [智能家居之手搓一套能接入米家的零冷水装置](https://kexue.fm/archives/10869)
- [Transformer升级之路：1...](https://kexue.fm/archives/10862)
- [矩阵的有效秩（Effective ...](https://kexue.fm/archives/10847)
- [通过梯度近似寻找Normaliza...](https://kexue.fm/archives/10831)
- [MoE环游记：4、难处应当多投入](https://kexue.fm/archives/10815)
- [高阶muP：更简明但更高明的谱条件缩放](https://kexue.fm/archives/10795)
- [初探muP：超参数的跨模型尺度迁移规律](https://kexue.fm/archives/10770)
- [MoE环游记：3、换个思路来分配](https://kexue.fm/archives/10757)

## COMMENTS

- [韩老魔: "上式最优解显然就是让模长∥vi∥最小的n−k个γi等于1，这...](https://kexue.fm/archives/10699/comment-page-3#comment-27505)
- [WhateverOk: 苏神，请教一下，2维的RoPe是否也具有远程衰减性质呢？即靠近...](https://kexue.fm/archives/8397/comment-page-2#comment-27504)
- [长琴: mla出来之后就知道苏神一定会念念不忘。hah。没注意到公众号...](https://kexue.fm/archives/10862/comment-page-1#comment-27503)
- [Suahi: 谢谢苏老师的回复！\
我也是在从MLE出发推导VAE的Loss函...](https://kexue.fm/archives/5239/comment-page-3#comment-27502)
- [lay: 苏神，我在训练一个1.5B模型的过程中在某一步grad\_nor...](https://kexue.fm/archives/10657/comment-page-1#comment-27500)
- [hazdzz: 如果 RoPE 结合 Givens rotation meth...](https://kexue.fm/archives/10862/comment-page-1#comment-27499)
- [autumn23333: 请问一下论文附带的代码是不是写错了fourier\_sin = ...](https://kexue.fm/archives/10862/comment-page-1#comment-27498)
- [SunlightZero: 在《Step-by-Step Diffusion: An El...](https://kexue.fm/archives/9164/comment-page-4#comment-27497)
- [苏剑林: 1、明白了，我将$q\_{\\phi}(z\|x)$看成$q\_{\\p...](https://kexue.fm/archives/5239/comment-page-3#comment-27496)
- [Suahi: 谢谢苏老师的回复！1\. 首先回复您为什么ELBO不带KL，并不...](https://kexue.fm/archives/5239/comment-page-3#comment-27493)

## USERLOGIN

- [登录](https://kexue.fm/admin/login.php)

[科学空间\|Scientific Spaces](https://kexue.fm)

- [登录](https://kexue.fm/admin/login.php)
- [打赏](https://kexue.fm/reward.html)
- [公式](https://kexue.fm/latex.html)
- [天象](https://kexue.fm/ac.html)
- [链接](https://kexue.fm/links.html)
- [时光](https://kexue.fm/me.html)
- [博览](https://kexue.fm/science.html)
- [归档](https://kexue.fm/content.html)

渴望成为一个小飞侠

- [![](https://kexue.fm/usr/themes/geekg/images/rss.png)\
\
欢迎订阅](https://kexue.fm/feed)
- [![](https://kexue.fm/usr/themes/geekg/images/mail.png)\
\
个性邮箱](https://kexue.fm/archives/119)
- [![](https://kexue.fm/usr/themes/geekg/images/Saturn.png)\
\
天象信息](https://kexue.fm/ac.html)
- [![](https://kexue.fm/usr/themes/geekg/images/iss.png)\
\
观测ISS](https://kexue.fm/archives/41)
- [![](https://kexue.fm/usr/themes/geekg/images/pi.png)\
\
LaTeX](https://kexue.fm/latex.html)
- [![](https://kexue.fm/usr/themes/geekg/images/mlogo.png)\
\
关于博主](https://kexue.fm/me.html)

欢迎访问“科学空间”，这里将与您共同探讨自然科学，回味人生百态；也期待大家的分享～

- [**千奇百怪** Everything](https://kexue.fm/category/Everything)
- [**天文探索** Astronomy](https://kexue.fm/category/Astronomy)
- [**数学研究** Mathematics](https://kexue.fm/category/Mathematics)
- [**物理化学** Phy-chem](https://kexue.fm/category/Phy-chem)
- [**信息时代** Big-Data](https://kexue.fm/category/Big-Data)
- [**生物自然** Biology](https://kexue.fm/category/Biology)
- [**图片摄影** Photograph](https://kexue.fm/category/Photograph)
- [**问题百科** Questions](https://kexue.fm/category/Questions)
- [**生活/情感** Life-Feeling](https://kexue.fm/category/Life-Feeling)
- [**资源共享** Resources](https://kexue.fm/category/Resources)

- [**千奇百怪**](https://kexue.fm/category/Everything)
- [**天文探索**](https://kexue.fm/category/Astronomy)
- [**数学研究**](https://kexue.fm/category/Mathematics)
- [**物理化学**](https://kexue.fm/category/Phy-chem)
- [**信息时代**](https://kexue.fm/category/Big-Data)
- [**生物自然**](https://kexue.fm/category/Biology)
- [**图片摄影**](https://kexue.fm/category/Photograph)
- [**问题百科**](https://kexue.fm/category/Questions)
- [**生活/情感**](https://kexue.fm/category/Life-Feeling)
- [**资源共享**](https://kexue.fm/category/Resources)

[首页](https://kexue.fm) [信息时代](https://kexue.fm/category/Big-Data) Nyströmformer：基于矩阵分解的线性化Attention方案

16Feb

# [Nyströmformer：基于矩阵分解的线性化Attention方案](https://kexue.fm/archives/8180)

By 苏剑林 \|
2021-02-16 \|
55663位读者\|

标准Attention的$\\mathcal{O}(n^2)$复杂度可真是让研究人员头大。前段时间我们在博文 [《Performer：用随机投影将Attention的复杂度线性化》](https://kexue.fm/archives/7921) 中介绍了Google的Performer模型，它通过随机投影的方式将标准Attention转化为线性Attention。无独有偶，前些天Arxiv上放出了AAAI 2021的一篇论文 [《Nyströmformer: A Nyström-Based Algorithm for Approximating Self-Attention》](https://papers.cool/arxiv/2102.03902)，里边又提出了一种从另一个角度把标准Attention线性化的方案。

该方案写的是Nyström-Based，顾名思义是利用了Nyström方法来近似标准Attention的。但是坦白说，在看到这篇论文之前，笔者也完全没听说过Nyström方法，而纵观整篇论文，里边也全是笔者一眼看上去感觉很茫然的矩阵分解推导，理解起来颇为困难。不过有趣的是，尽管作者的推导很复杂，但笔者发现最终的结果可以通过一个相对来说更简明的方式来理解，遂将笔者对Nyströmformer的理解整理在此，供大家参考。

## 简单的回顾 [\#](https://kexue.fm/archives/8180\#%E7%AE%80%E5%8D%95%E7%9A%84%E5%9B%9E%E9%A1%BE)

如果读者对线性Attention还不是很了解，那么建议先通读一下 [《线性Attention的探索：Attention必须有个Softmax吗？》](https://kexue.fm/archives/7546) 和 [《Performer：用随机投影将Attention的复杂度线性化》](https://kexue.fm/archives/7921)。总的来说，线性Attention是通过矩阵乘法的结合律来降低Attention的复杂度。

### 标准Attention [\#](https://kexue.fm/archives/8180\#%E6%A0%87%E5%87%86Attention)

标准的Scaled-Dot Attention写成矩阵形式就是（有时候指数部分还会多个缩放因子，这里我们就不显式写出来了）：

\\begin{equation}Attention(\\boldsymbol{Q},\\boldsymbol{K},\\boldsymbol{V}) = softmax\\left(\\boldsymbol{Q}\\boldsymbol{K}^{\\top}\\right)\\boldsymbol{V}\\end{equation}

这里$\\boldsymbol{Q}, \\boldsymbol{K}, \\boldsymbol{V}\\in\\mathbb{R}^{n\\times d}$（对应Self Attention）。此外，本文的所有softmax，都是对矩阵的第二个维度做归一化。

在上式中，$\\boldsymbol{Q}\\boldsymbol{K}^{\\top}$这一步必须要先算出来，然后才能算softmax，它导致了我们不能使用矩阵乘法的结合律。而$\\boldsymbol{Q}\\boldsymbol{K}^{\\top}$是$n^2$个向量的内积，因此时间和空间复杂度都是$\\mathcal{O}(n^2)$。

### 线性Attention [\#](https://kexue.fm/archives/8180\#%E7%BA%BF%E6%80%A7Attention)

而线性Attention比较朴素的做法就是

\\begin{equation}\\left(\\phi(\\boldsymbol{Q})\\varphi(\\boldsymbol{K})^{\\top}\\right)\\boldsymbol{V}=\\phi(\\boldsymbol{Q})\\left(\\varphi(\\boldsymbol{K})^{\\top}\\boldsymbol{V}\\right)\\end{equation}

其中$\\phi,\\varphi$是值域非负的激活函数。为了方便对比，上式还没有显式地写出归一化因子，只突出了主要计算量的部分。上式左端的复杂度依然是$\\mathcal{O}(n^2)$的，由于矩阵乘法满足结合律，我们可以先算后面两个矩阵的乘法，这样整体复杂度就降为$\\mathcal{O}(n)$了。

上式是直接将Attention定义为两个矩阵的乘法来利用乘法结合律的，也可以将标准Attention（近似地）转化为矩阵的乘法来利用结合律，如下一节提到的Performer；此外，相乘矩阵也不一定是两个，比如本文要介绍的Nyströmformer就是将注意力表示为三个矩阵相乘的。

### Performer [\#](https://kexue.fm/archives/8180\#Performer)

对于Performer来说，它是通过随机投影来找到矩阵$\\tilde{\\boldsymbol{Q}},\\tilde{\\boldsymbol{K}}\\in\\mathbb{R}^{n\\times m}$使得softmax中的$e^{\\boldsymbol{Q}\\boldsymbol{K}^{\\top}}\\approx \\tilde{\\boldsymbol{Q}}\\tilde{\\boldsymbol{K}}^{\\top}$，这样一来标准Attention就可以近似为上一节的线性Attention来算了，细节请看之前的博文 [《Performer：用随机投影将Attention的复杂度线性化》](https://kexue.fm/archives/7921)。

如果对SVM和核方法等比较熟悉的读者可能会联想到，这个做法其实就是核函数的思想，即低维空间中两个向量的核函数可以映射为高维空间中两个向量的内积。它也可以跟LSH（Locality Sensitive Hashing）联系起来。

## Nyströmformer [\#](https://kexue.fm/archives/8180\#Nystr%C3%B6mformer)

在这部分内容中，我们以一个简单的双重softmax形式的线性Attention为出发点，逐步寻找更加接近标准Attention的线性Attention，从而得到Nyströmformer。

[![Nyströmformer结构示意图。读者可以读完下面几节后再来对照着理解这个图。](https://kexue.fm/usr/uploads/2021/02/3812836940.png)](https://kexue.fm/usr/uploads/2021/02/3812836940.png)

Nyströmformer结构示意图。读者可以读完下面几节后再来对照着理解这个图。

### 双重Softmax [\#](https://kexue.fm/archives/8180\#%E5%8F%8C%E9%87%8DSoftmax)

在文章 [《线性Attention的探索：Attention必须有个Softmax吗？》](https://kexue.fm/archives/7546) 中我们提到了一种比较有意思的线性Attention，它使用了双重softmax来构建Attention矩阵：

\\begin{equation}\\left(softmax(\\boldsymbol{Q}) softmax\\left(\\boldsymbol{K}^{\\top}\\right)\\right)\\boldsymbol{V}=softmax(\\boldsymbol{Q})\\left(softmax\\left(\\boldsymbol{K}^{\\top}\\right)\\boldsymbol{V}\\right)\\label{eq:2sm}\\end{equation}

可以证明这样构造出来的Attention矩阵自动满足归一化要求，不得不说这是一种简单漂亮的线性Attention方案。

不过，直接对$\\boldsymbol{Q},\\boldsymbol{K}^{\\top}$做softmax似乎有点奇怪，总感觉没有经过相似度（内积）对比就直接softmax会有哪里不对劲。为了解决这个问题，Nyströmformer先分别将$\\boldsymbol{Q},\\boldsymbol{K}$视为$n$个$d$维向量，然后聚成$m$类来得到$m$个聚类中心构成的矩阵$\\tilde{\\boldsymbol{Q}},\\tilde{\\boldsymbol{K}}\\in\\mathbb{R}^{m\\times d}$，这时候我们可以通过下述公式来定义Attention：

\\begin{equation}\\left(softmax\\left(\\boldsymbol{Q}\\tilde{\\boldsymbol{K}} ^{\\top}\\right)softmax\\left(\\tilde{\\boldsymbol{Q}}\\boldsymbol{K}^{\\top}\\right)\\right)\\boldsymbol{V} = softmax\\left(\\boldsymbol{Q} \\tilde{\\boldsymbol{K}}^{\\top}\\right)\\left(softmax\\left(\\tilde{\\boldsymbol{Q}}\\boldsymbol{K}^{\\top}\\right)\\boldsymbol{V}\\right)\\label{eq:2sm2}\\end{equation}

具体的聚类过程我们稍后再来讨论。现在，softmax的对象是内积的结果，具有比较鲜明的物理意义，因此可以认为上式比前面的式$\\eqref{eq:2sm}$更为合理。如果我们选定一个比较小的$m$，那么上式右端的复杂度只是线性地依赖于$n$，因此它也是一个线性Attention。

### 向标准靠近 [\#](https://kexue.fm/archives/8180\#%E5%90%91%E6%A0%87%E5%87%86%E9%9D%A0%E8%BF%91)

纯粹从改进式$\\eqref{eq:2sm}$的角度来看，式$\\eqref{eq:2sm2}$已经达到目标了，不过Nyströmformer并不局限于此，它还希望改进后的结果与标准Attention更加接近。为此，观察到式$\\eqref{eq:2sm2}$的注意力矩阵$softmax\\left(\\boldsymbol{Q}\\tilde{\\boldsymbol{K}}^{\\top}\\right)softmax\\left(\\tilde{\\boldsymbol{Q}}\\boldsymbol{K}^{\\top}\\right)$是一个$n\\times m$的矩阵乘以一个$m\\times n$的矩阵，为了微调结果，又不至于增加过多的复杂度，我们可以考虑在中间插入一个$m\\times m$的矩阵$\\boldsymbol{M}$：

\\begin{equation}softmax\\left(\\boldsymbol{Q}\\tilde{\\boldsymbol{K}} ^{\\top}\\right) \\,\\boldsymbol{M}\\, softmax\\left(\\tilde{\\boldsymbol{Q}}\\boldsymbol{K}^{\\top}\\right)\\end{equation}

如何选择$\\boldsymbol{M}$呢？一个合理的要求是当$m=n$时应当完全等价于标准Attention，此时$\\tilde{\\boldsymbol{Q}}=\\boldsymbol{Q}, \\tilde{\\boldsymbol{K}}=\\boldsymbol{K}$，推出

\\begin{equation}\\boldsymbol{M} = \\left(softmax\\left(\\boldsymbol{Q}\\boldsymbol{K}^{\\top}\\right)\\right)^{-1} = \\left(softmax\\left(\\tilde{\\boldsymbol{Q}}\\tilde{\\boldsymbol{K}}^{\\top}\\right)\\right)^{-1}\\end{equation}

对于一般的$m$，$\\left(softmax\\left(\\tilde{\\boldsymbol{Q}}\\tilde{\\boldsymbol{K}}^{\\top}\\right)\\right)^{-1}$恰好是一个$m\\times m$矩阵，因此选它作为$\\boldsymbol{M}$至少在矩阵运算上是合理的，而根据$m=n$时的特殊情况我们则“大胆地”推测选它作为$\\boldsymbol{M}$能让新的Attention机制更接近标准Attention，因此Nyströmformer最终选择的是

\\begin{equation}softmax\\left(\\boldsymbol{Q}\\tilde{\\boldsymbol{K}} ^{\\top}\\right) \\, \\left(softmax\\left(\\tilde{\\boldsymbol{Q}}\\tilde{\\boldsymbol{K}}^{\\top}\\right)\\right)^{-1} \\, softmax\\left(\\tilde{\\boldsymbol{Q}}\\boldsymbol{K}^{\\top}\\right)\\end{equation}

作为Attention矩阵，它是三个小矩阵的乘积，因此通过矩阵乘法的结合律就能转化为线性Attention。

不过，还有一个理论上的小细节需要补充一下，那就是上式涉及到矩阵的求逆，而$softmax\\left(\\tilde{\\boldsymbol{Q}}\\tilde{\\boldsymbol{K}}^{\\top}\\right)$未必是可逆的。当然，从实践上来看，一个实数的方阵不可逆的概率几乎为零（不可逆意味着行列式严格等于0，从概率上来看不等于0自然比等于0的概率大得多），因此这种情况在具体实验中可以不考虑，但理论上还是得完善的。这个其实也简单，如果是不可逆的矩阵，那就换成“伪逆”就好（记号为$^{\\dagger}$），它对任意矩阵都存在，并且当矩阵可逆时伪逆跟逆相等。

因此，最终的Nyströmformer的Attention矩阵形式为

\\begin{equation}softmax\\left(\\boldsymbol{Q}\\tilde{\\boldsymbol{K}} ^{\\top}\\right) \\, \\left(softmax\\left(\\tilde{\\boldsymbol{Q}}\\tilde{\\boldsymbol{K}}^{\\top}\\right)\\right)^{\\dagger} \\, softmax\\left(\\tilde{\\boldsymbol{Q}}\\boldsymbol{K}^{\\top}\\right)\\label{eq:2sm3}\\end{equation}

### 迭代求逆阵 [\#](https://kexue.fm/archives/8180\#%E8%BF%AD%E4%BB%A3%E6%B1%82%E9%80%86%E9%98%B5)

从理论上看，式$\\eqref{eq:2sm3}$已经达到目标了，不过落实到实践上还需要处理好一些细节问题，比如上述伪逆怎么求。伪逆又叫广义逆、Moore-Penrose逆等，标准的求法是通过SVD来求，设矩阵$\\boldsymbol{A}$的SVD分解为$\\boldsymbol{U} \\boldsymbol{\\Lambda} \\boldsymbol{V}^{\\top}$，那么它的伪逆为

\\begin{equation}\\boldsymbol{A}^{\\dagger} = \\boldsymbol{V} \\boldsymbol{\\Lambda}^{\\dagger} \\boldsymbol{U}^{\\top}\\end{equation}

其中对角阵$\\boldsymbol{\\Lambda}$的伪逆$\\boldsymbol{\\Lambda}^{\\dagger}$等于将它对角线所有非零值取倒数所得到的新对角阵。SVD的求法虽然理论上比较简单易懂，但计算量还是比较大的，而且也不容易求梯度，因此并不是实现伪逆的理想方式。

Nyströmformer采用了迭代求逆的近似方法。具体来说，它采用了论文 [《Chebyshev-type methods and preconditioning techniques》](https://www.researchgate.net/publication/220562466_Chebyshev-type_methods_and_preconditioning_techniques) 提供的迭代算法：

> 若初始矩阵$\\boldsymbol{V}\_0$满足$\\Vert \\boldsymbol{I} - \\boldsymbol{A} \\boldsymbol{V}\_0\\Vert < 1$，那么对于下述迭代格式
> \\begin{equation}\\begin{aligned}
> \\boldsymbol{V}\_{n+1} =&\\,\\left\[\\boldsymbol{I} + \\frac{1}{4}\\left(\\boldsymbol{I} - \\boldsymbol{V}\_n \\boldsymbol{A}\\right)\\left(3 \\boldsymbol{I} - \\boldsymbol{V}\_n \\boldsymbol{A}\\right)^2\\right\] \\boldsymbol{V}\_n \\\
> =&\\,\\frac{1}{4} \\boldsymbol{V}\_n (13 \\boldsymbol{I} − \\boldsymbol{A} \\boldsymbol{V}\_n (15 \\boldsymbol{I} − \\boldsymbol{A} \\boldsymbol{V}\_n (7 \\boldsymbol{I} − \\boldsymbol{A} \\boldsymbol{V}\_n)))
> \\end{aligned}\\end{equation}
> 成立$\\lim\\limits\_{n\\to\\infty} \\boldsymbol{V}\_n = \\boldsymbol{A}^{\\dagger}$。

这里的$\\Vert\\cdot\\Vert$可以是任意一种矩阵范数，满足条件的一个比较简单的初始值可以是

\\begin{equation}\\boldsymbol{V}\_0 = \\frac{\\boldsymbol{A}^{\\top}}{\\Vert\\boldsymbol{A}\\Vert\_1 \\Vert\\boldsymbol{A}\\Vert\_{\\infty}} = \\frac{\\boldsymbol{A}^{\\top}}{\\left(\\max\\limits\_j\\sum\\limits\_i \|A\_{i,j}\|\\right)\\left(\\max\\limits\_i\\sum\\limits\_j \|A\_{i,j}\|\\right)}\\end{equation}

在Nyströmformer论文中，作者直接用上述初始值和迭代格式进行迭代，将迭代6次的结果来代替$\\boldsymbol{A}^{\\dagger}$。迭代6次看上去很多，但事实上论文所选取的$m$比较小（论文写的是64），迭代过程中又只涉及到矩阵乘法，因此迭代计算量不会太大，而且只有乘法的话求梯度就很轻松了。这样求伪逆的问题就算是解决了，论文将这个迭代过程简写为pINV。

### 池化当聚类 [\#](https://kexue.fm/archives/8180\#%E6%B1%A0%E5%8C%96%E5%BD%93%E8%81%9A%E7%B1%BB)

还需要解决的另一个问题是聚类方法的选择，比较直接的想法自然就是直接套用K-Means了。然而，同前面求伪逆所面临的问题一样，在设计模型时不仅要考虑前向计算，还需要考虑反向传播的求梯度，直接套用K-Means涉及到$\\mathop{\\text{argmin}}$操作，无法求出有意义的梯度，需要将它“软化”才能嵌入到模型中，这一系列操作下来，其实就相当于胶囊网络的“动态路由”过程，细节我们在 [《再来一顿贺岁宴：从K-Means到Capsule》](https://kexue.fm/archives/5112) 讨论过。这个方案的主要问题是K-Means是一个迭代过程，需要迭代几次才能保证效果，这导致计算量明显加大，不是特别理想。

Nyströmformer选了一个非常简单的方案：假设序列长度$n$是$m$的整数倍（如果不是，padding零向量），那么将$\\boldsymbol{Q},\\boldsymbol{K}$的每$n/m$个向量求平均作为$\\tilde{\\boldsymbol{Q}}, \\tilde{\\boldsymbol{K}}$的每个向量。这个操作叫做Adaptive Average Pooling（原论文称为Segment-Means，简称sMEANS），即是一种平均池化方法，通过自适应窗口大小使得平均池化后的特征矩阵具有固定的形状。Nyströmformer的实验表明，不需要比较复杂的聚类方法，就这样使用简单的自适应池化就可以取得非常有竞争力的效果了，而且只需要选择$m=64$，跟映射前的$d$是一般大小，这比Performer要选择比$d$大几倍的$m$要好得多了。

不过，自适应池化的一个明显缺点是会“糅合”每一个区间的信息，导致它不能防止未来信息泄漏而不能做自回归生成（语言模型或者Seq2Seq的解码器），这基本是任何带有Pooling技术的模型的缺点。

## 实验与分析 [\#](https://kexue.fm/archives/8180\#%E5%AE%9E%E9%AA%8C%E4%B8%8E%E5%88%86%E6%9E%90)

这里我们汇总一下Nyströmformer的实验结果，并且分享一下笔者对它的一些看法和思考。

### 性能与效果 [\#](https://kexue.fm/archives/8180\#%E6%80%A7%E8%83%BD%E4%B8%8E%E6%95%88%E6%9E%9C)

可能受限于算力，原论文做的实验不算特别丰富，主要是将small和base版本的BERT里边的标准Attention替换为Nyströmformer进行对比实验，实验结果主要是下面两个图。其中一个是预训练效果图，其中比较有意思的是Nyströmformer在MLM任务上的效果比标准Attention还要优；另外是在下游任务上的微调效果，显示出跟标准Attention（即BERT）比还是有竞争力的。

[![Nyströmformer在预训练任务（MLM和SOP）上的效果](https://kexue.fm/usr/uploads/2021/02/3955448968.png)](https://kexue.fm/usr/uploads/2021/02/3955448968.png)

Nyströmformer在预训练任务（MLM和SOP）上的效果

[![Nyströmformer在下游任务的微调效果](https://kexue.fm/usr/uploads/2021/02/224692033.png)](https://kexue.fm/usr/uploads/2021/02/224692033.png)

Nyströmformer在下游任务的微调效果

不过，原论文并没有比较Nyströmformer跟同类模型的效果差异，只是提供下面的一张复杂度对比图，因此无法更好地突出Nyströmformer的竞争力：

[![不同模型的时间和空间复杂度对比图](https://kexue.fm/usr/uploads/2021/02/1447501421.png)](https://kexue.fm/usr/uploads/2021/02/1447501421.png)

不同模型的时间和空间复杂度对比图

### 个人的思考 [\#](https://kexue.fm/archives/8180\#%E4%B8%AA%E4%BA%BA%E7%9A%84%E6%80%9D%E8%80%83)

总的来说，Nyströmformer对标准Attention进行近似线性化的思路还是比较新颖的，值得学习与参考。不过伪逆部分的处理总感觉有点不大自然，这部分可能是未来的一个改进点，如果可以做到不用近似，那就比较完美了。还有，如何定量地估计Nyströmformer与标准Attention的误差，也是一个值得思考的理论问题。

从实验上来看，Nyströmformer跟标准Attention相比还是显得有竞争力的，尤其是MLM的结果比标准Attention还好，显示了Nyströmformer的潜力。此外，前面说到包含了Pooling导致不能做自回归生成是Nyströmformer的一个显著缺点，不知道有没有办法可以弥补，反正笔者目前是没有想到好的方向。

跟Performer相比，Nyströmformer去除了线性化过程中的随机性，因为Performer是通过随机投影来达到线性化的，这必然会带来随机性，对于某些有强迫症的读者来说，这个随机性可能是难以接受的存在，而Nyströmformer则不存在这种随机性，因此也算是一个亮点。

### Nyström方法 [\#](https://kexue.fm/archives/8180\#Nystr%C3%B6m%E6%96%B9%E6%B3%95)

可能有些读者还是想学习一下Nyström方法，这里稍微补充一下。要理解Nyström方法，需要先简单认识一下矩阵的CUR分解。

大家可能都听说过矩阵的SVD分解，格式为$\\boldsymbol{A}=\\boldsymbol{U} \\boldsymbol{\\Lambda} \\boldsymbol{V}^{\\top}$，其中$\\boldsymbol{U},\\boldsymbol{V}$是正交矩阵而$\\boldsymbol{\\Lambda}$是对角矩阵。要注意$\\boldsymbol{U},\\boldsymbol{V}$是正交矩阵意味着它们是稠密的，那么当$\\boldsymbol{A}$很大的时候SVD的计算成本和储存成本都很大（哪怕是做了近似）。现在假设$\\boldsymbol{A}$很大但很稀疏，那么它的SVD分解比原始矩阵还不划算得多得多。为此，CUR分解应运而生，它希望从原矩阵中选择$k$列组成矩阵$\\boldsymbol{C}$、选择$k$行组成矩阵$\\boldsymbol{R}$，并插入一个$k\\times k$的矩阵$\\boldsymbol{U}$，使得

\\begin{equation}\\boldsymbol{A} \\approx \\boldsymbol{C}\\boldsymbol{U}\\boldsymbol{R}\\end{equation}

由于$\\boldsymbol{C},\\boldsymbol{R}$都是原句子的一部分，因此也继承了稀疏性。关于CUR分解，读者还可以参考斯坦福的CS246课程的 [《Dimensionality Reduction》](https://web.stanford.edu/class/cs246/slides/06-dim_red.pdf) 一节。跟SVD不同的是，CUR分解在笔者看来更多的是一种分解思想而不是具体的分解算法，它有不同的实现方式，比如Nyström方法也算是其中一种，分解形式为

\\begin{equation}\\begin{pmatrix}\\boldsymbol{A} & \\boldsymbol{B} \\\ \\boldsymbol{C} & \\boldsymbol{D}\\end{pmatrix} \\approx \\begin{pmatrix}\\boldsymbol{A} & \\boldsymbol{B} \\\ \\boldsymbol{C} & \\boldsymbol{C}\\boldsymbol{A}^{\\dagger}\\boldsymbol{B}\\end{pmatrix} = \\begin{pmatrix}\\boldsymbol{A} \\\ \\boldsymbol{C}\\end{pmatrix} \\boldsymbol{A}^{\\dagger} \\begin{pmatrix}\\boldsymbol{A} & \\boldsymbol{B}\\end{pmatrix}\\end{equation}

其中$\\begin{pmatrix}\\boldsymbol{A} \\\ \\boldsymbol{C}\\end{pmatrix}$和$\\begin{pmatrix}\\boldsymbol{A} & \\boldsymbol{B}\\end{pmatrix}$选出来的列矩阵和行矩阵，这里为了方便描述，假设了经过排列后选出来的行列均排在矩阵前面。Nyströmformer其实也没有直接用Nyström方法（事实上也直接套用不了，原论文有描述），而是借鉴了Nyström方法的分解思想而已。

关于Nyström方法，原论文主要引用的是 [《Improving CUR Matrix Decomposition and the Nyström Approximation via Adaptive Sampling》](https://papers.cool/arxiv/1303.4207)，但并不推荐新手读这篇论文，而推荐读 [《Matrix Compression using the Nystro ̈m Method》](https://papers.cool/arxiv/1305.0203) 和 [《Using the Nyström Method to Speed Up Kernel Machines》](https://www.researchgate.net/publication/49459305_Using_the_Nystroem_Method_to_Speed_Up_Kernel_Machines)。

要特别说明的是，对于CUR分解和Nyström方法，笔者也是新学的，可能有理解不当的地方，请读者自行甄别理解，也欢迎熟悉相关理论的读者交流指正。

## 来一个小结 [\#](https://kexue.fm/archives/8180\#%E6%9D%A5%E4%B8%80%E4%B8%AA%E5%B0%8F%E7%BB%93)

本文介绍了提升Transformer效率的一个新工作Nyströmformer，它借鉴了Nyström方法的思想来构建一个能逼近标准Attention的线性Attention，类似思想的工作还有Performer，两者相比各有自己的优缺点，都是值得学习的工作。本文分享了笔者自己对Nyströmformer的理解，窃认为这种途径更加易懂一些，如有谬误，肯请读者指正。

_**转载到请包括本文地址：** [https://kexue.fm/archives/8180](https://kexue.fm/archives/8180)_

_**更详细的转载事宜请参考：**_ [《科学空间FAQ》](https://kexue.fm/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8)

**如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。**

**如果您觉得本文还不错，欢迎 [分享](https://kexue.fm/archives/8180#share)/ [打赏](https://kexue.fm/archives/8180#pay) 本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！**

打赏

![科学空间](https://kexue.fm/usr/themes/geekg/payment/wx.png)

微信打赏

![科学空间](https://kexue.fm/usr/themes/geekg/payment/zfb.png)

支付宝打赏

因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。

你还可以 [**点击这里**](http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=tN7d1drY3drrx8H0xcWa19vZ) 或在下方评论区留言来告知你的建议或需求。

**如果您需要引用本文，请参考：**

苏剑林. (Feb. 16, 2021). 《Nyströmformer：基于矩阵分解的线性化Attention方案 》\[Blog post\]. Retrieved from [https://kexue.fm/archives/8180](https://kexue.fm/archives/8180)

@online{kexuefm-8180,

        title={Nyströmformer：基于矩阵分解的线性化Attention方案},

        author={苏剑林},

        year={2021},

        month={Feb},

        url={\\url{https://kexue.fm/archives/8180}},

}

分类： [信息时代](https://kexue.fm/category/Big-Data)    标签： [矩阵](https://kexue.fm/tag/%E7%9F%A9%E9%98%B5/), [语言模型](https://kexue.fm/tag/%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/), [attention](https://kexue.fm/tag/attention/)[12 评论](https://kexue.fm/archives/8180#comments)

< [一个二值化词向量模型，是怎么跟果蝇搭上关系的？](https://kexue.fm/archives/8159) \| [【搜出来的文本】⋅（四）通过增、删、改来用词造句](https://kexue.fm/archives/8194) >

### 你也许还对下面的内容感兴趣

- [SVD的导数](https://kexue.fm/archives/10878)
- [Transformer升级之路：19、第二类旋转位置编码](https://kexue.fm/archives/10862)
- [矩阵的有效秩（Effective Rank）](https://kexue.fm/archives/10847)
- [Muon续集：为什么我们选择尝试Muon？](https://kexue.fm/archives/10739)
- [细水长flow之TARFLOW：流模型满血归来？](https://kexue.fm/archives/10667)
- [低秩近似之路（五）：CUR](https://kexue.fm/archives/10662)
- [从谱范数梯度到新式权重衰减的思考](https://kexue.fm/archives/10648)
- [Muon优化器赏析：从向量到矩阵的本质跨越](https://kexue.fm/archives/10592)
- [低秩近似之路（四）：ID](https://kexue.fm/archives/10501)
- [低秩近似之路（三）：CR](https://kexue.fm/archives/10427)

[发表你的看法](https://kexue.fm/archives/8180#comment_form)

zjcanjux

February 17th, 2021

苏神，n2个向量内积，但矩阵乘法每组向量内积完还要加，时间复杂度应该是o（n^3）吧

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=15561#respond-post-8180)

[苏剑林](https://kexue.fm) 发表于
February 19th, 2021

内积是$d$维向量的内积，复杂度只是$\\mathcal{O}(n^2 d)$，而我们一般固定$d$来比较不同序列长度的效率，所以复杂度是$\\mathcal{O}(n^2)$

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=15567#respond-post-8180)

ZZZZZ

February 28th, 2021

“无偶独有” -\> “无独有偶”

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=15633#respond-post-8180)

[苏剑林](https://kexue.fm) 发表于
March 1st, 2021

哈哈哈，谢谢指出，已经修正。

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=15637#respond-post-8180)

true

March 15th, 2021

关于您提到的：

“不过，自适应池化的一个明显缺点是会“糅合”每一个区间的信息，导致它不能防止未来信息泄漏而不能做自回归生成（语言模型或者Seq2Seq的解码器），这基本是任何带有Pooling技术的模型的缺点”

这里应该指的是池化窗口可能包含来自当前位置之后的信息是吧？

如果这样的话，那么池化操作是否可以只计算当前位置之前的信息呢？

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=15770#respond-post-8180)

[苏剑林](https://kexue.fm) 发表于
March 15th, 2021

那就需要每一个token都有自己的池化方式了，那就不是自适应池化了～

或者每个token只attention在它之前的池化结果，但Nyströmformer里边很难，因为$\\tilde{\\boldsymbol{Q}}\\tilde{\\boldsymbol{K}}^{\\top}$这一步好像彻底糅合了，很难解开了。

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=15777#respond-post-8180)

。

April 28th, 2021

原论文更新了，加上了和reformer，linformer，performer的效果对比 - -

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=16257#respond-post-8180)

[苏剑林](https://kexue.fm) 发表于
April 28th, 2021

谢谢告知。

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=16259#respond-post-8180)

[关于Attention 的 秩 和 集中注意力 R11; Lemon00 BLOG](https://blissful-yuexizhang846.wordpress.com/2023/09/26/%e5%85%b3%e4%ba%8eattention-%e7%9a%84%e7%a7%a9-%e5%92%8c-%e9%9b%86%e4%b8%ad/)

September 27th, 2023

\[...\]不管是本文的主角Performer，还是之前在《Nyströmformer：基于矩阵分解的线性化Attention方案》介绍的Nyströmformer，它们的思路都是“寻找一个能逼近标准Attention的线性Attention”。那么一个很自然的问题就是：标准Attention有什么好的？哪里值得大家向它对齐？\[...\]

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=22811#respond-post-8180)

mly

March 24th, 2025

苏神，$Q,K$的大小为$n×d$，那$Q$和$K^T$一共不是有$2n$个向量吗？为什么说$QK^T$是$n^2$个向量的内积？

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=27239#respond-post-8180)

[苏剑林](https://kexue.fm) 发表于
March 30th, 2025

$\\bolsymbol{Q}\\bolsymbol{K}^{\\top}$是$n\\times d$矩阵乘以$d\\times n$矩阵，结果是$n\\times n$矩阵，每个元素对应一对$d$维向量的内积。

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=27271#respond-post-8180)

gaoxl

March 26th, 2025

[@mly\|comment-27239](https://kexue.fm/archives/8180/comment-page-1#comment-27239)

这里说的n^2个向量的内积，指的是n个向量和另外n个向量做内积，共有n^2次的内积操作

[回复评论](https://kexue.fm/archives/8180/comment-page-1?replyTo=27251#respond-post-8180)

[取消回复](https://kexue.fm/archives/8180#respond-post-8180)

你的大名

电子邮箱

个人网站（选填）

1\. 可以使用LaTeX代码，点击“预览效果”可查看效果；

2\. 可以通过点击评论楼层编号来引用该楼层；

3\. 网站可能会有点卡，如非确认评论失败，请不要重复点击提交。

### 内容速览

[简单的回顾](https://kexue.fm/archives/8180#%E7%AE%80%E5%8D%95%E7%9A%84%E5%9B%9E%E9%A1%BE)
[标准Attention](https://kexue.fm/archives/8180#%E6%A0%87%E5%87%86Attention)
[线性Attention](https://kexue.fm/archives/8180#%E7%BA%BF%E6%80%A7Attention)
[Performer](https://kexue.fm/archives/8180#Performer)
[Nyströmformer](https://kexue.fm/archives/8180#Nystr%C3%B6mformer)
[双重Softmax](https://kexue.fm/archives/8180#%E5%8F%8C%E9%87%8DSoftmax)
[向标准靠近](https://kexue.fm/archives/8180#%E5%90%91%E6%A0%87%E5%87%86%E9%9D%A0%E8%BF%91)
[迭代求逆阵](https://kexue.fm/archives/8180#%E8%BF%AD%E4%BB%A3%E6%B1%82%E9%80%86%E9%98%B5)
[池化当聚类](https://kexue.fm/archives/8180#%E6%B1%A0%E5%8C%96%E5%BD%93%E8%81%9A%E7%B1%BB)
[实验与分析](https://kexue.fm/archives/8180#%E5%AE%9E%E9%AA%8C%E4%B8%8E%E5%88%86%E6%9E%90)
[性能与效果](https://kexue.fm/archives/8180#%E6%80%A7%E8%83%BD%E4%B8%8E%E6%95%88%E6%9E%9C)
[个人的思考](https://kexue.fm/archives/8180#%E4%B8%AA%E4%BA%BA%E7%9A%84%E6%80%9D%E8%80%83)
[Nyström方法](https://kexue.fm/archives/8180#Nystr%C3%B6m%E6%96%B9%E6%B3%95)
[来一个小结](https://kexue.fm/archives/8180#%E6%9D%A5%E4%B8%80%E4%B8%AA%E5%B0%8F%E7%BB%93)

### 智能搜索

支持整句搜索！网站自动使用 [结巴分词](https://github.com/fxsjy/jieba) 进行分词，并结合ngrams排序算法给出合理的搜索结果。

### 热门标签

[生成模型](https://kexue.fm/tag/%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/) [attention](https://kexue.fm/tag/attention/) [模型](https://kexue.fm/tag/%E6%A8%A1%E5%9E%8B/) [语言模型](https://kexue.fm/tag/%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/) [优化](https://kexue.fm/tag/%E4%BC%98%E5%8C%96/) [网站](https://kexue.fm/tag/%E7%BD%91%E7%AB%99/) [概率](https://kexue.fm/tag/%E6%A6%82%E7%8E%87/) [梯度](https://kexue.fm/tag/%E6%A2%AF%E5%BA%A6/) [转载](https://kexue.fm/tag/%E8%BD%AC%E8%BD%BD/) [微分方程](https://kexue.fm/tag/%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B/) [天象](https://kexue.fm/tag/%E5%A4%A9%E8%B1%A1/) [矩阵](https://kexue.fm/tag/%E7%9F%A9%E9%98%B5/) [深度学习](https://kexue.fm/tag/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/) [分析](https://kexue.fm/tag/%E5%88%86%E6%9E%90/) [积分](https://kexue.fm/tag/%E7%A7%AF%E5%88%86/) [python](https://kexue.fm/tag/python/) [力学](https://kexue.fm/tag/%E5%8A%9B%E5%AD%A6/) [无监督](https://kexue.fm/tag/%E6%97%A0%E7%9B%91%E7%9D%A3/) [几何](https://kexue.fm/tag/%E5%87%A0%E4%BD%95/) [优化器](https://kexue.fm/tag/%E4%BC%98%E5%8C%96%E5%99%A8/) [扩散](https://kexue.fm/tag/%E6%89%A9%E6%95%A3/) [节日](https://kexue.fm/tag/%E8%8A%82%E6%97%A5/) [生活](https://kexue.fm/tag/%E7%94%9F%E6%B4%BB/) [文本生成](https://kexue.fm/tag/%E6%96%87%E6%9C%AC%E7%94%9F%E6%88%90/) [数论](https://kexue.fm/tag/%E6%95%B0%E8%AE%BA/)

### 随机文章

- [《教材如何写》:BoJone的粗浅看法](https://kexue.fm/archives/1329)
- [正项级数敛散性最有力的判别法？](https://kexue.fm/archives/1990)
- [Nyströmformer：基于矩阵分解的线性化Attention方案](https://kexue.fm/archives/8180)
- [Transformer升级之路：14、当HWFA遇见ReRoPE](https://kexue.fm/archives/9731)
- [bert4keras在手，baseline我有：CLUE基准代码](https://kexue.fm/archives/8739)
- [行列式的导数](https://kexue.fm/archives/2383)
- [澳大利亚网站请您向外星人问好](https://kexue.fm/archives/77)
- [《向量》系列——2.曲率半径](https://kexue.fm/archives/714)
- [生成扩散模型漫谈（四）：DDIM = 高观点DDPM](https://kexue.fm/archives/9181)
- [也来扯几句“全国青少年科技创新大赛”](https://kexue.fm/archives/7611)

### 最近评论

- [韩老魔](https://kexue.fm/archives/10699/comment-page-3#comment-27505): "上式最优解显然就是让模长∥vi∥最小的n−k个γi等于1，这又等价于说挑出模长最大的k
个向...
- [WhateverOk](https://kexue.fm/archives/8397/comment-page-2#comment-27504): 苏神，请教一下，2维的RoPe是否也具有远程衰减性质呢？即靠近的像素衰减小，远离的像素衰减大
- [长琴](https://kexue.fm/archives/10862/comment-page-1#comment-27503): mla出来之后就知道苏神一定会念念不忘。hah。没注意到公众号不更了，才发现……我说咋好久不见...
- [Suahi](https://kexue.fm/archives/5239/comment-page-3#comment-27502): 谢谢苏老师的回复！
我也是在从MLE出发推导VAE的Loss函数这个过程中产生了这些疑问，所以...
- [lay](https://kexue.fm/archives/10657/comment-page-1#comment-27500): 苏神，我在训练一个1.5B模型的过程中在某一步grad\_norm会有很大的spike(比如好几...
- [hazdzz](https://kexue.fm/archives/10862/comment-page-1#comment-27499): 如果 RoPE 结合 Givens rotation method 的变体，Transform...
- [autumn23333](https://kexue.fm/archives/10862/comment-page-1#comment-27498): 请问一下论文附带的代码是不是写错了fourier\_sin = F. pad ( input =...
- [SunlightZero](https://kexue.fm/archives/9164/comment-page-4#comment-27497): 在《Step-by-Step Diffusion: An Elementary Tutoria...
- [苏剑林](https://kexue.fm/archives/5239/comment-page-3#comment-27496): 1、明白了，我将$q\_{\\phi}(z\|x)$看成$q\_{\\phi}(x\|z)$了（ELBO厌...
- [Suahi](https://kexue.fm/archives/5239/comment-page-3#comment-27493): 谢谢苏老师的回复！1\. 首先回复您为什么ELBO不带KL，并不是最终损失函数形式，需要做如下变...

### 友情链接

- [Cool Papers](https://papers.cool)
- [数学研发](https://bbs.emath.ac.cn)
- [Seatop](http://www.seatop.com.cn/)
- [Xiaoxia](https://xiaoxia.org/)
- [积分表-网络版](https://kexue.fm/sci/integral/index.html)
- [丝路博傲](http://blog.dvxj.com/)
- [ph4ntasy 饭特稀](http://www.ph4ntasy.com/)
- [数学之家](http://www.2math.cn/)
- [有趣天文奇观](http://interesting-sky.china-vo.org/)
- [TwistedW](http://www.twistedwg.com/)
- [godweiyang](https://godweiyang.com/)
- [AI柠檬](https://blog.ailemon.net/)
- [王登科-DK博客](https://greatdk.com)
- [ESON](https://blog.eson.org/)
- [枫之羽](https://fzhiy.net/)
- [Mathor's blog](https://wmathor.com/)
- [coding-zuo](https://coding-zuo.github.io/)
- [博科园](https://www.bokeyuan.net/)
- [孔皮皮的博客](https://www.kppkkp.top/)
- [运鹏的博客](https://yunpengtai.top/)
- [jiming.site](https://jiming.site/)
- [OmegaXYZ](https://www.omegaxyz.com/)
- [Blog by Eacls](https://www.eacls.top/)
- [EAI猩球](https://www.robotech.ink/)
- [文举的博客](https://liwenju0.com/)
- [申请链接](https://kexue.fm/links.html)

[![署名-非商业用途-保持一致](https://kexue.fm/usr/themes/geekg/images/cc.gif)](http://creativecommons.org/licenses/by-nc-nd/2.5/cn/) 本站采用创作共用版权协议，要求署名、非商业用途和保持一致。转载本站内容必须也遵循“ [署名-非商业用途-保持一致](http://creativecommons.org/licenses/by-nc-nd/2.5/cn/)”的创作共用协议。

© 2009-2025 Scientific Spaces. All rights reserved. Theme by [laogui](http://www.laogui.com). Powered by [Typecho](http://typecho.org). 备案号: [粤ICP备09093259号-1/2](https://beian.miit.gov.cn/)。