## SEARCH

## MENU

- [打赏](https://kexue.fm/reward.html)
- [公式](https://kexue.fm/latex.html)
- [天象](https://kexue.fm/ac.html)
- [链接](https://kexue.fm/links.html)
- [时光](https://kexue.fm/me.html)
- [博览](https://kexue.fm/science.html)
- [归档](https://kexue.fm/content.html)

## CATEGORIES

- [千奇百怪](https://kexue.fm/category/Everything)
- [天文探索](https://kexue.fm/category/Astronomy)
- [数学研究](https://kexue.fm/category/Mathematics)
- [物理化学](https://kexue.fm/category/Phy-chem)
- [信息时代](https://kexue.fm/category/Big-Data)
- [生物自然](https://kexue.fm/category/Biology)
- [图片摄影](https://kexue.fm/category/Photograph)
- [问题百科](https://kexue.fm/category/Questions)
- [生活/情感](https://kexue.fm/category/Life-Feeling)
- [资源共享](https://kexue.fm/category/Resources)

## NEWPOSTS

- [线性注意力简史：从模仿、创新到反哺](https://kexue.fm/archives/11033)
- [msign的导数](https://kexue.fm/archives/11025)
- [通过msign来计算mclip（奇...](https://kexue.fm/archives/11006)
- [msign算子的Newton-Sc...](https://kexue.fm/archives/10996)
- [等值振荡定理：最优多项式逼近的充要条件](https://kexue.fm/archives/10972)
- [生成扩散模型漫谈（三十）：从瞬时速...](https://kexue.fm/archives/10958)
- [MoE环游记：5、均匀分布的反思](https://kexue.fm/archives/10945)
- [msign算子的Newton-Sc...](https://kexue.fm/archives/10922)
- [Transformer升级之路：2...](https://kexue.fm/archives/10907)
- [一道概率不等式：盯着它到显然成立为止！](https://kexue.fm/archives/10902)

## COMMENTS

- [mona: 苏神，想请教一下，关于“推理阶段可以事先预估Routed Ex...](https://kexue.fm/archives/10945/comment-page-1#comment-27957)
- [mona: 苏神，想请教一下，关于“推理阶段可以事先预估Routed Ex...](https://kexue.fm/archives/10945/comment-page-1#comment-27956)
- [石子131: 也许可以尝试把热水管的回水管的开关阀做成用户的手动阀，在热水管...](https://kexue.fm/archives/9405/comment-page-2#comment-27955)
- [Kuo: 我的理解，这是一个迭代过程，注意下标K是指condition还...](https://kexue.fm/archives/10795/comment-page-1#comment-27954)
- [musicfish1973: 好的设计都是相似的,haha](https://kexue.fm/archives/8009/comment-page-1#comment-27953)
- [忍者猫: 这优化器的作者真的应该给你打钱](https://kexue.fm/archives/10592/comment-page-2#comment-27952)
- [Chaofa Yuan: 写得太好了](https://kexue.fm/archives/11033/comment-page-1#comment-27951)
- [Skyler Lin: respect苏神！](https://kexue.fm/archives/11033/comment-page-1#comment-27949)
- [宋佳铭: 对，个人感觉mean flow就是continuous tim...](https://kexue.fm/archives/10958/comment-page-1#comment-27947)
- [宋佳铭: 的确，对sg这个事情我感觉如果是用‘归纳’法做是不太能避免的，...](https://kexue.fm/archives/10958/comment-page-1#comment-27946)

## USERLOGIN

- [登录](https://kexue.fm/admin/login.php)

[科学空间\|Scientific Spaces](https://kexue.fm)

- [登录](https://kexue.fm/admin/login.php)
- [打赏](https://kexue.fm/reward.html)
- [公式](https://kexue.fm/latex.html)
- [天象](https://kexue.fm/ac.html)
- [链接](https://kexue.fm/links.html)
- [时光](https://kexue.fm/me.html)
- [博览](https://kexue.fm/science.html)
- [归档](https://kexue.fm/content.html)

渴望成为一个小飞侠

- [欢迎订阅](https://kexue.fm/feed)
- [个性邮箱](https://kexue.fm/archives/119)
- [天象信息](https://kexue.fm/ac.html)
- [观测ISS](https://kexue.fm/archives/41)
- [LaTeX](https://kexue.fm/latex.html)
- [关于博主](https://kexue.fm/me.html)

欢迎访问“科学空间”，这里将与您共同探讨自然科学，回味人生百态；也期待大家的分享～

- [**千奇百怪** Everything](https://kexue.fm/category/Everything)
- [**天文探索** Astronomy](https://kexue.fm/category/Astronomy)
- [**数学研究** Mathematics](https://kexue.fm/category/Mathematics)
- [**物理化学** Phy-chem](https://kexue.fm/category/Phy-chem)
- [**信息时代** Big-Data](https://kexue.fm/category/Big-Data)
- [**生物自然** Biology](https://kexue.fm/category/Biology)
- [**图片摄影** Photograph](https://kexue.fm/category/Photograph)
- [**问题百科** Questions](https://kexue.fm/category/Questions)
- [**生活/情感** Life-Feeling](https://kexue.fm/category/Life-Feeling)
- [**资源共享** Resources](https://kexue.fm/category/Resources)

- [**千奇百怪**](https://kexue.fm/category/Everything)
- [**天文探索**](https://kexue.fm/category/Astronomy)
- [**数学研究**](https://kexue.fm/category/Mathematics)
- [**物理化学**](https://kexue.fm/category/Phy-chem)
- [**信息时代**](https://kexue.fm/category/Big-Data)
- [**生物自然**](https://kexue.fm/category/Biology)
- [**图片摄影**](https://kexue.fm/category/Photograph)
- [**问题百科**](https://kexue.fm/category/Questions)
- [**生活/情感**](https://kexue.fm/category/Life-Feeling)
- [**资源共享**](https://kexue.fm/category/Resources)

[首页](https://kexue.fm) [数学研究](https://kexue.fm/category/Mathematics) msign算子的Newton-Schulz迭代（下）

5Jun

# [msign算子的Newton-Schulz迭代（下）](https://kexue.fm/archives/10996)

By 苏剑林 \|
2025-06-05 \|
6406位读者\|

在上文 [《msign算子的Newton-Schulz迭代（上）》](https://kexue.fm/archives/10922) 中，我们试图为$\\mathop{\\text{msign}}$算子寻找更好的Newton-Schulz迭代，以期在有限迭代步数内能达到尽可能高的近似程度，这一过程又可以转化为标量函数$\\mathop{\\text{sign}}(x)$寻找同样形式的多项式迭代。当时，我们的求解思路是用Adam优化器端到端地求一个局部最优解，虽然有效但稍显粗暴。

而在几天前，arXiv新出了一篇论文 [《The Polar Express: Optimal Matrix Sign Methods and Their Application to the Muon Algorithm》](https://papers.cool/arxiv/2505.16932)，作者运用了一系列精妙的数学结论，以优雅且硬核的方式给出了更漂亮的答案。本文让我们一起欣赏和学习一番这篇精彩的论文。

## 问题描述 [\#](https://kexue.fm/archives/10996\#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0)

相关背景和转化过程我们就不再重复了，直接给出我们要求解的问题是
\\begin{equation}\\mathop{\\text{argmin}}\_f d(f(x),1)\\end{equation}
其中$f = f\_T \\circ \\dots \\circ f\_2 \\circ f\_1$，$\\circ$代表函数的复合，$f\_t(x)$是关于$x$的奇多项式（只包含$x$的奇数次幂），而$d(f(x),1)$是衡量函数$f(x)$与$1$距离的某个指标。上一篇文章中，我们是在$\[0,1\]$内均匀选有限个点，取最大的$k$个$\|f(x)-1\|$的平均值作为指标。本文则直接取区间内的$\|f(x)-1\|$最大值作为指标，即
\\begin{equation}\\mathop{\\text{argmin}}\_f \\max\_{x\\in\[l,u\]} \|f(x) - 1\| \\label{eq:opt}\\end{equation}
其中$\[l,u\]\\subset \[0,1\]$。要注意，此时$u$可以直接取1，但$l$不能取0，因为$f(0)$始终是0，这意味着上式始终大于等于1，无法收敛，所以$l$只能选一个很接近于0的数。按照上一篇文章的分析，为了普适性，我们应该要照顾到$0.001$大小的奇异值，因此可以考虑$l=0.001$。

在开始分析之前，我们先简单解释一下论文标题中“Polar”一词的含义，它其实代表了矩阵的“极分解（Polar Decomposition）”：

> **极分解（Polar Decomposition）** 对于一个方阵$\\boldsymbol{M}\\in\\mathbb{R}^{n\\times n}$，它的极分解为$\\boldsymbol{M}=\\boldsymbol{Q}\\boldsymbol{S}$，其中$\\boldsymbol{Q}$是一个正交矩阵，而$\\boldsymbol{S}$是一个半正定矩阵。

而如果$\\boldsymbol{M}$的SVD为$\\boldsymbol{U}\\boldsymbol{\\Sigma}\\boldsymbol{V}^{\\top}$，那么正好有
\\begin{equation}\\boldsymbol{M} = \\boldsymbol{U}\\boldsymbol{\\Sigma}\\boldsymbol{V}^{\\top} = (\\boldsymbol{U}\\boldsymbol{V}^{\\top})(\\boldsymbol{V}\\boldsymbol{\\Sigma}\\boldsymbol{V}^{\\top})\\end{equation}
即$\\boldsymbol{Q}=\\boldsymbol{U}\\boldsymbol{V}^{\\top},\\boldsymbol{S}=\\boldsymbol{V}\\boldsymbol{\\Sigma}\\boldsymbol{V}^{\\top}$就是极分解的一个答案。而我们知道，当$\\boldsymbol{M}$是满秩矩阵时，$\\boldsymbol{U}\\boldsymbol{V}^{\\top}$正好是$\\mathop{\\text{msgin}}(\\boldsymbol{M})$。这也就是为什么$\\mathop{\\text{msgin}}$会跟“Polar”联系起来了，因为求出它之后就可以得到矩阵的“Polar Decomposition”，换言之极分解的本质难度就是计算$\\mathop{\\text{msgin}}$，这跟Muon异曲同工。

## 贪心即可 [\#](https://kexue.fm/archives/10996\#%E8%B4%AA%E5%BF%83%E5%8D%B3%E5%8F%AF)

言归正传。对于问题$\\eqref{eq:opt}$，原论文得出的第一个结论，也应该是全论文最核心的结论是： **它的贪心解正好是它的全局最优解！** 用公式来说，它是指问题$\\eqref{eq:opt}$的求解，可以转化为：
\\begin{equation}\\begin{gathered}
f^\* = f\_T^\* \\circ \\dots \\circ f\_2^\* \\circ f\_1^\* \\\\[12pt\]
f\_1^\* = \\mathop{\\text{argmin}}\_{f\_1} \\max\_{x\\in\[l\_1,u\_1\]} \|f\_1(x) - 1\| \\\
f\_2^\* = \\mathop{\\text{argmin}}\_{f\_2} \\max\_{x\\in\[l\_2,u\_2\]} \|f\_2(x) - 1\| \\\
\\vdots \\\
f\_T^\* = \\mathop{\\text{argmin}}\_{f\_T} \\max\_{x\\in\[l\_T,u\_T\]} \|f\_T(x) - 1\| \\\\[24pt\]
l\_1 = l,\\quad u\_1 = u, \\\\[8pt\]
l\_{t+1} = \\min\_{x\\in\[l\_t,u\_t\]} f\_t^\*(x),\\quad u\_{t+1} = \\max\_{x\\in\[l\_t,u\_t\]} f\_t^\*(x)
\\end{gathered}\\end{equation}

这个结论我相信会出乎不少读者意料，笔者首次看到时也是相当惊讶，并为之拍案叫绝。它不仅大大降低了求解难度，将原本$T$步的复合函数求解，转化为$T=1$的单个多项式逐步求解，还允许我们将解逐步往前推，并一直保持最优性（即$T+1$步的最优解，只需要在$T$步最优解基础上多算一步，而不用从头计算）。

值得指出的是，这个结论是允许每个$f\_t$取不同阶的（这里的“阶”指多项式最高次数），比如$f\_1$可以是3阶的，$f\_2$可以是5阶的，等等，但“贪心解正好是全局最优解”的结论依然不变。不过简单起见，下面我们还是让所有$f\_t$都保持同阶，并且主要考虑3阶和5阶的结果。

上述结论的完整证明略微有点复杂，我们把它放到最后，先完成基于该结论的后续操作。

## 等值振荡 [\#](https://kexue.fm/archives/10996\#%E7%AD%89%E5%80%BC%E6%8C%AF%E8%8D%A1)

既然我们已经把原问题转化为求贪心解，那么现在只需要专注于求解
\\begin{equation}\\mathop{\\text{argmin}}\_{f\_t} \\max\_{x\\in\[l\_t,u\_t\]} \|f\_t(x) - 1\| \\label{eq:local}\\end{equation}
为了求解上式，我们需要先了解在 [《等值振荡定理：最优多项式逼近的充要条件》](https://kexue.fm/archives/10972) 介绍的关于奇多项式的“等值振荡定理（Equioscillation Theorem）”：

> **等值振荡定理-奇** 设$f(x)$是不超过$2n+1$阶的奇多项式，$g(x)$是区间$\[a,b\]\\subset (0,\\infty)$上的连续函数，那么
> \\begin{equation}f^\* = \\mathop{\\text{argmin}}\_f \\max\_{x\\in\[a,b\]} \|f(x) - g(x)\|\\end{equation}
> 的充要条件是存在$a\\leq x\_0 < x\_1 < \\cdots < x\_{n+1} \\leq b$以及$\\sigma\\in\\{0,1\\}$，使得
> \\begin{equation}f^\*(x\_k) - g(x\_k) = (-1)^{k+\\sigma} \\max\_{x\\in\[a,b\]} \|f^\*(x) - g(x)\|\\end{equation}

现在我们要求的是$f\_t$，目标$g$则是恒等于1，等值振荡定理告诉我们$\|f\_t^\*(x)-1\|$在$\[l\_t,u\_t\]$至少$n+2$次达到最大误差（记为$\\mathcal{E}$）。不难发现，$\|f\_t^\*(x)-1\|$的最大值点只能是边界点或者是$f\_t^\*(x)$的极值点，而一个$2n+1$阶奇多项式在$(0,\\infty)$至多有$n$个极值点，所以为了“凑”够$n+2$个，我们“不得已”要把边界点补上，这就确定了$x\_0 = l\_t, x\_{n+1}=u\_t$，而$x\_1,\\cdots,x\_n$则是$\\frac{d}{dx}f\_t^\*(x)$的零点。

此外，由于目标函数是$1$，所以$f\_t^\*(x)$在$x=0$处的斜率大于零，所以$l\_t$只能是$f\_t^\*(x)$的最小值点，因此$\\sigma=1$。综合这些结果，这样我们实际上要解方程组：
\\begin{equation}f\_t(l\_t) = 1 - \\mathcal{E}, \\quad f\_t(u\_t) = 1 + (-1)^n \\mathcal{E},\\quad f\_t(x\_k) = 1 + (-1)^{i+1}\\mathcal{E}, \\quad f\_t'(x\_i) = 0\\end{equation}
其中$i=1,2,3,\\cdots,n$。可以发现方程和未知数都是$2n+2$个，再补上$l\_t < x\_1 < \\cdots < x\_n < u\_t$和$\\mathcal{E} > 0$的约束条件，理论上可以把解确定下来。

## 解方程组 [\#](https://kexue.fm/archives/10996\#%E8%A7%A3%E6%96%B9%E7%A8%8B%E7%BB%84)

对于3阶奇多项式（$n=1$），原论文给出了解析解，而对于5阶奇多项式（$n=2$），原论文给出的是一个迭代求解算法，即先固定$x\_1,x\_2$求$a,b,c$，然后固定$f\_t(x)$的$a,b,c$求$x\_1,x\_2$，反复迭代，这本质上是 [Remez算法](https://en.wikipedia.org/wiki/Remez_algorithm) 的一个简化版。

不过，原论文的迭代依赖于求根公式来求$x\_1,x\_2$，这对于更大的$n$就不大容易操作了。所以这里笔者改变一下求解思路，先以$x\_1,x\_2,\\cdots,x\_n$来参数化$f\_t'(x\_i)$，即定义
\\begin{equation}f\_t'(x) = k(x^2-x\_1^2)(x^2-x\_2^2)\\cdots (x^2-x\_n^2)\\end{equation}
然后有$f\_t(x) = \\int\_0^x f\_t'(x) dx$，这样我们就用$k$和$x\_1,x\_2,\\cdots,x\_n$表示出了$f\_t(x)$，继而只需求解方程组
\\begin{equation}f\_t(l\_t) = 1 - \\mathcal{E}, \\quad f\_t(u\_t) = 1 + (-1)^n \\mathcal{E},\\quad f\_t(x\_i) = 1 + (-1)^{i+1}\\mathcal{E}\\end{equation}
而避免了解方程$f\_t'(x) = 0$。当$n=1$时，我们可以解得
\\begin{equation}x\_1 = \\sqrt{\\frac{l\_t^2+l\_t u\_t + u\_t^2}{3}},\\quad k = -\\frac{6}{l\_t^2 u\_t + l\_t u\_t^2 + 2x\_1^3}\\end{equation}
当$n > 1$时，我们可以直接交给Mathematica，例如$n=2$时：

```
df[x_] = k*(x^2 - x1^2) (x^2 - x2^2);
f[x_] = Integrate[df[x], {x, 0, x}];
sol = NSolve[{f[l] == 1 - e, f[x1] == 1 + e, f[x2] == 1 - e,
 f[u] == 1 + e, l < x1 < x2 < u, e > 0} /. {l -> 0.001,
 u -> 1}, {k, x1, x2, e}, Reals]
f[x] /. sol
```

## 有限精度 [\#](https://kexue.fm/archives/10996\#%E6%9C%89%E9%99%90%E7%B2%BE%E5%BA%A6)

至此，我们似乎已经完成了原始问题的求解？理论上是的，但仅限于无限精度。实际计算时是有限精度的，尤其是Muon优化器用的是bfloat16，精度损失更严重，所以就带来了一些问题。

第一个问题，是每一个$f\_t^\*$理论上只对区间$\[l\_t,u\_t\]$负责，但有限精度下奇异值可能会偏离该区间。当$n$是偶数时（即$f\_t^\*$是5、9、...阶奇多项式），超出$u\_t$就存在发散风险，因为此时的$f\_t^\*(x)$在$x > u\_t$时是单调递增到正无穷的，稍有不慎就会随着迭代而发散。解决办法有两个，一是求$f\_t^\*$时把$\[l\_t,u\_t\]$预留得稍微宽松一些，二是保持区间不变，但求得$f\_t^\*$后输入要多除一个大于1的数。原论文用的是后者，把$f\_t^\*(x)$改为$f\_t^\*(x / 1.01)$。

第二个问题比较隐晦，我们用具体例子来介绍。设$n=2,l\_1=0.001,u\_1=1$，可以求得$f\_1^\*$是
\\begin{equation}f\_1^\*(x) = 8.4703 x - 25.1081 x^3 + 18.6293 x^5\\end{equation}
其中$x\_1 = 0.3674, x\_2 = 0.8208, \\mathcal{E}=0.9915$。这个解有什么问题呢？根据等值振荡定理，我们知道$f\_1^\*(x\_2) = 1-\\mathcal{E} = 0.0085$，即它会把$0.8208$映射成$0.0085$。然而，我们的最终目标是将$(0,1\]$的所有数都变成1，所以$f\_1^\*$会将一个已经很接近目标的$0.8208$映射到非常远离目标的$0.0085$。尽管后面$f\_2^\*,f\_3^\*,\\cdots$理论上会逐渐把它拉回来，但在有限精度下反复将一个数缩小又放大，累积误差是很可观的。

当然，由等值振荡定理可知，这种振荡行为是无法避免的，我们只能寄望于最大误差$\\mathcal{E}$不要太接近于1，从而减缓这种累积误差。不难看出，区间$\[l\_t,u\_t\]$越大，理论上就越难拟合，最大误差$\\mathcal{E}$将会越近于1，所以论文引入了一个超参数$\\lambda \\in (0, 1)$，将优化区间从$\[l\_t,u\_t\]$改为$\[\\max(l\_t, \\lambda u\_t),u\_t\]$，通过限制区间大小来保证$\\mathcal{E}$不会太大。（需要提醒读者的是，论文在正文讲解中用的$\\lambda$是$0.1$，但附录代码实际用的$\\lambda$是$0.024$。）

但这样一来，原本的$l\_t$，尤其是我们一开始设置的$l$，不就容易被忽略了？为了解决这个问题，论文引入了“Recenter”技巧，即如果优化区间是$\[l\_t,u\_t\]$，那么将会满足$f\_t^\*(l\_t) + f\_t^\*(u\_t) = 2$，而优化区间改为$\[\\max(l\_t, \\lambda u\_t),u\_t\]$后就不一定满足了，这时候我们给$f\_t^\*$乘上$\\gamma$，使得它满足这个等式
\\begin{equation}\\gamma f\_t^\*(l\_t) + \\gamma f\_t^\*(u\_t) = 2\\qquad \\Rightarrow \\qquad \\gamma = \\frac{2}{f\_t^\*(l\_t) + f\_t^\*(u\_t)}\\end{equation}
这就把原本$l\_t$考虑进去了。

## 参考代码 [\#](https://kexue.fm/archives/10996\#%E5%8F%82%E8%80%83%E4%BB%A3%E7%A0%81)

这是$n=2$时的Mathematica完整代码：

```
df[x_] = k*(x^2 - x1^2) (x^2 - x2^2);
f[x_] = Integrate[df[x], {x, 0, x}];
sol[l_, u_] :=
 NSolve[{f[l] == 1 - e, f[x1] == 1 + e, f[x2] == 1 - e, f[u] == 1 + e,
 l < x1 < x2 < u, e > 0, k > 0}, {k, x1, x2, e}]
ff[x_, l_, u_] = f[x]*2/(f[l] + f[u]) // Expand;
lt = 0.001; ut = 1; lambda = 0.02407327424182761;
While[1 - lt > 0.0001,
 fff[x_] = ff[x, lt, ut] /. sol[Max[lt, lambda*ut], ut][[1]];
 Print[fff[x]];
 lt = fff[lt]; ut = 2 - lt]

```

结果如下（$f\_t(x) = a\_t x + b\_t x^3 + c\_t x^5$）：
\\begin{array}{c\|ccc}
\\hline
t & a\\times 1.01 & b\\times 1.01^3 & c\\times 1.01^5 \\\
\\hline
\\quad 1\\quad & 8.28721 & -23.5959 & 17.3004 \\\
2 & 4.10706 & -2.94785 & 0.544843 \\\
3 & 3.94869 & -2.9089 & 0.551819 \\\
4 & 3.31842 & -2.48849 & 0.510049 \\\
5 & 2.30065 & -1.6689 & 0.418807 \\\
6 & 1.8913 & 1.268 & 0.376804 \\\
7 & 1.875 & -1.25 & 0.375 \\\
8 & 1.875 & -1.25 & 0.375 \\\
\\hline
\\end{array}

注意这里给出的是还没有做$f\_t^\*(x / 1.01)$处理的结果，所以实际的$a, b, c$还要在该表基础上多除以$1.01$的$1,3,5$次方。没有直接给出除以$1.01$之后的结果，是因为除以$1.01$前的收敛值$1.875, -1.25, 0.375$（$t \\geq 7$）显得更简洁明了，便于观察和欣赏。

作者附录的代码整理如下：

```
import numpy as np

def optimal_quintic(l, u):
 assert 0 <= l <= u
 if 1 - 5e-6 <= l / u:
 # Above this threshold, the equoscillating polynomials
 # is numerically equal to...
 return (15 / 8) / u, (-10 / 8) / (u**3), (3 / 8) / (u**5)
 # This initialization becomes exact as l -> u
 q = (3 * l + 1) / 4
 r = (l + 3) / 4
 E, old_E = np.inf, None
 while not old_E or abs(old_E - E) > 1e-15:
 old_E = E
 LHS = np.array([
 [l, l**3, l**5, 1],
 [q, q**3, q**5, -1],
 [r, r**3, r**5, 1],
 [u, u**3, u**5, -1],
 ])
 a, b, c, E = np.linalg.solve(LHS, np.ones(4))
 q, r = np.sqrt(
 (-3 * b + np.array([-1, 1]) * np.sqrt(9 * b**2 - 20 * a * c)) /
 (10 * c)
 )
 return float(a), float(b), float(c)

def optimal_composition(l, num_iters, cushion=0.02407327424182761):
 u = 1
 coefficients = []
 for _ in range(num_iters):
 a, b, c = optimal_quintic(max(l, cushion * u), u)
 # Due to cushioning , this may be centered around 1 with
 # respect to 0.024*u, u. Recenter it around 1 with respect
 # to l, u, meaning find c so that 1 - c*p(l) = c*p(u) - 1:
 pl = a * l + b * l**3 + c * l**5
 pu = a * u + b * u**3 + c * u**5
 rescalar = 2 / (pl + pu)
 a *= rescalar
 b *= rescalar
 c *= rescalar
 # Optionally incorporate safety factor here :
 # a /= 1.01; b /= 1.01**3; c /= 1.01**5
 coefficients.append((a, b, c))
 l = a * l + b * l**3 + c * l**5
 u = 2 - l
 return coefficients

print(*optimal_composition(1e-3, 10), sep="\n")
```

## 完成证明 [\#](https://kexue.fm/archives/10996\#%E5%AE%8C%E6%88%90%E8%AF%81%E6%98%8E)

最后一节，我们来补上“贪心解正好是它的全局最优解”的证明。

根据等值振荡定理，我们知道$f\_t^\*$的值域是$\[l\_{t+1},u\_{t+1}\]$，其中$l\_{t+1}=f\_t^\*(l\_t),u\_{t+1}=2-l\_{t+1}$，由此可知$T$步贪心解的最大误差是$\\mathcal{E}\_T = 1 - l\_{T+1} = 1 - f\_T^\*(l\_T)$，我们只需要证明$T$步全局最优解的最大误差也只能降到$1 - f\_T^\*(l\_T)$，就可以得到“贪心解正好是它的全局最优解”这个结论。

证明的思路是数学归纳法。假设结论对于$t=1,2,\\cdots,T-1$成立，那么$\\hat{f} = f\_{T-1}^\*\\circ \\cdots \\circ f\_2^\* \\circ f\_1^\*$就是$T-1$步的全局最优解，值域为$\[l\_T, u\_T\]$，最大误差为$\\mathcal{E}\_{T-1}=1-l\_T=u\_T-1$。另一方面，设$\\tilde{f} = \\tilde{f}\_{T-1}\\circ \\cdots \\circ \\tilde{f}\_2 \\circ \\tilde{f}\_1$为任意一个$T-1$步解，值域为$\[a,b\]$，令$c = \\frac{2}{a+b}$，那么$c\\tilde{f}$的值域则是$\[ca,cb\]$，显然$ca\\leq 1, cb\\geq 1$。根据归纳假设，我们有
\\begin{equation}\\begin{aligned}
1 - ca \\geq \\mathcal{E}\_{T-1} \\\
cb - 1 \\geq \\mathcal{E}\_{T-1}
\\end{aligned}\\qquad\\Rightarrow\\qquad \\frac{a}{b} \\leq \\frac{1 - \\mathcal{E}\_{T-1}}{1 + \\mathcal{E}\_{T-1}} = \\frac{l\_T}{u\_T} \\end{equation}
即任意一个$T-1$步解的值域的相对大小，都不小于$T-1$步最优解的值域$\[l\_T, u\_T\]$的相对大小。接着我们有
\\begin{equation}\\begin{aligned}
\\min\_{f\_T} \\max\_{x\\in\[l,u\]} \|f\_T(\\tilde{f}(x)) - 1\| =&\\, \\min\_{f\_T} \\max\_{x\\in\[a,b\]} \|f\_T(x) - 1\| \\\
=&\\, \\min\_{f\_T} \\max\_{x\\in\[a/b,1\]} \|f\_T(x) - 1\| \\\
\\geq &\\, \\min\_{f\_T} \\max\_{x\\in\[l\_T/u\_T,1\]} \|f\_T(x) - 1\| \\\
=&\\, \\min\_{f\_T} \\max\_{x\\in\[l\_T,u\_T\]} \|f\_T(x) - 1\| \\\
=&\\, \\mathcal{E}\_T
\\end{aligned}\\end{equation}
也就是说，你随便拿一个别的$T-1$步解来，最大误差也顶多只能跟贪心解一样小，所以贪心解的最大误差已经是全局最优的，这就完成了递归证明。上式的关键一步是
\\begin{equation}\\min\_{f\_T} \\max\_{x\\in\[a,b\]} \|f\_T(x) - 1\| = \\min\_{f\_T} \\max\_{x\\in\[a/b,1\]} \|f\_T(x) - 1\|\\end{equation}
这是因为我们总可以设$g\_T(y) = f\_T(b y)$，$g\_T$依然能代表任意同阶的奇多项式，所以$g\_T$和$f\_T$都在同一函数空间中，因此记号可以换用，即
\\begin{equation}\\min\_{f\_T}\\max\_{x\\in\[a,b\]} \|f\_T(x) - 1\| = \\min\_{g\_T}\\max\_{y\\in\[a/b,1\]} \|g\_T(y) - 1\|= \\min\_{f\_T}\\max\_{x\\in\[a/b,1\]} \|f\_T(x) - 1\|\\end{equation}

## 文章小结 [\#](https://kexue.fm/archives/10996\#%E6%96%87%E7%AB%A0%E5%B0%8F%E7%BB%93)

本文介绍了为msign算子寻找更好的Newton-Schulz迭代的最新进展，它通过等值振荡定理和贪心转换，直接求出理论上的最优解，整个过程相当硬核，值得学习一波。

_**转载到请包括本文地址：** [https://kexue.fm/archives/10996](https://kexue.fm/archives/10996)_

_**更详细的转载事宜请参考：**_ [《科学空间FAQ》](https://kexue.fm/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8)

**如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。**

**如果您觉得本文还不错，欢迎 [分享](https://kexue.fm/archives/10996#share)/ [打赏](https://kexue.fm/archives/10996#pay) 本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！**

打赏

微信打赏

支付宝打赏

因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以 [**点击这里**](http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=tN7d1drY3drrx8H0xcWa19vZ) 或在下方评论区留言来告知你的建议或需求。

**如果您需要引用本文，请参考：**

苏剑林. (Jun. 05, 2025). 《msign算子的Newton-Schulz迭代（下） 》\[Blog post\]. Retrieved from [https://kexue.fm/archives/10996](https://kexue.fm/archives/10996)

@online{kexuefm-10996,
        title={msign算子的Newton-Schulz迭代（下）},
        author={苏剑林},
        year={2025},
        month={Jun},
        url={\\url{https://kexue.fm/archives/10996}},
}

分类： [数学研究](https://kexue.fm/category/Mathematics)    标签： [迭代](https://kexue.fm/tag/%E8%BF%AD%E4%BB%A3/), [近似](https://kexue.fm/tag/%E8%BF%91%E4%BC%BC/), [优化器](https://kexue.fm/tag/%E4%BC%98%E5%8C%96%E5%99%A8/), [muon](https://kexue.fm/tag/muon/)[7 评论](https://kexue.fm/archives/10996#comments)

< [等值振荡定理：最优多项式逼近的充要条件](https://kexue.fm/archives/10972) \| [通过msign来计算mclip（奇异值裁剪）](https://kexue.fm/archives/11006) >

### 你也许还对下面的内容感兴趣

- [msign的导数](https://kexue.fm/archives/11025)
- [通过msign来计算mclip（奇异值裁剪）](https://kexue.fm/archives/11006)
- [等值振荡定理：最优多项式逼近的充要条件](https://kexue.fm/archives/10972)
- [msign算子的Newton-Schulz迭代（上）](https://kexue.fm/archives/10922)
- [高阶muP：更简明但更高明的谱条件缩放](https://kexue.fm/archives/10795)
- [初探muP：超参数的跨模型尺度迁移规律](https://kexue.fm/archives/10770)
- [Muon续集：为什么我们选择尝试Muon？](https://kexue.fm/archives/10739)
- [低秩近似之路（五）：CUR](https://kexue.fm/archives/10662)
- [为什么梯度裁剪的默认模长是1？](https://kexue.fm/archives/10657)
- [从谱范数梯度到新式权重衰减的思考](https://kexue.fm/archives/10648)

[发表你的看法](https://kexue.fm/archives/10996#comment_form)

PengchengMa

June 6th, 2025

牛啊

[回复评论](https://kexue.fm/archives/10996/comment-page-1?replyTo=27811#respond-post-10996)

Kai Liu

June 13th, 2025

此外，由于目标函数是1，所以$f^∗\_t(x）$在 $x$ 处的斜率大于零，所以$l\_t$ 只能是$f^∗\_t(x)$的最小值点.
此处不太理解，可否详细一点？多谢！

[回复评论](https://kexue.fm/archives/10996/comment-page-1?replyTo=27866#respond-post-10996)

[苏剑林](https://kexue.fm) 发表于
June 13th, 2025

写漏了，是$f^∗\_t(x)$在 $x=0$ 处的斜率大于零，如果$l\_t$是最大值点，那么它左边是增的，右边是减的，就只能占用一个$f^∗\_t(x)$的极值点（驻点）名额了，可是如果边界点都占用了一个极值点名额的话，那么就凑不够$n+2$个最大值点了。

[回复评论](https://kexue.fm/archives/10996/comment-page-1?replyTo=27876#respond-post-10996)

Kai Liu 发表于
June 13th, 2025

针对$n=2$情况，有没有可能在$l\_t$处是最大值$1+\\epsilon$ ($\\epsilon\\ge0$)，各个$x\_k$ (where $k=1,2$) 依次是$1-\\epsilon$，$1+\\epsilon$ 最后在$u\_t$处是最小值$1-\\epsilon$?似乎也是可以的？

[回复评论](https://kexue.fm/archives/10996/comment-page-1?replyTo=27882#respond-post-10996)

[苏剑林](https://kexue.fm) 发表于
June 13th, 2025

如果$l\_t$处是最大值，那么$l\_t$右侧就是下降对吧？但$x=0$处是单调递增的，这意味着$l\_t$左侧要不已经出现了一个极大值点，要不然$l\_t$本身就是一个极大值点，不管是哪种情况，都需要“占用”掉一个极值点名额，导致凑不够$n+2$个误差最大的点。

关键：对于光滑函数来说，单调递增和递减之间，必然有一个极大值点。

[回复评论](https://kexue.fm/archives/10996/comment-page-1?replyTo=27883#respond-post-10996)

Kai Liu 发表于
June 13th, 2025

我可能错过了最重要的点，为啥在x=0处是单调递增的？

[回复评论](https://kexue.fm/archives/10996/comment-page-1?replyTo=27884#respond-post-10996)

[苏剑林](https://kexue.fm) 发表于
June 13th, 2025

我们的目标是1，$f^∗\_t(0)=0$，如果$x=0$处还单调递减，而$x=l\_t$处大于零，那么不就表明$(0,l\_t)$区间有一个极小值点，这同样要占去一个极值名额。

[回复评论](https://kexue.fm/archives/10996/comment-page-1?replyTo=27886#respond-post-10996)

[取消回复](https://kexue.fm/archives/10996#respond-post-10996)

你的大名

电子邮箱

个人网站（选填）

1\. 可以使用LaTeX代码，点击“预览效果”可查看效果；2. 可以通过点击评论楼层编号来引用该楼层；3. 网站可能会有点卡，如非确认评论失败，请 **不要重复点击提交**。

### 内容速览

[问题描述](https://kexue.fm/archives/10996#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0)
[贪心即可](https://kexue.fm/archives/10996#%E8%B4%AA%E5%BF%83%E5%8D%B3%E5%8F%AF)
[等值振荡](https://kexue.fm/archives/10996#%E7%AD%89%E5%80%BC%E6%8C%AF%E8%8D%A1)
[解方程组](https://kexue.fm/archives/10996#%E8%A7%A3%E6%96%B9%E7%A8%8B%E7%BB%84)
[有限精度](https://kexue.fm/archives/10996#%E6%9C%89%E9%99%90%E7%B2%BE%E5%BA%A6)
[参考代码](https://kexue.fm/archives/10996#%E5%8F%82%E8%80%83%E4%BB%A3%E7%A0%81)
[完成证明](https://kexue.fm/archives/10996#%E5%AE%8C%E6%88%90%E8%AF%81%E6%98%8E)
[文章小结](https://kexue.fm/archives/10996#%E6%96%87%E7%AB%A0%E5%B0%8F%E7%BB%93)

### 智能搜索

支持整句搜索！网站自动使用 [结巴分词](https://github.com/fxsjy/jieba) 进行分词，并结合ngrams排序算法给出合理的搜索结果。

### 热门标签

[生成模型](https://kexue.fm/tag/%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/) [attention](https://kexue.fm/tag/attention/) [优化](https://kexue.fm/tag/%E4%BC%98%E5%8C%96/) [语言模型](https://kexue.fm/tag/%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/) [模型](https://kexue.fm/tag/%E6%A8%A1%E5%9E%8B/) [网站](https://kexue.fm/tag/%E7%BD%91%E7%AB%99/) [概率](https://kexue.fm/tag/%E6%A6%82%E7%8E%87/) [梯度](https://kexue.fm/tag/%E6%A2%AF%E5%BA%A6/) [转载](https://kexue.fm/tag/%E8%BD%AC%E8%BD%BD/) [微分方程](https://kexue.fm/tag/%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B/) [矩阵](https://kexue.fm/tag/%E7%9F%A9%E9%98%B5/) [天象](https://kexue.fm/tag/%E5%A4%A9%E8%B1%A1/) [分析](https://kexue.fm/tag/%E5%88%86%E6%9E%90/) [深度学习](https://kexue.fm/tag/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/) [积分](https://kexue.fm/tag/%E7%A7%AF%E5%88%86/) [python](https://kexue.fm/tag/python/) [优化器](https://kexue.fm/tag/%E4%BC%98%E5%8C%96%E5%99%A8/) [力学](https://kexue.fm/tag/%E5%8A%9B%E5%AD%A6/) [无监督](https://kexue.fm/tag/%E6%97%A0%E7%9B%91%E7%9D%A3/) [扩散](https://kexue.fm/tag/%E6%89%A9%E6%95%A3/) [几何](https://kexue.fm/tag/%E5%87%A0%E4%BD%95/) [节日](https://kexue.fm/tag/%E8%8A%82%E6%97%A5/) [生活](https://kexue.fm/tag/%E7%94%9F%E6%B4%BB/) [文本生成](https://kexue.fm/tag/%E6%96%87%E6%9C%AC%E7%94%9F%E6%88%90/) [数论](https://kexue.fm/tag/%E6%95%B0%E8%AE%BA/)

### 随机文章

- [2011年全国高中数学联赛](https://kexue.fm/archives/1488)
- [从费马大定理谈起（六）：n=4（2）](https://kexue.fm/archives/2858)
- [三角函数幂的积分](https://kexue.fm/archives/1422)
- [日食记](https://kexue.fm/archives/7515)
- [输入梯度惩罚与参数梯度惩罚的一个不等式](https://kexue.fm/archives/8796)
- [欢迎注册@spaces.ac.cn的邮箱(更新!)](https://kexue.fm/archives/119)
- [科学空间今日访问量](https://kexue.fm/archives/928)
- [VQ一下Key，Transformer的复杂度就变成线性了](https://kexue.fm/archives/9844)
- [你的语言模型有没有“无法预测的词”？](https://kexue.fm/archives/9046)
- [非对抗式生成模型GLANN的简单介绍](https://kexue.fm/archives/6394)

### 最近评论

- [mona](https://kexue.fm/archives/10945/comment-page-1#comment-27957): 苏神，想请教一下，关于“推理阶段可以事先预估Routed Expert的实际分布，只要细致地进...
- [mona](https://kexue.fm/archives/10945/comment-page-1#comment-27956): 苏神，想请教一下，关于“推理阶段可以事先预估Routed Expert的实际分布，只要细致地进...
- [石子131](https://kexue.fm/archives/9405/comment-page-2#comment-27955): 也许可以尝试把热水管的回水管的开关阀做成用户的手动阀，在热水管临近回水管、手动阀靠近热水管侧加...
- [Kuo](https://kexue.fm/archives/10795/comment-page-1#comment-27954): 我的理解，这是一个迭代过程，注意下标K是指condition还是desideratum
- [musicfish1973](https://kexue.fm/archives/8009/comment-page-1#comment-27953): 好的设计都是相似的,haha
- [忍者猫](https://kexue.fm/archives/10592/comment-page-2#comment-27952): 这优化器的作者真的应该给你打钱
- [Chaofa Yuan](https://kexue.fm/archives/11033/comment-page-1#comment-27951): 写得太好了
- [Skyler Lin](https://kexue.fm/archives/11033/comment-page-1#comment-27949): respect苏神！
- [宋佳铭](https://kexue.fm/archives/10958/comment-page-1#comment-27947): 对，个人感觉mean flow就是continuous time CTM
- [宋佳铭](https://kexue.fm/archives/10958/comment-page-1#comment-27946): 的确，对sg这个事情我感觉如果是用‘归纳’法做是不太能避免的，因为毕竟是用步长短的模型去约束步...

### 友情链接

- [Cool Papers](https://papers.cool)
- [数学研发](https://bbs.emath.ac.cn)
- [Seatop](http://www.seatop.com.cn/)
- [Xiaoxia](https://xiaoxia.org/)
- [积分表-网络版](https://kexue.fm/sci/integral/index.html)
- [丝路博傲](http://blog.dvxj.com/)
- [ph4ntasy 饭特稀](http://www.ph4ntasy.com/)
- [数学之家](http://www.2math.cn/)
- [有趣天文奇观](http://interesting-sky.china-vo.org/)
- [TwistedW](http://www.twistedwg.com/)
- [godweiyang](https://godweiyang.com/)
- [AI柠檬](https://blog.ailemon.net/)
- [王登科-DK博客](https://greatdk.com)
- [ESON](https://blog.eson.org/)
- [枫之羽](https://fzhiy.net/)
- [Mathor's blog](https://wmathor.com/)
- [coding-zuo](https://coding-zuo.github.io/)
- [博科园](https://www.bokeyuan.net/)
- [孔皮皮的博客](https://www.kppkkp.top/)
- [运鹏的博客](https://yunpengtai.top/)
- [jiming.site](https://jiming.site/)
- [OmegaXYZ](https://www.omegaxyz.com/)
- [Blog by Eacls](https://www.eacls.top/)
- [EAI猩球](https://www.robotech.ink/)
- [文举的博客](https://liwenju0.com/)
- [用代码打点酱油](https://bruceyuan.com/)
- [申请链接](https://kexue.fm/links.html)

本站采用创作共用版权协议，要求署名、非商业用途和保持一致。转载本站内容必须也遵循“ [署名-非商业用途-保持一致](http://creativecommons.org/licenses/by-nc-nd/2.5/cn/)”的创作共用协议。
© 2009-2025 Scientific Spaces. All rights reserved. Theme by [laogui](http://www.laogui.com). Powered by [Typecho](http://typecho.org). 备案号: [粤ICP备09093259号-1/2](https://beian.miit.gov.cn/)。