## SEARCH

## MENU

- [打赏](https://kexue.fm/reward.html)
- [公式](https://kexue.fm/latex.html)
- [天象](https://kexue.fm/ac.html)
- [链接](https://kexue.fm/links.html)
- [时光](https://kexue.fm/me.html)
- [博览](https://kexue.fm/science.html)
- [归档](https://kexue.fm/content.html)

## CATEGORIES

- [千奇百怪](https://kexue.fm/category/Everything)
- [天文探索](https://kexue.fm/category/Astronomy)
- [数学研究](https://kexue.fm/category/Mathematics)
- [物理化学](https://kexue.fm/category/Phy-chem)
- [信息时代](https://kexue.fm/category/Big-Data)
- [生物自然](https://kexue.fm/category/Biology)
- [图片摄影](https://kexue.fm/category/Photograph)
- [问题百科](https://kexue.fm/category/Questions)
- [生活/情感](https://kexue.fm/category/Life-Feeling)
- [资源共享](https://kexue.fm/category/Resources)

## NEWPOSTS

- [通过msign来计算奇异值裁剪mc...](https://kexue.fm/archives/11059)
- [矩阵符号函数mcsgn能计算什么？](https://kexue.fm/archives/11056)
- [线性注意力简史：从模仿、创新到反哺](https://kexue.fm/archives/11033)
- [msign的导数](https://kexue.fm/archives/11025)
- [通过msign来计算奇异值裁剪mc...](https://kexue.fm/archives/11006)
- [msign算子的Newton-Sc...](https://kexue.fm/archives/10996)
- [等值振荡定理：最优多项式逼近的充要条件](https://kexue.fm/archives/10972)
- [生成扩散模型漫谈（三十）：从瞬时速...](https://kexue.fm/archives/10958)
- [MoE环游记：5、均匀分布的反思](https://kexue.fm/archives/10945)
- [msign算子的Newton-Sc...](https://kexue.fm/archives/10922)

## COMMENTS

- [abcm: 公式(14)为什么是直接带入，我的理解是0到T积分再换元\
\\b...](https://kexue.fm/archives/10114/comment-page-3#comment-28017)
- [Truenobility303: 苏神好，关于RMS对齐这里有些疑问。1. 如果从 A Spec...](https://kexue.fm/archives/10739/comment-page-2#comment-28016)
- [wolfzdf: 您好，请问cool paper中收集的会议论文，有保存整理文章...](https://kexue.fm/archives/9907/comment-page-4#comment-27987)
- [无敌大铁锤: 嗯嗯笔误了，就是去掉Causal的mask，变成一个纯Self...](https://kexue.fm/archives/11033/comment-page-1#comment-27986)
- [HikaruNight: 苏老师，想请教一下如果把四元数放在三维RoPE里面是不是可行的](https://kexue.fm/archives/8397/comment-page-3#comment-27985)
- [Leco: 请问LoRA的A,B矩阵初始化时，一个高斯随机一个全零还是只能...](https://kexue.fm/archives/9590/comment-page-2#comment-27984)
- [苏剑林: 如果你把你这里提到的数学都学通透了，数学基础基本上可以胜任95...](https://kexue.fm/archives/9119/comment-page-13#comment-27983)
- [苏剑林: 我跑过这个项目，效果是能复现的。“在 CIFAR-10 上效果...](https://kexue.fm/archives/10958/comment-page-2#comment-27982)
- [Henry Zha: 苏神你好，我是一名管理科学与工程专业的博士生，研究方向是结合人...](https://kexue.fm/archives/9119/comment-page-13#comment-27981)
- [SunlightZero: 我根据 https://github.com/haidog-y...](https://kexue.fm/archives/10958/comment-page-2#comment-27980)

## USERLOGIN

- [登录](https://kexue.fm/admin/login.php)

[科学空间\|Scientific Spaces](https://kexue.fm)

- [登录](https://kexue.fm/admin/login.php)
- [打赏](https://kexue.fm/reward.html)
- [公式](https://kexue.fm/latex.html)
- [天象](https://kexue.fm/ac.html)
- [链接](https://kexue.fm/links.html)
- [时光](https://kexue.fm/me.html)
- [博览](https://kexue.fm/science.html)
- [归档](https://kexue.fm/content.html)

渴望成为一个小飞侠

- [欢迎订阅](https://kexue.fm/feed)
- [个性邮箱](https://kexue.fm/archives/119)
- [天象信息](https://kexue.fm/ac.html)
- [观测ISS](https://kexue.fm/archives/41)
- [LaTeX](https://kexue.fm/latex.html)
- [关于博主](https://kexue.fm/me.html)

欢迎访问“科学空间”，这里将与您共同探讨自然科学，回味人生百态；也期待大家的分享～

- [**千奇百怪** Everything](https://kexue.fm/category/Everything)
- [**天文探索** Astronomy](https://kexue.fm/category/Astronomy)
- [**数学研究** Mathematics](https://kexue.fm/category/Mathematics)
- [**物理化学** Phy-chem](https://kexue.fm/category/Phy-chem)
- [**信息时代** Big-Data](https://kexue.fm/category/Big-Data)
- [**生物自然** Biology](https://kexue.fm/category/Biology)
- [**图片摄影** Photograph](https://kexue.fm/category/Photograph)
- [**问题百科** Questions](https://kexue.fm/category/Questions)
- [**生活/情感** Life-Feeling](https://kexue.fm/category/Life-Feeling)
- [**资源共享** Resources](https://kexue.fm/category/Resources)

- [**千奇百怪**](https://kexue.fm/category/Everything)
- [**天文探索**](https://kexue.fm/category/Astronomy)
- [**数学研究**](https://kexue.fm/category/Mathematics)
- [**物理化学**](https://kexue.fm/category/Phy-chem)
- [**信息时代**](https://kexue.fm/category/Big-Data)
- [**生物自然**](https://kexue.fm/category/Biology)
- [**图片摄影**](https://kexue.fm/category/Photograph)
- [**问题百科**](https://kexue.fm/category/Questions)
- [**生活/情感**](https://kexue.fm/category/Life-Feeling)
- [**资源共享**](https://kexue.fm/category/Resources)

[首页](https://kexue.fm) [数学研究](https://kexue.fm/category/Mathematics) 重温SSM（三）：HiPPO的高效计算（S4）

20Jun

# [重温SSM（三）：HiPPO的高效计算（S4）](https://kexue.fm/archives/10162)

By 苏剑林 \|
2024-06-20 \|
42686位读者\|

前面我们用两篇文章 [《重温SSM（一）：线性系统和HiPPO矩阵》](https://kexue.fm/archives/10114) 和 [《重温SSM（二）：HiPPO的一些遗留问题》](https://kexue.fm/archives/10137) 介绍了HiPPO的思想和推导——通过正交函数基对持续更新的函数进行实时逼近，其拟合系数的动力学正好可以表示为一个线性ODE系统，并且对于特定的基底以及逼近方式，我们可以将线性系统的关键矩阵精确地算出来。此外，我们还讨论了HiPPO的离散化和相关性质等问题，这些内容奠定了后续的SSM工作的理论基础。

接下来，我们将介绍HiPPO的后续应用篇 [《Efficiently Modeling Long Sequences with Structured State Spaces》](https://papers.cool/arxiv/2111.00396)（简称S4），它利用HiPPO的推导结果作为序列建模的基本工具，并从新的视角探讨了高效的计算和训练方式，最后在不少长序列建模任务上验证了它的有效性，可谓SSM乃至RNN复兴的代表作之一。

## 基本框架 [\#](https://kexue.fm/archives/10162\#%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6)

S4使用的序列建模框架，是如下的线性ODE系统：
\\begin{equation}\\begin{aligned}
x'(t) =&\\, A x(t) + B u(t) \\\
y(t) =&\\, C^\* x(t) + D u(t)
\\end{aligned}\\end{equation}
这里$u,y,D\\in\\mathbb{R};x\\in\\mathbb{R}^d;A\\in\\mathbb{R}^{d\\times d};B,C\\in\\mathbb{R}^{d\\times 1}$，${}^\*$是转置共轭运算，如果是实矩阵的话，那就是单纯的转置。由于完整的模型通常还会带有残差结构，最后一项$D u(t)$可以整合到残差里边，所以我们可以直接假设$D=0$来稍微简化一下形式，但不会降低模型的能力。

该系统具备 **相似不变性**，如果$\\tilde{A}$是$A$的相似矩阵，即$A = P^{-1}\\tilde{A}P$，那么代入整理得
\\begin{equation}\\begin{aligned}
Px'(t) =&\\, \\tilde{A} Px(t) + PB u(t) \\\
y(t) =&\\, ((P^{-1})^\* C)^\* P x(t)
\\end{aligned}\\end{equation}
将$Px(t)$视为一个整体替换原来的$x(t)$，那么新系统的变化是$(A,B,C)\\to(\\tilde{A},PB,(P^{-1})^\*C)$，但输出完全不改变。这意味着如果存在$A$的某个相似矩阵$\\tilde{A}$使得计算更加简单，那么可以完全转到$\\tilde{A}$中分析而不改变结果，这就是后面一系列分析的核心思路。

特别地，S4将矩阵$A$选取为HiPPO-LegS矩阵，即
\\begin{equation}A\_{n,k} = -\\left\\{\\begin{array}{l}\\sqrt{(2n+1)(2k+1)}, &k < n \\\ n+1, &k = n \\\
0, &k > n\\end{array}\\right.\\end{equation}
这个选择的特别之处在于，我们此前推导LegS所满足的ODE是$x'(t) =\\frac{A}{t} x(t) + \\frac{B}{t} u(t)$的形式，而LegT的ODE才是$x'(t) = A x(t) + B u(t)$的形式，所以现在就是说LegT的ODE搭配了LegS的$A$矩阵，因此首先要问的问题是：这样的组合会带来什么影响呢？比如它对历史的记忆是否跟LegS一样依然是完整的、平权的？

## 指数衰减 [\#](https://kexue.fm/archives/10162\#%E6%8C%87%E6%95%B0%E8%A1%B0%E5%87%8F)

答案是否定的——S4所选取的ODE系统，关于历史的记忆是指数衰减的，我们可以从两个角度理解这一点。

第一个角度是从 [《重温SSM（二）：HiPPO的一些遗留问题》](https://kexue.fm/archives/10137) 讨论过的变换出发，将LegS型ODE可以等价地写成：
\\begin{equation}Ax(t) + Bu(t) = t x'(t) = \\frac{d}{d\\ln t} x(t)\\end{equation}
所以设$\\tau=\\ln t$就可以将LegS型ODE变成时间变量为$\\tau$的LegT型ODE，也就是S4所用的ODE。我们知道，LegS会平等对待每一处历史，但这前提是输入为$u(t)=u(e^{\\tau})$，但S4的ODE相当于输入直接改为$u(\\tau)$，此时对$\\tau$做均匀离散化的话，结果就是每一处的权重不相等——假设$t\\in\[0,T\]$，用概率密度的写法就是$dt/T=\\rho(\\tau)d\\tau$，即$\\rho(\\tau)=e^{\\tau}/T$，即权重是$\\tau$的指数函数，越新的历史权重越大。

第二个角度则需要多一点线性代数知识。同样在 [《重温SSM（二）：HiPPO的一些遗留问题》](https://kexue.fm/archives/10137) 我们说过HiPPO-LegS的矩阵$A$理论上是可以对角化的，并且其特征值为$\[-1,-2,-3,\\cdots\]$，于是存在可逆矩阵$P$使得$A = P^{-1}\\Lambda P$，其中$\\Lambda = \\text{diag}(-1,-2,\\cdots,-d)$，根据相似不变性，原系统等价于新系统
\\begin{equation}\\begin{aligned}
x'(t) =&\\, \\Lambda x(t) + PB u(t) \\\
y(t) =&\\, C^\* P^{-1} x(t)
\\end{aligned}\\end{equation}
离散化后（以前向欧拉为例）：
\\begin{equation}x(t+\\epsilon) = (I + \\epsilon\\Lambda) Px(t) + \\epsilon P B u(t)\\end{equation}
这里的$I + \\epsilon\\Lambda$是每个分量都小于1的对角线矩阵，也就意味着每迭代一步，就将历史信息乘以一个小于1的数，多步叠加后，就呈现出指数衰减的效应。

## 离散格式 [\#](https://kexue.fm/archives/10162\#%E7%A6%BB%E6%95%A3%E6%A0%BC%E5%BC%8F)

虽然指数衰减看上去没有LegS平等对待每一处历史那么优雅，但实际上没有免费的午餐，对于固定大小的记忆状态$x(t)$，在记忆区间越来越大时，LegS平等对待每一处历史的做法反而会导致每一处历史都比较模糊，对于符合“近大远小”的场景反而得不偿失。此外，S4型ODE右端没有显式地出现时间$t$，这也有助于提供训练效率。

对S4型ODE的记忆性质心中有数之后，我们就可以着手下一步操作了。为了处理实际中的离散序列，我们首先要进行离散化，在上一篇文章中，我们给出了两种精度较高的离散格式，一种是双线性形式
\\begin{equation}x\_{k+1} = (I - \\epsilon A/2)^{-1}\[(I + \\epsilon A/2) x\_k + \\epsilon B u\_k\] \\end{equation}
它具有二阶的精度，S4采用的就是这个离散化格式，也是本文接下来所探讨的格式。另一种是基于精确求解常输入的ODE，得到
\\begin{equation}x\_{k+1} = e^{\\epsilon A} x\_k + A^{-1} (e^{\\epsilon A} - I) B u\_k\\end{equation}
作者后面的作品包括Mamba都是用这个格式，此时一般都要假设$A$为对角矩阵，因为对于LegS的矩阵$A$，矩阵指数算起来并不友好。

现在我们记：
\\begin{equation}\\bar{A}=(I - \\epsilon A/2)^{-1}(I + \\epsilon A/2),\\quad\\bar{B}=\\epsilon(I - \\epsilon A/2)^{-1}B,\\quad\\bar{C}=C\\end{equation}
那么就得到线性RNN：
\\begin{equation}\\begin{aligned}
x\_{k+1} =&\\, \\bar{A} x\_k + \\bar{B} u\_k \\\
y\_{k+1} =&\\, \\bar{C}^\* x\_{k+1} \\\
\\end{aligned}\\label{eq:s4-r}\\end{equation}
其中$\\epsilon > 0$是离散化步长，是人为选择的超参数。

## 卷积运算 [\#](https://kexue.fm/archives/10162\#%E5%8D%B7%E7%A7%AF%E8%BF%90%E7%AE%97)

在上一篇文章中，我们还提到了HiPPO-LegS的矩阵$A$具备计算高效的特点，具体表现为$A$或$\\bar{A}$跟向量$x$相乘，存在计算复杂度为$\\mathcal{O}(d)$而不是一般的$\\mathcal{O}(d^2)$的高效算法，但这仅仅意味着式$\\eqref{eq:s4-r}$递归计算时比一般的RNN高效，而如果想要进行高效训练的话，单纯递归是不够的，需要探究并行计算方法。

线性RNN的并行计算有两种思路：一种是在 [《Google新作试图“复活”RNN：RNN能否再次辉煌？》](https://kexue.fm/archives/9554) 介绍过的视为Prefix Sum问题，直接用Upper/Lower、Odd/Even、Ladner-Fischer等Associative Scan算法进行计算，论文可参考 [《Prefix Sums and Their Applications》](https://www.cs.cmu.edu/~scandal/papers/CMU-CS-90-190.html)；另一种是转化为矩阵序列和向量序列的卷积运算，利用快速傅里叶变换（FFT）来加速，这是S4的思路。但不管哪一种，它们面临共同的瓶颈：幂矩阵$\\bar{A}^k$的计算。

具体来说，我们一般会设初始状态$x\_0$为0，那么就可以写出：
\\begin{equation}\\begin{aligned}
y\_1 =&\\, \\bar{C}^\*\\bar{B}u\_0\\\
y\_2 =&\\, \\bar{C}^\*(\\bar{A}x\_0 + \\bar{B}u\_1) = \\bar{C}^\*\\bar{A}\\bar{B}u\_0 + \\bar{C}^\*\\bar{B}u\_1\\\
y\_3 =&\\, \\bar{C}^\*(\\bar{A}x\_1 + \\bar{B}u\_2) = \\bar{C}^\*\\bar{A}^2 Bu\_0 + \\bar{C}^\*\\bar{A}Bu\_1 + \\bar{C}^\*\\bar{B}u\_2\\\\[5pt\]
\\vdots
\\\
y\_L =&\\, \\bar{C}^\*(\\bar{A} x\_{L-1}+\\bar{B}u\_{L-1}) = \\sum\_{k=0}^{L-1} \\bar{C}^\*\\bar{A}^k \\bar{B}u\_{L-k} = \\bar{K}\_{< L} \* u\_{< L}
\\end{aligned}\\end{equation}
其中$\*$代表卷积运算，而
\\begin{equation}\\bar{K}\_k = \\bar{C}^\*\\bar{A}^k\\bar{B},\\quad \\bar{K}\_{< L} = \\big(\\bar{K}\_0,\\bar{K}\_1,\\cdots,\\bar{K}\_{L-1}\\big),\\quad u\_{< L} = (u\_0,u\_1,\\cdots,u\_{L-1})\\end{equation}
注意根据目前的约定，$\\bar{C}^\*\\bar{A}^k \\bar{B}$和$u\_k$都是标量，所以有$\\bar{K}\_{< L},u\_{< L}\\in\\mathbb{R}^L$。我们知道，卷积运算可以通过（离散）傅立叶变换转换为频域的乘法运算，然后再逆变换回来，它的复杂度为$\\mathcal{O}(L\\log L)$，$L$是序列长度。虽然复杂度看上去比直接递归的$\\mathcal{O}(L)$要大，但是傅立叶变换是可以并行的，所以实际上计算速度要更快。

所以，现在问题是如何高效地计算卷积核$\\bar{K}\_{< L}$，它需要计算幂矩阵$\\bar{A}^k$，按定义计算的话复杂度还是相当大的。当然，如果只是计算$\\bar{A}^k$那倒不是什么问题，因为$A$是一个常数矩阵，给定$\\epsilon$后$\\bar{A}$也是常数矩阵，不管它的幂多难算，都可以提前算好存起来。然而，$\\bar{A}^k$只是中间步骤，我们还要算$\\bar{C}^\*\\bar{A}^k\\bar{B}$，而S4将$\\bar{C},\\bar{B}$视为训练参数，所以$\\bar{C}^\*\\bar{A}^k\\bar{B}$没法提前算好，就是提前算好$\\bar{A}^k$效率还是不大够。

## 生成函数 [\#](https://kexue.fm/archives/10162\#%E7%94%9F%E6%88%90%E5%87%BD%E6%95%B0)

在进一步分析之前，我们先来插入一个生成函数的概念，这是后面的高效计算的基础步骤之一。同时，对于不大了解卷积运算和离散傅立叶变换的读者，这也可以作为一个科普步骤，从中我们可以大致了解到傅立叶变换加速卷积运算的基本原理。

对于给定序列$a = (a\_0,a\_1,a\_2,\\cdots)$，它的生成函数就是将每个分量当成幂级数的系数来构建幂级数：
\\begin{equation}\\mathcal{G}(z\|a) = \\sum\_{k=0}^{\\infty} a\_k z^k\\end{equation}
如果有两个序列$a = (a\_0,a\_1,a\_2,\\cdots)$和$b = (b\_0,b\_1,b\_2,\\cdots)$，那么它们生成函数的乘积：
\\begin{equation}\\mathcal{G}(z\|a)\\mathcal{G}(z\|b) = \\left(\\sum\_{k=0}^{\\infty} a\_k z^k\\right)\\left(\\sum\_{l=0}^{\\infty} b\_l z^l\\right) = \\sum\_{k=0}^{\\infty}\\sum\_{l=0}^{\\infty}a\_k b\_l z^{k+l} = \\sum\_{l=0}^{\\infty}\\left(\\sum\_{k=0}^l a\_k b\_{l-k}\\right) z^l \\end{equation}
留意到了没有？$\\mathcal{G}(z\|a)\\mathcal{G}(z\|b)$的第$l$项系数（即$z^{l-1}$的系数），正好是$a\_{< l}=(a\_0,\\cdots,a\_{l-1})$与$b\_{< l}=(b\_0,\\cdots,b\_{l-1})$的卷积运算。如果我们有快速计算生成函数以及快速提取生成函数某一项系数的方法，那么就可以将卷积运算转换为生成函数，做普通乘法之后然后再提取相应的系数。

[离散傅立叶变换（Discrete Fourier Transform，DFT）](https://en.wikipedia.org/wiki/Discrete_Fourier_transform) 正是这样的一种构建生成函数的思路。首先注意到，如果我们只需要对$a,b$的不超过前$L$项做卷积运算，那么生成函数的求和上限不一定非得到正无穷，求和上限改为$L-1$也是可以的。针对这种需求，DFT没有对所有$z$来计算生成函数，而是选取了特定的$z=e^{-2i\\pi l/L},l=0,1,2,\\dots,L-1$进行计算：
\\begin{equation}\\hat{a}\_l = \\sum\_{k=0}^{L-1} a\_k \\left(e^{-2i\\pi l/L}\\right)^k = \\sum\_{k=0}^{L-1} a\_k e^{-2i\\pi kl/L}\\end{equation}
提取系数的逆变换（Inverse DFT，IDFT）则是
\\begin{equation}a\_k = \\frac{1}{L}\\sum\_{l=0}^{L-1} \\hat{a}\_l e^{2i\\pi kl/L}\\end{equation}
DFT和IDFT我们都可以通过 [快速傅里叶变换（Fast Fourier Transform，FFT）](https://en.wikipedia.org/wiki/Fast_Fourier_transform) 进行高效计算，大部分数值计算框架都已内置了相应函数，所以DFT和IDFT的计算在效率上没有问题。但要注意，如果用DFT来计算卷积的话，需要稍微微调一下，因为$e^{-2i\\pi l/L}$是周期函数，我们没法区分$e^{-2i\\pi l/L}$和$e^{-2i\\pi (l+L)/L}$，而当我们将两个$L$项求和的DFT相乘时，结果会出现$l \\geq L$的$e^{-2i\\pi kl/L}$项，它会跟$e^{-2i\\pi k(l-L)/L}$项混合，从而做IDFT时实则得到的是两项的系数相加，这样作为卷积结果来说是不正确的。

解决这个问题的方法是将$e^{-2i\\pi l/L}$的$L$改为$2L$（但求和还是$L$项求和），也就是增大它的周期，使得乘积结果都是单个周期内，即将DFT的定义改为
\\begin{equation}\\hat{a}\_l = \\sum\_{k=0}^{L-1} a\_k e^{-i\\pi kl/L}\\end{equation}
不过现成的FFT函数基本上都不支持单独调整周期，而是默认周期就是数组长度，所以等价的处理方式是在$(a\_0,a\_1,\\cdots,a\_{L-1})$后面拼接$L$个零再做常规的DFT，得到乘积后做IDFT，最后只取前$L$个结果。

## 从幂到逆 [\#](https://kexue.fm/archives/10162\#%E4%BB%8E%E5%B9%82%E5%88%B0%E9%80%86)

对于卷积核$\\bar{K}$，我们有
\\begin{equation}\\mathcal{G}(z\|\\bar{K}) = \\sum\_{k=0}^{\\infty} \\bar{C}^\*\\bar{A}^k \\bar{B}z^k = \\bar{C}^\*\\left(I - z\\bar{A}\\right)^{-1}\\bar{B}\\label{eq:k-gen}\\end{equation}
可以发现，生成函数不仅可以加速卷积的计算，它还将原本的幂矩阵$\\bar{A}^k$的计算转化为逆矩阵$\\left(I - z\\bar{A}\\right)^{-1}$的计算。

什么样的矩阵$\\bar{A}$，它对应的$\\left(I - z\\bar{A}\\right)^{-1}$比较容易计算呢？首先对角阵肯定没问题，如果$\\bar{A}$是对角阵，那么$I - z\\bar{A}$也是对角阵，对角阵的逆直接将对角线元素都取逆即可。其次，如果$\\bar{A}$可以对角化为$\\bar{\\Lambda}$，即$\\bar{A}=P^{-1}\\bar{\\Lambda} P$，那么$\\left(I - z\\bar{A}\\right)^{-1}$同样容易计算，因为
\\begin{equation}\\left(I - z\\bar{A}\\right)^{-1} = \\left(P^{-1}(I - z\\bar{\\Lambda})P\\right)^{-1} = P^{-1}\\left(I - z\\bar{\\Lambda}\\right)^{-1} P\\end{equation}

那$\\bar{A}$能不能对角化呢？这取决于$A$能不能对角化。如果$A=P^{-1}\\Lambda P$，根据相似不变性，我们可以完全转到$A=\\Lambda$的新系统去计算，而根据定义新的$\\bar{A}$为：
\\begin{equation}\\begin{aligned}
\\bar{A}=&\\,(I - \\epsilon A/2)^{-1}(I + \\epsilon A/2) \\\
=&\\,(I - \\epsilon\\Lambda/2)^{-1}(I + \\epsilon\\Lambda/2)
\\end{aligned}\\end{equation}
显然是一个对角阵。

那么$A$可以对角化吗？答案是理论上可以，实际上不行。理论上可以，是因为从理论上来说，几乎所有矩阵在复数域内都可以对角化，并且在上一篇文章已经给出了LegS的$A$特征值为$\[-1,-2,-3,\\cdots\]$，也就是连对角化后的对角矩阵我们都知道长什么样了。实际上不行，是指对数值计算来说很难，因为数值计算要考虑精度、内存、时间等，只要三者之一超出了限度或容忍度，那么理论可行的算法在实际中就不成立。

对于$A$矩阵，实际上不行的主要原因是对角化$A$所需要的矩阵$P$存在数值不稳定问题，说白了也是计算机精度有限导致的。对于这一点，原论文直接不加解释地给出了矩阵$P$的解析解，然后进行验证，这显然不利于读者理解。下面笔者从特征向量计算的角度，给出另一个理解思路。

## 特征向量 [\#](https://kexue.fm/archives/10162\#%E7%89%B9%E5%BE%81%E5%90%91%E9%87%8F)

$A$的对角化等价于$-A$的对角化，因为$A$的特征值全是负数，所以简单起见我们转而考虑$-A$的对角化，它有$d$个不同的特征值$\\lambda=1,2,\\cdots,d$，对角化它所需的矩阵就是其特征向量的堆叠，所以求$P$本质上是求特征向量。而对于已知特征值的矩阵，求解特征向量的直接方法是求解方程$-Av=\\lambda v$。

上一篇文章中“计算高效”那一节，我们已经给出了$Av$的第$n$个分量的计算结果：
\\begin{equation}(Av)\_n = n v\_n -\\sqrt{2n+1}\\sum\_{k=0}^n \\sqrt{2k+1}v\_k \\end{equation}
所以$-Av=\\lambda v$意味着
\\begin{equation}\\sqrt{2n+1}\\sum\_{k=0}^n \\sqrt{2k+1}v\_k - n v\_n = \\lambda v\_n\\end{equation}
记$S\_n = \\sum\\limits\_{k=0}^n \\sqrt{2k+1}v\_k$，那么$\\sqrt{2n+1}v\_n=S\_n - S\_{n-1}$，稍加整理得
\\begin{equation}S\_{n-1} = \\frac{\\lambda - n - 1}{\\lambda + n}S\_n\\end{equation}
注意$-Av=\\lambda v$是一个不定方程，我们有一些灵活调整的自由度（即特征向量不是唯一的），由于$n$最大是$d-1$，我们可以设$S\_{d-1}=1$，然后递归地往回推，直到$\\lambda - n - 1=0$得到$S\_{\\lambda - 1} = 0$，此后$\\forall n < \\lambda - 1$都有$S\_n = 0$，而对于$n > \\lambda - 1$，则有
\\begin{equation}S\_n = (-1)^{d-n-1}\\frac{(d-\\lambda)! (n+\\lambda)!}{(d+\\lambda-1)! (n-\\lambda + 1)!}\\end{equation}
由于我们是想要证明$P$的数值不稳定性，那么观察一个特征向量即可，我们取$n=\\lambda=d/3$（如果$d$不是3的倍数，简单取个整即可，结论不变），那么
\\begin{equation}\|S\_{d/3}\| = \\frac{\\left(\\frac{2d}{3}\\right)! \\left(\\frac{2d}{3}\\right)!}{\\left(\\frac{4d}{3}-1\\right)!}\\sim \\mathcal{O}(\\sqrt{d}\\,2^{-4d/3})\\end{equation}
最后的$\\sim$可以由 [String公式](https://en.wikipedia.org/wiki/Stirling%27s_approximation) 得到。由该结果我们可以看到，对于$d/3$这个特征值，从$S\_{d-1}$到$S\_{d/3}$存在一个指数级别的衰减过程（反之则爆炸），那么特征向量的分量$v\_{d-1}$到$v\_{d/3}$也存在类似的衰减，在浮点数的有限精度内，是很难精确处理这样的特征向量的。所以，直接对角化$A$的矩阵$P$存在数值上的不稳定性。

## 对角低秩 [\#](https://kexue.fm/archives/10162\#%E5%AF%B9%E8%A7%92%E4%BD%8E%E7%A7%A9)

除了对角阵外，当$\\bar{A}$可以低秩分解时，同样可以降低$\\left(I - z\\bar{A}\\right)^{-1}$的计算难度。这是因为我们有如下的Woodbury恒等式：
\\begin{equation}(I - UV^\*)^{-1} = \\sum\_{k=0}^{\\infty} (UV)^k = I + U\\left(\\sum\_{k=0}^{\\infty}(V^\* U)^k\\right)V = I + U(I - V^\* U)^{-1} V^\*\\end{equation}
这里$U,V\\in\\mathbb{R}^{d\\times r}$，推导过程利用了$(UV^\*)^k = U(V^\* U)^{k-1}V$。如果$d \\gg r$，那么理论上$(I - V^\* U)^{-1}$的计算量就比$(I - UV^\*)^{-1}$少得多，因此可以加速计算。特别地，如果$r=1$，那么$(I - V^\* U)^{-1}$就是一个标量的倒数，计算起来最简单。

然而，我们知道$A$是一个下三角阵，且对角线元素没有一个是零，那么它就一定是满秩矩阵。再结合上一节的结论，也就是说$A$即不低秩，对角化又存在实践上的困难，所以这都不适用，还有什么办法呢？有！利用上面的Woodbury恒等式，我们可以推出它更一般的版本：
\\begin{equation}\\begin{aligned}
(M - UV^\*)^{-1} =&\\, (M(I - (M^{-1}U)V^\*))^{-1} = (I - (M^{-1}U)V^\*)^{-1}M^{-1} \\\
=&\\, (I + M^{-1}U(I - V^\*M^{-1}U)^{-1} V^\*)M^{-1} \\\
=&\\, M^{-1} + M^{-1}U(I - V^\*M^{-1}U)^{-1} V^\*M^{-1} \\\
\\end{aligned}\\end{equation}
这个结果告诉我们，如果$M$的逆比较容易算，那么它加/减一个低秩矩阵的逆也容易算。那什么样的矩阵逆比较容易算呢？又回到上一节的答案——对角矩阵。所以，我们可以想办法将$A$或者$\\bar{A}$往“对角+低秩”的形式上凑。

事实上，仔细观察就会发现，$A$矩阵本身就有“对角+低秩”的影子。在上一篇文章中，我们将$A$的定义等价地改写为：
\\begin{equation}A\_{n,k} = \\left\\{\\begin{array}{l}n\\delta\_{n,k} - \\sqrt{2n+1}\\sqrt{2k+1}, &k \\leq n \\\ 0, &k > n\\end{array}\\right.\\end{equation}
其中$n\\delta\_{n,k}$实质就是对角矩阵$\\text{diag}(0,1,2,\\cdots)$，而$\\sqrt{2n+1}\\sqrt{2k+1}$则可以重写为低秩矩阵形式$v v^\*$，其中$v=\[1,\\sqrt{3},\\sqrt{5},\\cdots\]^\*\\in\\mathbb{R}^{d\\times 1}$，换句话说，如果没有$k > n, A\_{n,k}=0$的规定，那么$A$本身就是对角矩阵减去低秩矩阵的形式了。

## 点睛之笔 [\#](https://kexue.fm/archives/10162\#%E7%82%B9%E7%9D%9B%E4%B9%8B%E7%AC%94)

虽然有了下三角阵的约束后，这个规律就不再适用了，但我们可以充分利用原本就有的$v v^\*$结构，来辅助构建新的可对角化矩阵。但不得不说，这个技巧相当机智，堪称点睛之笔，让人惊叹，再次为原作者点赞。具体来说，我们考虑$A+\\frac{1}{2}v v^\*$：
\\begin{equation}\\left(A + \\frac{1}{2}v v^\*\\right)\_{n,k} = \\left\\{\\begin{array}{l}n\\delta\_{n,k} - \\frac{1}{2}\\sqrt{2n+1}\\sqrt{2k+1}, &k \\leq n \\\ \\frac{1}{2}\\sqrt{2n+1}\\sqrt{2k+1}, &k > n\\end{array}\\right.\\end{equation}
这个新矩阵的对角线元素正好是$-\\frac{1}{2}I$，我们再加上$\\frac{1}{2}I$，就得到
\\begin{equation}\\left(A + \\frac{1}{2}v v^\*+\\frac{1}{2}I\\right)\_{n,k} = \\left\\{\\begin{array}{} - \\frac{1}{2}\\sqrt{2n+1}\\sqrt{2k+1}, &k < n \\\ 0, &k=n \\\ \\frac{1}{2}\\sqrt{2n+1}\\sqrt{2k+1}, &k > n\\end{array}\\right.\\end{equation}
重点来了，可以看到这是一个反对称矩阵，所以它一定可以（在复数域中）对角化！于是我们就将$A$分解为了可对角化矩阵与低秩矩阵之和！可能有读者质疑，原本$A$就一定是可对角化矩阵，但还是有数值稳定性问题，难道这个反对称矩阵的对角化不用担心数值稳定性问题吗？重点的重点来了，反对称矩阵不单单一定可以对角化，它一定可以被正交矩阵（复数域叫做酉矩阵）对角化！酉矩阵一般数值稳定性都非常好，所以不用担心这个问题，这也就是为什么我们不直接对角化$A$，而绕一圈来构建反对称矩阵的原因。

现在我们得到，存在对角矩阵$\\Lambda$和酉矩阵$U$，使得$A + \\frac{1}{2}v v^\*+\\frac{1}{2}I = U^\*\\Lambda U$，从而
\\begin{equation}A = U^\*\\Lambda U - \\frac{1}{2}I - \\frac{1}{2}v v^\* = U^\*\\left(\\Lambda - \\frac{1}{2}I - \\frac{1}{2}(Uv)(Uv)^\*\\right) U\\end{equation}
抛开脚手架，我们发现最终的结论可以简化为“$A$同构于对角阵减去秩1矩阵”：存在酉矩阵$U$、对角矩阵$\\Lambda$、列向量$u,v$，使得：
\\begin{equation}A = U^\*\\left(\\Lambda - uv^\*\\right) U\\end{equation}
注意“对角+低秩”的矩阵乘以向量是计算高效的，比如
\\begin{equation}\\left(\\Lambda - uv^\*\\right)x = \\Lambda x - u(v^\*x)\\end{equation}
$\\Lambda x$相当于将$\\Lambda$当成向量与$x$逐位相乘，而$u(v^\*x)$则是$v$跟$x$先做内积，然后得到一个标量乘以向量$u$，这些都可以在$\\mathcal{O}(d)$内完成。

## 最后冲刺 [\#](https://kexue.fm/archives/10162\#%E6%9C%80%E5%90%8E%E5%86%B2%E5%88%BA)

有了$A=U^\*\\left(\\Lambda - uv^\*\\right) U$，再次根据相似不变性，我们接下来的所有计算都可以转到$A=\\Lambda - uv^\*$中进行，所以下面均设$A=\\Lambda - uv^\*$。首先，对于$\\bar{A}$：
\\begin{equation}\\bar{A}=\\big(I - \\epsilon (\\Lambda - uv^\*)/2\\big)^{-1}\\big(I + \\epsilon (\\Lambda - uv^\*)/2\\big)\\end{equation}
留意到$I - \\epsilon (\\Lambda - uv^\*)/2= \\frac{\\epsilon}{2}(D + uv^\*)$，其中$D=\\frac{2}{\\epsilon}I - \\Lambda$是对角阵，于是利用Woodbury恒等式得到：
\\begin{equation}\\big(I - \\epsilon (\\Lambda - uv^\*)/2\\big)^{-1} =\\frac{2}{\\epsilon}(D + uv^\*)^{-1} = \\frac{2}{\\epsilon}\\left\[D^{-1} - D^{-1}u(I + v^\*D^{-1}u)^{-1} v^\*D^{-1}\\right\]\\end{equation}
仔细观察，这同样是“对角+低秩”的形式，再乘以$\\big(I + \\epsilon (\\Lambda - uv^\*)/2\\big)$后就能完成$\\bar{A}$的计算，最终结果是两个“对角+低秩”矩阵的相乘，意味着它同样具有计算高效的特点，这个结果可以在递归推理中用到。

最后是并行训练所需要的卷积核，我们已经将它转化为生成函数$\\eqref{eq:k-gen}$，现在我们就可以来完成它的计算了。首先通过类似“通分”的操作可以证明：
\\begin{equation}\\begin{aligned}
\\mathcal{G}(z\|\\bar{K}) = \\bar{C}^\* \\left(I - \\bar{A}z\\right)^{-1}\\bar{B} =&\\, \\bar{C}^\* \\left(I - (I - \\epsilon A/2)^{-1}(I + \\epsilon A/2)z\\right)^{-1}\\bar{B} \\\
=&\\, \\bar{C}^\* \\left\[(I - \\epsilon A/2)^{-1}\\big((I - \\epsilon A/2)-(I + \\epsilon A/2)z\\big)\\right\]^{-1}\\bar{B} \\\
=&\\, \\bar{C}^\* \\big\[(I - \\epsilon A/2)-(I + \\epsilon A/2)z\\big\]^{-1}(I - \\epsilon A/2)\\bar{B} \\\
=&\\, \\bar{C}^\* \\big\[(I - \\epsilon A/2)-(I + \\epsilon A/2)z\\big\]^{-1}B\\epsilon \\\
=&\\, \\bar{C}^\* \\big\[(1-z)I - (1+z)\\epsilon A / 2\\big\]^{-1}B\\epsilon \\\
=&\\, \\frac{2}{1+z}\\bar{C}^\* \\left\[\\frac{2}{\\epsilon}\\frac{1-z}{1+z}I - A\\right\]^{-1}B \\\
\\end{aligned}\\end{equation}
于是代入$A=\\Lambda - uv^\*$得到
\\begin{equation}\\mathcal{G}(z\|\\bar{K}) = \\frac{2}{1+z}\\bar{C}^\* \\left\[\\frac{2}{\\epsilon}\\frac{1-z}{1+z}I - (\\Lambda - uv^\*)\\right\]^{-1}B=\\frac{2}{1+z}\\bar{C}^\* (R\_z + uv^\*)^{-1}B\\end{equation}
这里$R\_z = \\frac{2}{\\epsilon}\\frac{1-z}{1+z}I - \\Lambda$是个对角阵，于是再次利用Woodbury恒等式就可以完成计算：
\\begin{equation}\\mathcal{G}(z\|\\bar{K}) = \\frac{2}{1+z}\\bar{C}^\* \\left\[R\_z^{-1} - R\_z^{-1}u(I + v^\*R\_z^{-1}u)^{-1} v^\*R\_z^{-1}\\right\]B\\end{equation}
这是关于$z$的标量函数。不过要注意一个细节，傅立叶变换所需要的实际是“截断生成函数”：
\\begin{equation}\\mathcal{G}\_L(z\|\\bar{K}) = \\sum\_{k=0}^{L-1} \\bar{C}^\*\\bar{A}^k \\bar{B}z^k = \\bar{C}^\*(I - z^L\\bar{A}^L)\\left(I - z\\bar{A}\\right)^{-1}\\bar{B}\\end{equation}
也就相当于$\\mathcal{G}(z\|\\bar{K})$的$\\bar{C}^\*$要换成$\\bar{C}^\*(I - z^L\\bar{A}^L)$，这里$L$是提前选定的最大训练长度。接下来，我们只需要代入$z=e^{-2i\\pi l/L},l=0,1,2,\\dots,L-1$进行计算，结果就是$\\bar{K}$的DFT，然后IDFT就得到$\\bar{K}$了，这个过程还可以转化为Cauchy核问题加速一下，但个人认为不是太核心，就不展开讨论了。最后的最后，还有一个技巧，就是对于$z=e^{-2i\\pi l/L}$有$z^L=1$，此时只是相当于将$\\bar{C}^\*$要换成$\\bar{C}^\*(I - \\bar{A}^L)$，而S4将$\\bar{C}$当成训练参数，所以我们可以直接将$\\bar{C}^\*(I - \\bar{A}^L)$当成训练参数，事后再从中解出$\\bar{C}$用于推理，这样训练时就可以避免计算$\\bar{A}^L$了。

这里看上去我们也可以代入$z=e^{-i\\pi l/L}$直接计算卷积所用的$\\bar{K}$的DFT，而不是迂回地先IDFT得到$\\bar{K}$，然后拼接零再DFT，但问题是此时$z^L=(-1)^l$是一个不定值，我们没法将$\\bar{C}^\*(I - z^L\\bar{A}^L)$看成单个训练参数，这会导致在训练过程中需要计算$\\bar{A}^L$，计算量比较大（当然，如果训练过程中$\\bar{A}$是完全固定的，那么可以提前算出来，视情况而定）。

## 草草收尾 [\#](https://kexue.fm/archives/10162\#%E8%8D%89%E8%8D%89%E6%94%B6%E5%B0%BE)

经过一通艰难的“长篇大论”，我们总算把S4中比较关键的数学细节都捋了一遍，希望能够对有兴趣了解S4的读者有所帮助。可以看到，S4是对HiPPO的进一步补充和完成，它的关键一笔是提出了$A$等价于“对角+低秩”的矩阵形式，为剩余部分的分析奠定了基础。因为一开始$A$是分段定义的形式，而不是矩阵运算形式，这样的定义不利于应用现有的线性代数工具进行一般化分析。

由于HiPPO的推导是基于$u(t)$是一维函数进行的，所以到目前为止，S4的$u\_k$也都还是标量。那么S4怎么处理向量序列输入呢？非常暴力，它直接对每个分量独立地应用一遍前述线性RNN，每个RNN使用不同的$\\epsilon,B,C$参数，然后将结果拼接起来，这个做法直到作者最新的Mamaba依然还被应用。当然，也有简化的做法，直接在单个RNN中处理向量输入，只需要相应地将$B,C$改为矩阵就行，这就是 [S5](https://papers.cool/arxiv/2208.04933)（作者不是Albert Gu了），这种做法可以理解为单纯借用了S4的线性RNN形式以及HiPPO的矩阵$A$，而抛开了HiPPO的其他细枝末节，也取得了不错的效果。

让人啼笑皆非的是，S4提出了诸多精妙的数学技巧来简化和加速$A$的计算，结果从 [《Diagonal State Spaces are as Effective as Structured State Spaces》](https://papers.cool/arxiv/2203.14343) 开始，原作者的后续工作包括Mamba基本上都抛弃了这部分内容，而是直接假设$A$为对角矩阵，这样RNN部分就跟 [《Google新作试图“复活”RNN：RNN能否再次辉煌？》](https://kexue.fm/archives/9554) 介绍的LRU大同小异了。因此，从当前最新的SSM及线性RNN的角度看，S4及HiPPO系列工作某种意义上来说已经是“过时”了。很多讲解Mamba的文章从HiPPO、S4开始说起，从事后来说可谓是“大可不必”了。

当然，对于笔者来说，花那么长的篇幅去学习HiPPO和S4，并不是简单为了理解或使用最新的SSM和RNN模型，而是通过学习HiPPO背后的假设和推导，了解线性系统的记忆方式和瓶颈，为将来构建新模型、新方法积累更多的思路。此外，HiPPO和S4中诸多精妙的数学技巧也让人赏心悦目，并且也不失为提升数学能力的相当不错的练习题。

## 文章小结 [\#](https://kexue.fm/archives/10162\#%E6%96%87%E7%AB%A0%E5%B0%8F%E7%BB%93)

本文介绍了HiPPO的后续之作S4，它的关键之处是提出了“对角矩阵+低秩矩阵”的分解，从而实现了HiPPO矩阵的高效并行计算，本文主要对其中比较困难的数学细节做了介绍和推导。

_**转载到请包括本文地址：** [https://kexue.fm/archives/10162](https://kexue.fm/archives/10162)_

_**更详细的转载事宜请参考：**_ [《科学空间FAQ》](https://kexue.fm/archives/6508#%E6%96%87%E7%AB%A0%E5%A6%82%E4%BD%95%E8%BD%AC%E8%BD%BD/%E5%BC%95%E7%94%A8)

**如果您还有什么疑惑或建议，欢迎在下方评论区继续讨论。**

**如果您觉得本文还不错，欢迎 [分享](https://kexue.fm/archives/10162#share)/ [打赏](https://kexue.fm/archives/10162#pay) 本文。打赏并非要从中获得收益，而是希望知道科学空间获得了多少读者的真心关注。当然，如果你无视它，也不会影响你的阅读。再次表示欢迎和感谢！**

打赏

微信打赏

支付宝打赏

因为网站后台对打赏并无记录，因此欢迎在打赏时候备注留言。你还可以 [**点击这里**](http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=tN7d1drY3drrx8H0xcWa19vZ) 或在下方评论区留言来告知你的建议或需求。

**如果您需要引用本文，请参考：**

苏剑林. (Jun. 20, 2024). 《重温SSM（三）：HiPPO的高效计算（S4） 》\[Blog post\]. Retrieved from [https://kexue.fm/archives/10162](https://kexue.fm/archives/10162)

@online{kexuefm-10162,
        title={重温SSM（三）：HiPPO的高效计算（S4）},
        author={苏剑林},
        year={2024},
        month={Jun},
        url={\\url{https://kexue.fm/archives/10162}},
}

分类： [数学研究](https://kexue.fm/category/Mathematics)    标签： [矩阵](https://kexue.fm/tag/%E7%9F%A9%E9%98%B5/), [线性](https://kexue.fm/tag/%E7%BA%BF%E6%80%A7/), [RNN](https://kexue.fm/tag/RNN/), [ssm](https://kexue.fm/tag/ssm/)[22 评论](https://kexue.fm/archives/10162#comments)

< [通向概率分布之路：盘点Softmax及其替代品](https://kexue.fm/archives/10145) \| [重温SSM（四）：有理生成函数的新视角](https://kexue.fm/archives/10180) >

### 你也许还对下面的内容感兴趣

- [通过msign来计算奇异值裁剪mclip（下）](https://kexue.fm/archives/11059)
- [矩阵符号函数mcsgn能计算什么？](https://kexue.fm/archives/11056)
- [线性注意力简史：从模仿、创新到反哺](https://kexue.fm/archives/11033)
- [msign的导数](https://kexue.fm/archives/11025)
- [通过msign来计算奇异值裁剪mclip（上）](https://kexue.fm/archives/11006)
- [SVD的导数](https://kexue.fm/archives/10878)
- [矩阵的有效秩（Effective Rank）](https://kexue.fm/archives/10847)
- [Muon续集：为什么我们选择尝试Muon？](https://kexue.fm/archives/10739)
- [低秩近似之路（五）：CUR](https://kexue.fm/archives/10662)
- [从谱范数梯度到新式权重衰减的思考](https://kexue.fm/archives/10648)

[发表你的看法](https://kexue.fm/archives/10162#comment_form)

Z. T

June 22nd, 2024

这种算法不还得是每个位置算一次傅里叶变换嘛？yL和yL-1不能同时算出来

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24586#respond-post-10162)

[苏剑林](https://kexue.fm) 发表于
June 27th, 2024

可以的，$IDFT(DFT(a)DFT(b))$同时算出$a\_{< 1}\*b\_{< 1}$、$a\_{< 2}\*b\_{< 2}$、$a\_{< 3}\*b\_{< 3}$、...

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24609#respond-post-10162)

Z. T 发表于
June 27th, 2024

比如，a = \[1,2,3\], b = \[4,5,6\] a 和 b 进行卷积不是 a \* b = \[1 x 4 + 2 x 6 + 3 x 5, 1 x 5 + 2 x 4 + 3 x 6, 1 x 6 + 2 x 5 + 3 x 4\] = \[31, 31, 28\] 而不是 $a\_{< 1} \* b\_{< 1}$,$a\_{< 2} \* b\_{< 2}$,$a\_{< 3} \* b\_{< 3}$ = \[4, 13, 28\]

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24620#respond-post-10162)

[苏剑林](https://kexue.fm) 发表于
June 27th, 2024

如果单单说$a,b$的卷积，那么它就是$1\\times 6 + 2\\times 5 + 3\\times 4 = 28$，结果是一个数。

对于SSM来说，我们要算的是$a,b$的前1、2、3、...个分量的卷积，得到$d$个不同的数字。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24622#respond-post-10162)

Z. T 发表于
June 28th, 2024

是的，但是每个分量的计算仍然要算一趟DFT和IDFT，也就是没办法用一趟傅立叶变换算出所有分量的卷积。

换句话说，给定向量a = \[1,2,3\], b = \[4,5,6\]，用pytorch计算IDFT(DFT(a)DFT(b))的结果是：a \* b = \[1 x 4 + 2 x 6 + 3 x 5, 1 x 5 + 2 x 4 + 3 x 6, 1 x 6 + 2 x 5 + 3 x 4\] = \[31, 31, 28\]，其物理含义只有最后一个元素是match的。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24624#respond-post-10162)

[苏剑林](https://kexue.fm) 发表于
June 28th, 2024

试试 np.fft.irfft(np.fft.rfft(\[1,2,3,0,0,0\]) \* np.fft.rfft(\[4,5,6,0,0,0\]))\[:3\]

其中原理在“生成函数”那一节已经说了。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24627#respond-post-10162)

aminer

July 3rd, 2024

看作者的推导、解释，也很赏心悦目。奈何数学功底太弱，只能了解大概

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24684#respond-post-10162)

ZYShin

July 11th, 2024

感谢作者刨根问底的分享，让大家对SSM背后的数学原理有了清晰的认识。
公式(30)第一种情况$k \\lt n$少了个负号吧，然后第二种情况应该是$k=n$

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24778#respond-post-10162)

[苏剑林](https://kexue.fm) 发表于
July 12th, 2024

确实如此，感谢指出，为认真阅读点赞

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24795#respond-post-10162)

Ava Ye

July 31st, 2024

请教一下苏神，公式18成立的前提是不是:(1)求和项直到正无穷;(2)谱半径小于1？但对于原本的卷积和的形式，其实求和项只到L-1, 如果这样的话，公式18的右边部分（从幂到逆）是不是就只能算是原本幂形式的近似计算了？

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24940#respond-post-10162)

[苏剑林](https://kexue.fm) 发表于
August 7th, 2024

1、是的；

2、你说的是“截断生成函数”的概念，在“最后冲刺”一节提到了；

3、之所以在最后一节才提到，是因为“生成函数”本身不需要截断，是为了应用傅立叶变换才需要截断，前面大部份都是基于“生成函数”的讲解，最后才将生成函数的结果跟傅立叶变换结合起来。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=24967#respond-post-10162)

vdcn12593

August 26th, 2024

苏神你好，看了一小部分卡住了，请教一下：
1\. 生成函数那一节，提到我们可以 “快速计算生成函数以及快速提取生成函数某一项系数的方法，那么就可以将卷积运算转换为生成函数，做普通乘法之后然后再提取相应的系数”。但是(15),(16)式之后，接下来怎么做呢？如何得到a和b生成函数的乘积，并提取相应系数？
2\. (18)式是如何得到的，是个关于矩阵幂级数的定理吗？

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25108#respond-post-10162)

vdcn12593 发表于
August 27th, 2024

问题1我搞懂了，简单总结就是：对于序列a或b，观察到其做DFT后的新序列正好是他们的（截断）生成函数g(a),g(b)在一系列特定z点的取值。接下里应是对a和b做DFT后的新序列逐点相乘，也就得到g(a)和g(b)的（截断）乘积在这些z点的取值。这个乘积是同阶的多项式函数，所以这个逐点相乘得到的序列一定也是它做DFT后的新序列，因此再做一个IDFT就可以得到每一个阶数的系数了。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25114#respond-post-10162)

[苏剑林](https://kexue.fm) 发表于
August 27th, 2024

1、生成函数原本是$z$的函数，原本从数值上计算生成函数需要计算无限个点（$z\\in\\mathbb{C}$），但DFT告诉我们，计算有限个点就可以足够让我们提取对应的系数了，所以就有了有限个点的DFT和IDFT；

2、其实就是泰勒展开$\\frac{1}{1-x}=1+x+x^2+x^3+\\cdots$的矩阵版。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25125#respond-post-10162)

EthanZou

August 29th, 2024

“卷积运算可以通过（离散）傅立叶变换转换为频域的加法运算”
这里应该是“频域的乘法运算”吧

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25135#respond-post-10162)

[苏剑林](https://kexue.fm) 发表于
September 1st, 2024

已经更正，感谢指出。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25142#respond-post-10162)

liubingqing20@mails.ucas.ac.cn

October 14th, 2024

作者您好，我想问一下，那个从幂到逆那里：卷积核长度不是有限的吗？是L，见公式15，但是公式19里面你求和到无穷。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25502#respond-post-10162)

[苏剑林](https://kexue.fm) 发表于
October 14th, 2024

不要着急，看到$(39)$式就行了。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25512#respond-post-10162)

张明皓

December 7th, 2024

苏老师您好，您的公式(6)的等式右边括号中的正负号是不是应该为正号？我看您后面的说法是此矩阵的每个对角线元素都是小于1的

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25918#respond-post-10162)

[苏剑林](https://kexue.fm) 发表于
December 11th, 2024

对，感谢指正。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25948#respond-post-10162)

watermelon

December 7th, 2024

苏老师您好，请问为什么式(7)具有二阶精度？

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25920#respond-post-10162)

[苏剑林](https://kexue.fm) 发表于
December 11th, 2024

[https://kexue.fm/archives/10137](https://kexue.fm/archives/10137) 已经推了啊。

[回复评论](https://kexue.fm/archives/10162/comment-page-1?replyTo=25949#respond-post-10162)

[取消回复](https://kexue.fm/archives/10162#respond-post-10162)

你的大名

电子邮箱

个人网站（选填）

1\. 可以使用LaTeX代码，点击“预览效果”可查看效果；2. 可以通过点击评论楼层编号来引用该楼层；3. 网站可能会有点卡，如非确认评论失败，请 **不要重复点击提交**。

### 内容速览

[基本框架](https://kexue.fm/archives/10162#%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6)
[指数衰减](https://kexue.fm/archives/10162#%E6%8C%87%E6%95%B0%E8%A1%B0%E5%87%8F)
[离散格式](https://kexue.fm/archives/10162#%E7%A6%BB%E6%95%A3%E6%A0%BC%E5%BC%8F)
[卷积运算](https://kexue.fm/archives/10162#%E5%8D%B7%E7%A7%AF%E8%BF%90%E7%AE%97)
[生成函数](https://kexue.fm/archives/10162#%E7%94%9F%E6%88%90%E5%87%BD%E6%95%B0)
[从幂到逆](https://kexue.fm/archives/10162#%E4%BB%8E%E5%B9%82%E5%88%B0%E9%80%86)
[特征向量](https://kexue.fm/archives/10162#%E7%89%B9%E5%BE%81%E5%90%91%E9%87%8F)
[对角低秩](https://kexue.fm/archives/10162#%E5%AF%B9%E8%A7%92%E4%BD%8E%E7%A7%A9)
[点睛之笔](https://kexue.fm/archives/10162#%E7%82%B9%E7%9D%9B%E4%B9%8B%E7%AC%94)
[最后冲刺](https://kexue.fm/archives/10162#%E6%9C%80%E5%90%8E%E5%86%B2%E5%88%BA)
[草草收尾](https://kexue.fm/archives/10162#%E8%8D%89%E8%8D%89%E6%94%B6%E5%B0%BE)
[文章小结](https://kexue.fm/archives/10162#%E6%96%87%E7%AB%A0%E5%B0%8F%E7%BB%93)

### 智能搜索

支持整句搜索！网站自动使用 [结巴分词](https://github.com/fxsjy/jieba) 进行分词，并结合ngrams排序算法给出合理的搜索结果。

### 热门标签

[生成模型](https://kexue.fm/tag/%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/) [attention](https://kexue.fm/tag/attention/) [优化](https://kexue.fm/tag/%E4%BC%98%E5%8C%96/) [语言模型](https://kexue.fm/tag/%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/) [模型](https://kexue.fm/tag/%E6%A8%A1%E5%9E%8B/) [网站](https://kexue.fm/tag/%E7%BD%91%E7%AB%99/) [概率](https://kexue.fm/tag/%E6%A6%82%E7%8E%87/) [梯度](https://kexue.fm/tag/%E6%A2%AF%E5%BA%A6/) [转载](https://kexue.fm/tag/%E8%BD%AC%E8%BD%BD/) [微分方程](https://kexue.fm/tag/%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B/) [矩阵](https://kexue.fm/tag/%E7%9F%A9%E9%98%B5/) [天象](https://kexue.fm/tag/%E5%A4%A9%E8%B1%A1/) [分析](https://kexue.fm/tag/%E5%88%86%E6%9E%90/) [深度学习](https://kexue.fm/tag/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/) [积分](https://kexue.fm/tag/%E7%A7%AF%E5%88%86/) [python](https://kexue.fm/tag/python/) [优化器](https://kexue.fm/tag/%E4%BC%98%E5%8C%96%E5%99%A8/) [力学](https://kexue.fm/tag/%E5%8A%9B%E5%AD%A6/) [无监督](https://kexue.fm/tag/%E6%97%A0%E7%9B%91%E7%9D%A3/) [扩散](https://kexue.fm/tag/%E6%89%A9%E6%95%A3/) [几何](https://kexue.fm/tag/%E5%87%A0%E4%BD%95/) [节日](https://kexue.fm/tag/%E8%8A%82%E6%97%A5/) [生活](https://kexue.fm/tag/%E7%94%9F%E6%B4%BB/) [文本生成](https://kexue.fm/tag/%E6%96%87%E6%9C%AC%E7%94%9F%E6%88%90/) [数论](https://kexue.fm/tag/%E6%95%B0%E8%AE%BA/)

### 随机文章

- [【龟鱼记】全陶粒的同程底滤生态缸](https://kexue.fm/archives/7961)
- [植物拯救了地球，阻止寒冷灭绝之灾！](https://kexue.fm/archives/15)
- [FlatNCE：小批次对比学习效果差的原因竟是浮点误差？](https://kexue.fm/archives/8586)
- [从动力学角度看优化算法（四）：GAN的第三个阶段](https://kexue.fm/archives/6583)
- [2009.7.22日全食各地区模拟(Flash)](https://kexue.fm/archives/18)
- [Transformer升级之路：17、多模态位置编码的简单思考](https://kexue.fm/archives/10040)
- [《新理解矩阵4》：相似矩阵的那些事儿](https://kexue.fm/archives/1777)
- [梯度视角下的LoRA：简介、分析、猜测及推广](https://kexue.fm/archives/9590)
- [用热传导方程来指导自监督学习](https://kexue.fm/archives/9359)
- [《量子力学与路径积分》习题解答V0.5](https://kexue.fm/archives/3692)

### 最近评论

- [abcm](https://kexue.fm/archives/10114/comment-page-3#comment-28017): 公式(14)为什么是直接带入，我的理解是0到T积分再换元
\\begin{align}
\\int...
- [Truenobility303](https://kexue.fm/archives/10739/comment-page-2#comment-28016): 苏神好，关于RMS对齐这里有些疑问。1. 如果从 A Spectral Condition f...
- [wolfzdf](https://kexue.fm/archives/9907/comment-page-4#comment-27987): 您好，请问cool paper中收集的会议论文，有保存整理文章（通讯）作者的邮箱吗？
现在计算...
- [无敌大铁锤](https://kexue.fm/archives/11033/comment-page-1#comment-27986): 嗯嗯笔误了，就是去掉Causal的mask，变成一个纯Self-Attention的形式,然后...
- [HikaruNight](https://kexue.fm/archives/8397/comment-page-3#comment-27985): 苏老师，想请教一下如果把四元数放在三维RoPE里面是不是可行的
- [Leco](https://kexue.fm/archives/9590/comment-page-2#comment-27984): 请问LoRA的A,B矩阵初始化时，一个高斯随机一个全零还是只能A高斯，B全零呢？
- [苏剑林](https://kexue.fm/archives/9119/comment-page-13#comment-27983): 如果你把你这里提到的数学都学通透了，数学基础基本上可以胜任95%以上的场景了吧？至于“直觉”这...
- [苏剑林](https://kexue.fm/archives/10958/comment-page-2#comment-27982): 我跑过这个项目，效果是能复现的。“在 CIFAR-10 上效果非常差，生成的图片都是模糊的”是...
- [Henry Zha](https://kexue.fm/archives/9119/comment-page-13#comment-27981): 苏神你好，我是一名管理科学与工程专业的博士生，研究方向是结合人工智能模型建模用户行为之类的管理...
- [SunlightZero](https://kexue.fm/archives/10958/comment-page-2#comment-27980): 我根据 https://github.com/haidog-yaqub/MeanFlow 尝试...

### 友情链接

- [Cool Papers](https://papers.cool)
- [数学研发](https://bbs.emath.ac.cn)
- [Seatop](http://www.seatop.com.cn/)
- [Xiaoxia](https://xiaoxia.org/)
- [积分表-网络版](https://kexue.fm/sci/integral/index.html)
- [丝路博傲](http://blog.dvxj.com/)
- [ph4ntasy 饭特稀](http://www.ph4ntasy.com/)
- [数学之家](http://www.2math.cn/)
- [有趣天文奇观](http://interesting-sky.china-vo.org/)
- [TwistedW](http://www.twistedwg.com/)
- [godweiyang](https://godweiyang.com/)
- [AI柠檬](https://blog.ailemon.net/)
- [王登科-DK博客](https://greatdk.com)
- [ESON](https://blog.eson.org/)
- [枫之羽](https://fzhiy.net/)
- [Mathor's blog](https://wmathor.com/)
- [coding-zuo](https://coding-zuo.github.io/)
- [博科园](https://www.bokeyuan.net/)
- [孔皮皮的博客](https://www.kppkkp.top/)
- [运鹏的博客](https://yunpengtai.top/)
- [jiming.site](https://jiming.site/)
- [OmegaXYZ](https://www.omegaxyz.com/)
- [Blog by Eacls](https://www.eacls.top/)
- [EAI猩球](https://www.robotech.ink/)
- [文举的博客](https://liwenju0.com/)
- [用代码打点酱油](https://bruceyuan.com/)
- [申请链接](https://kexue.fm/links.html)

本站采用创作共用版权协议，要求署名、非商业用途和保持一致。转载本站内容必须也遵循“ [署名-非商业用途-保持一致](http://creativecommons.org/licenses/by-nc-nd/2.5/cn/)”的创作共用协议。
© 2009-2025 Scientific Spaces. All rights reserved. Theme by [laogui](http://www.laogui.com). Powered by [Typecho](http://typecho.org). 备案号: [粤ICP备09093259号-1/2](https://beian.miit.gov.cn/)。