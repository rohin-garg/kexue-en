
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    tags: 'ams',
    packages: {'[+]': ['ams']}
  },
  options: {
    renderActions: {
      findScript: [10, function (doc) {
        for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
          const display = !!node.type.match(/; *mode=display/);
          const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
          const text = document.createTextNode('');
          node.parentNode.replaceChild(text, node);
          math.start = {node: text, delim: '', n: 0};
          math.end = {node: text, delim: '', n: 0};
          doc.math.push(math);
        }
      }, '']
    }
  }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<nav style="margin-bottom: 1.5em;">
    <a href="../index.html" style="display: inline-flex; align-items: center; color: #555; text-decoration: none; font-size: 0.95em;">
        <span style="margin-right: 0.3em;">&larr;</span> Back to Index
    </a>
</nav>

<h1><a href="https://kexue.fm/archives/8338">The Road to Transformer Upgrade: 3. From Performer to Linear Attention</a></h1>

<p>By 苏剑林 | April 22, 2021</p>

<p>Readers of my previous articles <a href="translation_7521.html">"Exploration of Linear Attention: Does Attention Need a Softmax?"</a> and <a href="translation_7926.html">"Performer: Linearizing Attention Complexity with Random Projections"</a> might find the title of this post a bit unnatural. Since Linear Attention came before the Performer, the relationship is typically framed as "the Performer is an implementation of Linear Attention that approximates standard Attention while maintaining linear complexity." Thus, normally, it should be "From Linear Attention to Performer." However, this post does not intend to trace the historical development of Linear Attention, but rather to reflect on the insights Performer brings to Linear Attention. Hence, "From Performer to Linear Attention."</p>

<h3>Activation Functions</h3>

<p>The common form of Linear Attention is:</p>

\begin{equation}Attention(\boldsymbol{Q},\boldsymbol{K},\boldsymbol{V})_i = \frac{\sum\limits_{j=1}^n \text{sim}(\boldsymbol{q}_i, \boldsymbol{k}_j)\boldsymbol{v}_j}{\sum\limits_{j=1}^n \text{sim}(\boldsymbol{q}_i, \boldsymbol{k}_j)} = \frac{\sum\limits_{j=1}^n \phi(\boldsymbol{q}_i)^{\top} \varphi(\boldsymbol{k}_j)\boldsymbol{v}_j}{\sum\limits_{j=1}^n \phi(\boldsymbol{q}_i)^{\top} \varphi(\boldsymbol{k}_j)}\end{equation}

<p>where $\phi(\cdot)$ and $\varphi(\cdot)$ are non-negative activation functions. How should we choose this activation function? Performer tells us that we should choose the exponential function:</p>

\begin{equation}\phi(x)=\varphi(x)=e^x\end{equation}

<p>First, let's look at how this differs from existing results. In <a href="https://arxiv.org/abs/2006.16236">"Transformers are RNNs: Fast Autoregressive Transformers with Linear Attention"</a>, the given choice is:</p>

\begin{equation}\phi(x)=\varphi(x)=1 + \text{elu}(x) = \left\{\begin{aligned}1 + x,\, x \geq 0\\ e^x,\, x < 0\end{aligned}\right.\end{equation}

<p>We know that $1+x$ is exactly the first-order Taylor expansion of $e^x$ at $x=0$, so the choice of $1+\text{elu}(x)$ is actually quite close to $e^x$. Furthermore, the scheme $\phi(x)=\varphi(x)=e^x$ is very similar to the dual-softmax design for building Linear Attention introduced in <a href="https://arxiv.org/abs/2102.11174">"Efficient Attention: Attention with Linear Complexities"</a>. In that design, $\phi(\boldsymbol{q})=softmax(\boldsymbol{q})$ and $\varphi(\boldsymbol{k})=e^{\boldsymbol{k}}$. Compared to directly using $\phi(x)=\varphi(x)=e^x$, the difference is merely the position of normalization.</p>

<h3>Simple Derivation</h3>

<p>Why do we say Performer tells us the best activation function is $e^x$? Let's look at the mapping found by Performer to linearize standard Attention:</p>

\begin{equation}\begin{aligned} 
e^{\boldsymbol{q}\cdot \boldsymbol{k}}&=\mathbb{E}_{\boldsymbol{\omega}\sim \mathcal{N}(\boldsymbol{\omega};0,\boldsymbol{1}_d)}\left[e^{\boldsymbol{\omega}\cdot \boldsymbol{q}-\Vert \boldsymbol{q}\Vert^2 / 2} \times e^{\boldsymbol{\omega}\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2}\right]\\[6pt] 
&\approx\underbrace{\frac{1}{\sqrt{m}}\begin{pmatrix}e^{\boldsymbol{\omega}_1\cdot \boldsymbol{q}-\Vert \boldsymbol{q}\Vert^2 / 2} \\ 
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{q}-\Vert \boldsymbol{q}\Vert^2 / 2}\\ 
\vdots\\ 
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{q}-\Vert \boldsymbol{q}\Vert^2 / 2} \end{pmatrix}}_{\tilde{\boldsymbol{q}}} 
\cdot \underbrace{\frac{1}{\sqrt{m}}\begin{pmatrix}e^{\boldsymbol{\omega}_1\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2} \\ 
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2}\\ 
\vdots\\ 
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2} \end{pmatrix}}_{\tilde{\boldsymbol{k}}} 
\end{aligned}\end{equation}

<p>Simply put, Performer found a mapping that transforms $d$-dimensional vectors $\boldsymbol{q}, \boldsymbol{k}$ into $m$-dimensional vectors $\tilde{\boldsymbol{q}}, \tilde{\boldsymbol{k}}$, satisfying the approximation $e^{\boldsymbol{q}\cdot \boldsymbol{k}}\approx \tilde{\boldsymbol{q}}\cdot\tilde{\boldsymbol{k}}$. In this case:</p>

\begin{equation}a_{i,j} = \frac{e^{\boldsymbol{q}_i\cdot \boldsymbol{k}_j}}{\sum\limits_j e^{\boldsymbol{q}_i\cdot \boldsymbol{k}_j}}\approx \frac{\tilde{\boldsymbol{q}}_i\cdot\tilde{\boldsymbol{k}}_j}{\sum\limits_j \tilde{\boldsymbol{q}}_i\cdot\tilde{\boldsymbol{k}}_j} = \frac{(\lambda(\tilde{\boldsymbol{q}}_i)\tilde{\boldsymbol{q}}_i)\cdot\tilde{\boldsymbol{k}}_j}{\sum\limits_j (\lambda(\tilde{\boldsymbol{q}}_i)\tilde{\boldsymbol{q}}_i)\cdot\tilde{\boldsymbol{k}}_j}\end{equation}

<p>The last equality shows that multiplying $\tilde{\boldsymbol{q}}$ by a constant (even if this constant depends on $\tilde{\boldsymbol{q}}$) does not change the Performer's result at all. This means if we change the mapping to:</p>

\begin{equation} 
\tilde{\boldsymbol{q}} = \begin{pmatrix}e^{\boldsymbol{\omega}_1\cdot \boldsymbol{q}} \\ 
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{q}}\\ 
\vdots\\ 
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{q}} \end{pmatrix},\qquad 
\tilde{\boldsymbol{k}}=\begin{pmatrix}e^{\boldsymbol{\omega}_1\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2} \\ 
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2}\\ 
\vdots\\ 
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{k}-\Vert \boldsymbol{k}\Vert^2 / 2} \end{pmatrix} 
\end{equation}

<p>The Performer's result will not change. Of course, the $\Vert \boldsymbol{k}\Vert^2$ term cannot be removed yet. However, if we assume that $\Vert \boldsymbol{k}\Vert^2$ does not fluctuate too much and is not the primary factor of Attention, then this term also acts as a constant. Thus, the final mapping is (approximately) equivalent to:</p>

\begin{equation} 
\tilde{\boldsymbol{q}} = \begin{pmatrix}e^{\boldsymbol{\omega}_1\cdot \boldsymbol{q}} \\ 
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{q}}\\ 
\vdots\\ 
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{q}} \end{pmatrix},\qquad 
\tilde{\boldsymbol{k}}=\begin{pmatrix}e^{\boldsymbol{\omega}_1\cdot \boldsymbol{k}} \\ 
e^{\boldsymbol{\omega}_2\cdot \boldsymbol{k}}\\ 
\vdots\\ 
e^{\boldsymbol{\omega}_m\cdot \boldsymbol{k}} \end{pmatrix} 
\end{equation}

<p>How do we understand this mapping, which appears much simplified? In fact, the $m$ random vectors $\boldsymbol{\omega}_1,\boldsymbol{\omega}_2,\cdots,\boldsymbol{\omega}_m$ form a $d\times m$ matrix that maps the $d$-dimensional $\boldsymbol{q}, \boldsymbol{k}$ to $m$-dimensional vectors, which are then passed through the activation function $e^x$ to obtain $\tilde{\boldsymbol{q}}, \tilde{\boldsymbol{k}}$. We know that $\boldsymbol{q}, \boldsymbol{k}$ in Attention undergo a fully connected layer transformation. If we integrate this $d\times m$ mapping matrix into that fully connected layer, what remains is the activation function $e^x$!</p>

<p>So this is the source of the optimal activation function $e^x$: as long as we change the output dimension of $\boldsymbol{q}, \boldsymbol{k}$ from $d$ to $m$ and pair it with the activation function $e^x$, then theoretically, it possesses the fitting capability of Performer, or even stronger. This is because Performer's $d\times m$ matrix is a fixed random matrix, whereas here, we treat that matrix as trainable and remove the low-rank constraint, allowing for a larger space than Performer.</p>

<h3>The Low-Rank Problem</h3>

<p>Whether it is the Performer discussed here or the <a href="translation_8180.html">Nyströmformer</a> introduced previously, their approach is to "seek a Linear Attention that can approximate standard Attention." A natural question arises: what is so good about standard Attention? Why is it worth aligning with?</p>

<p>From the perspective of information loss, the "rank" of the standard Attention matrix may be larger, meaning it is closer to an invertible matrix, which signifies it can retain more valid information. Specifically, the Attention matrix is an $n\times n$ matrix derived from $\boldsymbol{Q},\boldsymbol{K}\in\mathbb{R}^{n\times d}$ via $softmax(\boldsymbol{Q}\boldsymbol{K}^{\top})$. It should be noted that the $d$ here is the key_size of the Attention; for instance, in BERT-base, it is only 64, while $n$ is often quite large. This implies the rank of $\boldsymbol{Q}\boldsymbol{K}^{\top}$ does not exceed $d$, and since $d\ll n$, it is far from full rank. However, the key operation of $softmax$ is $e^{\boldsymbol{Q}\boldsymbol{K}^{\top}}$. If every element in a matrix is exponentiated, the rank of the new matrix can potentially increase! Thus, the standard Attention matrix has the potential for rank expansion, meaning it inherently possesses a more effective capacity for processing information.</p>

<p>In contrast, the Linear Attention matrix takes the form $\tilde{\boldsymbol{Q}}\tilde{\boldsymbol{K}}^{\top}$, so its rank cannot exceed $m$. To compensate for the loss of rank, $m > d$ is generally set. In Performer experiments, $m = 4d$ was chosen, meaning the key_size was quadrupled—the importance of rank is evident. Of course, increasing the key_size has the direct consequence that Linear Attention may be slower than standard Attention when processing short sequences, which is an inherent bottleneck of Linear Attention.</p>

<p>Regarding theoretical analysis of the rank of the Attention matrix, there are papers for reference. For example, <a href="https://arxiv.org/abs/2006.04710">"Low-Rank Bottleneck in Multi-head Attention Models"</a> points out that even in standard Attention, low-rankness is a serious bottleneck, and increasing key_size can improve performance. A paper from last month, <a href="https://arxiv.org/abs/2103.03404">"Attention is Not All You Need: Pure Attention Loses Rank Doubly Exponentially with Depth"</a>, points out that without residuals and FFNs, standard Attention runs a high risk of decaying into a simple transformation with a rank of 1. If even standard Attention, which has "rank-expanding potential," faces low-rank issues, then Linear Attention—which has a hard cap on its rank—is even more vulnerable.</p>

<p>In short: Linear Attention requires a larger key_size to maintain its rank.</p>

<h3>Concentrating Attention</h3>

<p>We can also understand the benefits of standard Attention from the perspective of sparsity. Intuitively, since it is an "Attention Mechanism," it must "concentrate attention." If it is too dispersed, it might be equivalent to average pooling. "Concentrating attention" means each token should only significantly correlate with a few other tokens. Mathematically, this means the Attention matrix is sparse, or at least has the potential to become sparse.</p>

<p>For standard Attention, it normalizes through softmax:</p>

\begin{equation}a_{i,j} = \frac{e^{\boldsymbol{q}_i\cdot \boldsymbol{k}_j}}{\sum\limits_j e^{\boldsymbol{q}_i\cdot \boldsymbol{k}_j}}\end{equation}

<p>The exponential function $e^x$ plays an amplifying role. As long as the individual $\boldsymbol{q}_i\cdot \boldsymbol{k}_j$ values can establish some gap, $e^{\boldsymbol{q}_i\cdot \boldsymbol{k}_j}$ will further widen that gap. The result is that after normalization, probabilities at positions other than the maximum values become very close to 0. This shows standard Attention has the potential to "concentrate attention." Linear Attention, however, is the result of a direct inner product without the amplification of $e^x$. Consequently, its attention is denser, and when sequence lengths are large, it often approaches average pooling. To mitigate this, one still needs to increase the key_size to amplify the differences; intuitively, $n$ vectors are too "crowded" in a low-dimensional space, and moving to a higher-dimensional space makes it "looser."</p>

<p>How can we verify the importance of sparsity? I once tried calculating the Linear Attention matrix and then manually truncating it (i.e., each token only attends to a few tokens before and after it, turning it into a local Attention). The results showed that this truncated Linear Attention performed significantly better than the full-matrix version. This confirms the importance of sparsity. Of course, explicitly calculating the Attention matrix before truncating it means the complexity is no longer linear, so it lacks practical value and was used only for theoretical validation.</p>

<p>Another experimental phenomenon supports the importance of sparsity: when Linear Attention is used for language models or decoders, its performance is nearly identical to standard Attention. In these cases, Linear Attention becomes a unidirectional RNN (refer to <a href="https://arxiv.org/abs/2006.16236">"Transformers are RNNs: Fast Autoregressive Transformers with Linear Attention"</a>), which is equivalent to the Attention matrix becoming lower triangular and thus sparser. In contrast, if non-sparse bidirectional Linear Attention is used directly for an MLM (Masked Language Model), the performance drop is quite significant.</p>

<p>More importantly, sparsity and the rank mentioned in the previous section are closely linked—two sides of the same coin: appropriate sparsification methods can increase the rank of a matrix! For instance, in the lower triangular Attention matrix of a language model, as long as the diagonal elements are non-zero (which they usually are), the matrix becomes full-rank and invertible! Similarly, the local Attention truncation I experimented with also increases the rank; in an extreme case, if each token only attends to itself, the Attention matrix becomes the full-rank Identity matrix!</p>

<h3>Article Summary</h3>

<p>Starting from the Performer, this article reflects on several issues regarding Linear Attention, including the choice of activation function and the bottlenecks (low-rankness, sparsity). The overall conclusion is that the optimal activation function for Linear Attention should be the exponential function, and an effective Attention mechanism should possess higher rank and greater sparsity.</p>
<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="https://kexue.fm/archives/8338" style="color: #005fcc;">https://kexue.fm/archives/8338</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
