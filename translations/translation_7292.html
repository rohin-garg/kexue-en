
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    packages: {'[+]': ['ams']},
    tags: 'ams'
  },
  options: {
    renderActions: {
      findScript: [10, function (doc) {
        for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
          const display = !!node.type.match(/; *mode=display/);
          const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
          const text = document.createTextNode('');
          node.parentNode.replaceChild(text, node);
          math.start = {node: text, delim: '', n: 0};
          math.end = {node: text, delim: '', n: 0};
          doc.math.push(math);
        }
      }, '']
    }
  },
  loader: {load: ['[tex]/ams']}
};
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<nav style="margin-bottom: 1.5em;">
    <a href="../index.html" style="display: inline-flex; align-items: center; color: #555; text-decoration: none; font-size: 0.95em;">
        <span style="margin-right: 0.3em;">&larr;</span> Back to Index
    </a>
</nav>

<h1><a href="https://kexue.fm/archives/7292">Now You Can Play with Chinese GPT2 Using Keras (GPT2_ML)</a></h1>
<p>By 苏剑林 | March 16, 2020</p>

<p>A while ago, I noticed that an expert open-sourced a Chinese GPT2 model. It is the largest version with 1.5 billion parameters. Looking at the demo provided by the author, the generation effect is quite impressive. I thought about loading it into my <a href="https://github.com/bojone/bert4keras">bert4keras</a> to play with it. However, the overall architecture of early bert4keras was written quite "rigidly," making it very inconvenient to integrate multiple different models. Two weeks ago, I finally couldn't stand it anymore and rewrote the overall structure of bert4keras. Now, bert4keras can be considered relatively flexible for writing various Transformer-based models, such as <strong>GPT2</strong> and <strong>T5</strong>, which have already been integrated.</p>

<h2>GPT2 Brief Introduction</h2>
<p>GPT is something many readers have likely heard of. Simply put, it is a language model based on the Transformer structure, originating from the paper <a href="https://s3-us-west-2.amazonaws.com/openai-assets/research-covers/language-unsupervised/language_understanding_paper.pdf">"GPT: Improving Language Understanding by Generative Pre-Training"</a>. However, it wasn't created just to be a language model; it uses the language model to pre-train itself and then fine-tunes on downstream tasks to improve performance. It is a pioneer of the "Transformer + Pre-training + Fine-tuning" paradigm. In comparison, BERT could be considered its "junior." GPT2, on the other hand, is the upgraded version of GPT—larger model, more training data—with the largest version reaching 1.5 billion parameters.</p>

<h2>Chinese Version</h2>
<p>Most readers who have seen promotional articles for GPT2 have been amazed by its generation capabilities. However, no matter how good it is, it's someone else's language; OpenAI did not help train a Chinese version. But the good news is that a project called <a href="https://github.com/imcaspar/gpt2-ml">GPT2_ML</a> has open-sourced a Chinese version of GPT2, and it is the largest 1.5 billion parameter scale model.</p>

<p>Currently, the GPT2 integrated into bert4keras is precisely the one provided by the GPT2_ML project, not the OpenAI version, as bert4keras prioritizes Chinese language services. It is worth noting that the model structure of GPT2_ML is not the same as the OpenAI version of GPT2, nor is it the same as the BERT structure. The comparison of the three blocks is as follows:</p>

<p>
  <a href="https://kexue.fm/usr/uploads/2020/03/2257367993.png"><img src="https://kexue.fm/usr/uploads/2020/03/2257367993.png" alt="Official GPT2 Block Diagram" title="Official GPT2 Block Diagram" /></a>
  <br />Official GPT2 Block Diagram
</p>

<p>
  <a href="https://kexue.fm/usr/uploads/2020/03/3372936810.png"><img src="https://kexue.fm/usr/uploads/2020/03/3372936810.png" alt="BERT Block Diagram" title="BERT Block Diagram" /></a>
  <br />BERT Block Diagram
</p>

<p>
  <a href="https://kexue.fm/usr/uploads/2020/03/2373952967.png"><img src="https://kexue.fm/usr/uploads/2020/03/2373952967.png" alt="GPT2_ML Block Diagram" title="GPT2_ML Block Diagram" /></a>
  <br />GPT2_ML Block Diagram
</p>

<h2>Let's Test It</h2>
<p>First, download the model weights at the following address:</p>
<blockquote>
  <p>Link: <a href="https://pan.baidu.com/s/1OXBd16o82SpIzu57kwA8Mg">https://pan.baidu.com/s/1OXBd16o82SpIzu57kwA8Mg</a><br />
  Extraction code: q79r</p>
  <p>The main file "model.ckpt-100000.data-00000-of-00001" can also be downloaded from <a href="https://drive.google.com/file/d/1IzWpQ6I2IgfV7CldZvFJnZ9byNDZdO4n">Google Drive</a>. After downloading, please check the SHA256 of model.ckpt-100000.data-00000-of-00001 (4a6e5124df8db7ac2bdd902e6191b807a6983a7f5d09fb10ce011f9a073b183e).</p>
</blockquote>

<p>Then install bert4keras version no lower than 0.6.0 (the current latest version), and you can run the following test code (if the code below has expired due to updates, please check the latest version at <a href="https://github.com/bojone/bert4keras/blob/master/examples/basic_language_model_gpt2_ml.py">basic_language_model_gpt2_ml.py</a>):</p>

<pre><code>#! -*- coding: utf-8 -*-
# Basic test: Chinese GPT2 model
# Introduction link: https://kexue.fm/archives/7292

import numpy as np
from bert4keras.models import build_transformer_model
from bert4keras.tokenizers import Tokenizer
from bert4keras.snippets import AutoRegressiveDecoder
from bert4keras.snippets import uniout

config_path = '/root/gpt2/config.json'
checkpoint_path = '/root/gpt2/model.ckpt-100000'
dict_path = '/root/gpt2/vocab.txt'

# Establish tokenizer
tokenizer = Tokenizer(dict_path, token_start=None, token_end=None, do_lower_case=True)

# Build model and load weights
model = build_transformer_model(config_path=config_path, checkpoint_path=checkpoint_path, model='gpt2_ml')

class ArticleCompletion(AutoRegressiveDecoder):
    """Article continuation based on random sampling
    """
    @AutoRegressiveDecoder.set_rtype('probas')
    def predict(self, inputs, output_ids, step):
        token_ids = np.concatenate([inputs[0], output_ids], 1)
        return model.predict(token_ids)[:, -1]

    def generate(self, text, n=1, topk=5):
        token_ids, _ = tokenizer.encode(text)
        results = self.random_sample([token_ids], n, topk)  # Based on random sampling
        return [text + tokenizer.decode(ids) for ids in results]

article_completion = ArticleCompletion(start_id=None, end_id=511, # 511 is the Chinese period
                                       maxlen=256, minlen=128)

print(article_completion.generate(u'今天天气不错'))
</code></pre>

<p>Partial results:</p>
<blockquote>
  <p>>>> article_completion.generate(u'今天天气不错')<br />
  [u'今天天气不错，可以去跑步。昨晚看了一个关于跑步的纪录片，里面的女主讲述的是一个女孩子的成长，很励志，也很美丽。我也想跑，但是我不知道跑步要穿运动鞋，所以就买了一双运动鞋。这个纪录片是关于运动鞋的，有一集讲了一个女孩子，从小学开始就没有穿过运动鞋，到了高中才开始尝试跑步。']<br />
  (Translation: The weather is quite good today, good for a run. Last night I watched a documentary about running. The female lead talked about a girl's growth, which was very inspiring and beautiful. I also want to run, but I didn't know you needed sneakers to run, so I bought a pair. This documentary is about sneakers. One episode talked about a girl who hadn't worn sneakers since elementary school and only started trying to run in high school.)</p>
  <p>>>> article_completion.generate(u'双十一')<br />
  [u'双十一马上就要到了！你还在为双11的物流配送而担心吗？你还在为没时间去仓库取货而发愁吗？你还在为不知道怎么买到便宜货而发愁吗？你还在为买不到心仪的产品而懊恼吗？那么，双十一就来了！今天小编带你来看看这些快递，都是怎么送货的！1. 物流配送快递公司的配送，主要是由快递公司负责，快递公司负责派件，物流服务。']<br />
  (Translation: Double Eleven is almost here! Are you still worried about the logistics delivery for Double 11? Are you still worried about not having time to pick up goods from the warehouse? Are you still worried about not knowing how to buy cheap goods? Are you still annoyed that you can't buy your favorite products? Well, Double Eleven is coming! Today, the editor will take you to see how these deliveries are made! 1. Logistics delivery. The delivery of express companies is mainly handled by the express company, which is responsible for dispatching items and logistics services.)</p>
  <p>>>> article_completion.generate(u'科学空间')<br />
  [u'科学空间站科学空间站（英文：science space station），是中华人民共和国的一个空间站。该空间站是中国科学院大连物理研究所研制，主要研发和使用中国科学院大连物理研究所的核能动力空间站。科学空间站位于北京市海淀区，距离地面393米，总建筑面积约为1万平方米，总投资约为5亿元人民币。科学空间站于2018年12月26日开始动工，2021年6月建成并投入使用。']<br />
  (Translation: Scientific Space Station (English: science space station) is a space station of the People's Republic of China. This space station was developed by the Dalian Institute of Chemical Physics, Chinese Academy of Sciences (CAS), mainly for researching and using the nuclear-powered space station of the Dalian Institute of Chemical Physics, CAS. The Scientific Space Station is located in Haidian District, Beijing, 393 meters above the ground, with a total construction area of about 10,000 square meters and a total investment of about 500 million RMB. Construction of the Scientific Space Station began on December 26, 2018, and it was completed and put into use in June 2021.)</p>
</blockquote>

<p>Doesn't it feel quite good?</p>

<h2>Want to Fine-tune?</h2>
<p>Seeing this effect, many readers' first thought is probably: how can I use it for my own model? Can I fine-tune it on my own tasks?</p>

<p>Unfortunately, I have to give you a somewhat pessimistic result: I tested fine-tuning this GPT2, which has nearly 1.5 billion parameters, using the Adam optimizer on a TITAN RTX with 22G of VRAM. I found that it couldn't even run with a <code>batch_size=1</code>... Finally, I discovered that it could only be fine-tuned using the AdaFactor optimizer.</p>

<p>Regarding AdaFactor, I will have the opportunity to write an article discussing it later.</p>

<hr />
<p>
  <strong>Reproduction must include the original address of this article:</strong> <a href="https://kexue.fm/archives/7292">https://kexue.fm/archives/7292</a><br />
  </p>

<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="https://kexue.fm/archives/7292" style="color: #005fcc;">https://kexue.fm/archives/7292</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
