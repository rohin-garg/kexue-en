
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      tags: 'ams',
      packages: {'[+]': ['ams']}
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<article>
  <h1><a href="https://kexue.fm/archives/8656">From Triangle Inequality to Margin Softmax</a></h1>
  <p>By 苏剑林 | September 01, 2021</p>

  <p>In <a href="translation_5743.html">"A Sentence Similarity Model Based on GRU and AM-Softmax,"</a> we introduced AM-Softmax, a version of Softmax with a margin, which is typically used in scenarios where classification is used for retrieval. At that time, we briefly mentioned through illustrations that the introduction of a margin is due to the "inequivalence between classification and ranking," but we did not provide a relatively quantitative explanation for the source of this inequivalence.</p>

  <p>In this article, we revisit this topic to derive and understand the necessity of a margin from the perspective of the triangle inequality for distances.</p>

  <h2>Triangle Inequality</h2>
  <p>Usually, when we speak of distance, we generally refer to the intuitive "Euclidean distance." However, in mathematics, distance is also called a "metric," and it has a refined axiomatic definition. It is defined as a binary function $d(x,y)$ on a set that satisfies:</p>

  <blockquote>
    <p>1. Non-negativity: $d(x,y) \geq 0$;<br>
    2. Identity: $d(x,y)=0 \Leftrightarrow x = y$;<br>
    3. Symmetry: $d(x,y)=d(y,x)$;<br>
    4. Triangle Inequality: $d(x,y) \leq d(x,z) + d(z,y)$.</p>
  </blockquote>

  <p>As the name suggests, distance is used to measure the degree of difference between $x$ and $y$. Theoretically, as long as the first two requirements are met, it can be used to measure differences; for example, the commonly used KL divergence in probability satisfies only the first two points. The inclusion of the 3rd and 4th points is essentially to make the distance defined in this way closer to our common Euclidean distance. For instance, symmetry reflects that "distance has no direction," and the triangle inequality reflects that "the shortest distance between two points is a straight line." These analogies allow us to think about more general distances through comparisons with Euclidean distance.</p>

  <p>From this definition, deep learning rarely encounters distances that satisfy all four requirements. For example, standard classification directly uses the inner product plus Softmax, where the inner product only satisfies the 3rd point; cosine distance $1-\cos(x,y)$ also only satisfies points 1 and 3, but not 2 and 4 (if we consider all vectors in the same direction as equal, then it could be said to satisfy point 2).</p>

  <p>However, we can slightly tweak the definition of certain functions to make them metrics. For example, we know that Euclidean distance satisfies the triangle inequality, so:</p>

  \begin{equation}\left\Vert \frac{x}{\Vert x\Vert} - \frac{y}{\Vert y\Vert}\right\Vert = \sqrt{2 - 2\cos(x,y)}\end{equation}

  <p>must also satisfy the triangle inequality. Therefore, while cosine distance $1-\cos(x,y)$ does not satisfy the triangle inequality, changing it to $\sqrt{1-\cos(x,y)}$ makes it satisfy it.</p>

  <h2>Classification and Ranking</h2>
  <p>In scenarios such as face recognition or sentence similarity, we use features for ranking during the prediction phase. We naturally hope that by taking any sample, we can retrieve all samples of the same class, which requires "intra-class variance to be smaller than inter-class variance." However, if we train this as a classification task, we might not achieve this goal because the objective of a classification task is "to be closest to the center of its own class." A specific example can be seen in the figure below:</p>

  <p>
    <a href="https://kexue.fm/usr/uploads/2018/07/1244905522.png">
      <img src="https://kexue.fm/usr/uploads/2018/07/1244905522.png" alt="A possible classification result, where red dots represent class centers and other dots represent samples" title="Click to view original image">
    </a>
    <br>
    <em>A possible classification result, where red dots represent class centers and other dots represent samples</em>
  </p>

  <p>In this figure, $z_1, z_3$ belong to class $c_1$, and $z_2$ belongs to class $c_2$. From a classification perspective, $d(z_1, c_1) < d(z_1, c_2)$ and $d(z_2, c_2) < d(z_2, c_1)$, so the classification is correct. However, $d(z_1, z_2) < d(z_1, z_3)$, so if we use $z_1$ for retrieval, we find $z_2$ of a different class instead of $z_3$ of the same class.</p>

  <p>We can use the triangle inequality to describe this inequality more quantitatively: we want to achieve $d(z_1, z_3) < d(z_1, z_2)$. According to the triangle inequality, $d(z_1,z_3) \leq d(z_1, c_1) + d(z_3, c_1)$, so a <strong>sufficient</strong> condition is:</p>

  \begin{equation}d(z_1, c_1) + d(z_3, c_1) < d(z_1, z_2) \end{equation}

  <p>Adding $d(z_2, c_2)$ to both sides and using the triangle inequality $d(z_1, z_2) + d(z_2, c_2) \geq d(z_1, c_2)$, we obtain a <strong>sufficient</strong> condition for the above equation:</p>

  \begin{equation}d(z_1, c_1) + d(z_3, c_1) + d(z_2, c_2) < d(z_1, c_2) \end{equation}

  <p>Note that the classification task only requires $d(z_1, c_1) < d(z_1, c_2)$ for $z_1$, whereas the equation above has the extra terms $d(z_3, c_1) + d(z_2, c_2)$. These extra terms are the margin terms.</p>

  <p>Notice that $d(z_3, c_1)$ and $d(z_2, c_2)$ are the distances from samples $z_3$ and $z_2$ to their respective class centers. We can consider $d(z_3, c_1) + d(z_2, c_2)$ as the "average class diameter," which should be close to a constant $m$ that we can tune as a hyperparameter. If adaptive adjustment is desired, one could consider training with $m=0$ for a period, then estimating the "average class diameter" to use as $m$ for further training, re-estimating $m$, and so on.</p>

  <h2>AM-Softmax</h2>
  <p>Through the derivation above, we know that to ensure the features of a classification model can be used for ranking, each sample must not only be closest to its class center, but also remain closest to the class center even after adding $m$ to the distance. That is, if $z_1$ belongs to class $c_1$, then we require:</p>

  \begin{equation}\begin{aligned}
  d(z_1, c_1) +&\, m < d(z_1, c_2) \\
  d(z_1, c_1) +&\, m < d(z_1, c_3) \\
  &\vdots \\
  d(z_1, c_1) +&\, m < d(z_1, c_k)
  \end{aligned}\end{equation}

  <p>Following the logic in <a href="translation_7359.html">"Generalizing 'Softmax + Cross Entropy' to Multi-label Classification,"</a> whenever we want $s_i < s_j$, we can construct a loss by adding $e^{s_i - s_j}$ inside a $\log$. Thus, we can construct the following loss:</p>

  \begin{equation}\log\left(1+\sum_{i=2}^k e^{s\cdot[d(z_1, c_1) + m - d(z_1, c_i)]}\right)\end{equation}

  <p>This is the cross-entropy with an additive margin, where $s$ is the scaling ratio, equivalent to the temperature parameter in Softmax.</p>

  <p>However, do not forget that the derivation above assumes that $d$ satisfies the triangle inequality, while the scoring functions we usually use might not. When training retrieval models, we typically use cosine distance for scoring. As mentioned earlier, cosine distance can satisfy the triangle inequality by taking the square root. Therefore, the requirements become (using $i=2$ as an example):</p>

  \begin{equation}\begin{array}{c}
  \sqrt{1-\cos(z_1, c_1)} + m < \sqrt{1-\cos(z_1, c_2)}\\
  \Downarrow\\
  \sqrt{1-\cos(z_1, c_2)} - \sqrt{1-\cos(z_1, c_1)} > m \\
  \end{array}\end{equation}

  <p>Multiplying both sides by $\sqrt{1-\cos(z_1, c_2)} + \sqrt{1-\cos(z_1, c_1)}$, we get:</p>

  \begin{equation}\cos(z_1, c_1) - \cos(z_1, c_2) > m\left(\sqrt{1-\cos(z_1, c_2)} + \sqrt{1-\cos(z_1, c_1)}\right)\end{equation}

  <p>Clearly, the right-hand side is bounded. Therefore, by appropriately adjusting $m$, we can make:</p>

  \begin{equation}\cos(z_1, c_1) - \cos(z_1, c_2) > m\end{equation}

  <p>a sufficient condition. In this case, the corresponding margin cross-entropy is:</p>

  \begin{equation}\log\left(1+\sum_{i=2}^k e^{s\cdot[\cos(z_1, c_i) + m - \cos(z_1, c_1)]}\right)\end{equation}

  <p>This is <a href="https://papers.cool/arxiv/1801.05599">AM-Softmax</a>.</p>

  <h2>Review and Summary</h2>
  <p>This article derives the necessity of a margin when using a classification model for ranking tasks from the perspective of the triangle inequality. Assuming the scoring function used satisfies the triangle inequality, relevant results can be derived quite naturally.</p>
</article>
<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="https://kexue.fm/archives/8656" style="color: #005fcc;">https://kexue.fm/archives/8656</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
