
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    tags: 'ams',
    packages: {'[+]': ['base', 'ams', 'noerrors', 'noundefined']}
  },
  loader: {load: ['[tex]/ams']}
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<h1><a href="https://kexue.fm/archives/10332">A Near-Perfect Solution to the Conflict between MathJax and Marked</a></h1>

<p>By 苏剑林 | August 26, 2024</p>

<p>In <a href="translation_10320.html">"Making MathJax Better Compatible with Google Translate and Lazy Loading,"</a> we mentioned that <a href="https://papers.cool/">Cool Papers</a> added MathJax to parse LaTeX formulas. However, it was unexpected that this would trigger many compatibility issues. While some problems were purely the result of the author's obsessive-compulsive tendencies, a solution that is as perfect as possible is ultimately gratifying. Therefore, I am willing to spend a little more thought on it.</p>

<p>In the previous article, we resolved the compatibility between MathJax, Google Translate, and lazy loading. In this article, we will resolve the conflict between MathJax and Marked.</p>

<h2>Problem Description <a id="problem-description" href="https://kexue.fm/archives/10332#%E9%97%AE%E9%A2%98%E7%AE%80%E8%BF%B0">#</a></h2>

<p>Markdown is a lightweight markup language that allows people to write documents in an easy-to-read, easy-to-write plain text format. It is arguably one of the most popular writing syntaxes today. The [Kimi] function in Cool Papers also essentially outputs according to Markdown syntax. However, Markdown is not a language directly intended for browsers; the language for browsers is HTML. Therefore, there is a process of converting Markdown to HTML (rendering) before displaying it to users.</p>

<p>Markdown-to-HTML conversion is generally divided into two types: one where a server-side backend converts Markdown into HTML and sends it to the user, and another where the user receives Markdown and converts it to HTML in the frontend via the browser. The examples in this article are mainly for the latter, but in principle, the same logic should be easily adaptable for the former. There are many libraries for Markdown conversion in the frontend; Cool Papers uses <a href="https://github.com/markedjs/marked">Marked</a>, which is a relatively lightweight choice.</p>

<p>The method for rendering Markdown with Marked is simple: just call <code>marked.parse</code> on the string. At this point, combined with <a href="https://kexue.fm/archives/10320#%E5%85%AC%E5%BC%8F%E6%B8%B2%E6%9F%93">MathJax</a> introduced in the previous section, LaTeX code can be parsed. However, Markdown and LaTeX share some overlapping syntax. Consequently, Marked might first transform the LaTeX code (if any) according to Markdown rules, so the subsequent MathJax cannot obtain the original LaTeX code, leading to rendering failure.</p>

<p>A reproducible code snippet is as follows:</p>

<pre><code class="language-html">&lt;div id="content"&gt;Loading...&lt;/div&gt;

&lt;script src="marked.min.js"&gt;&lt;/script&gt;
&lt;script src="MathJax.js?config=TeX-AMS_HTML"&gt;&lt;/script&gt;
&lt;script&gt;
var md_text = "Standard LaTeX: $f(x) = x^2$. Problematic LaTeX: $x_{1,2} = \frac{-b \pm \sqrt{b^2-4ac}}{2a}$ and double backslash \\\\.";
// Rendered by Marked first
document.getElementById('content').innerHTML = marked.parse(md_text);
// Then handled by MathJax
MathJax.Hub.Queue(["Typeset", MathJax.Hub, "content"]);
&lt;/script&gt;
</code></pre>

<h2>Existing Solutions <a id="existing-solutions" href="https://kexue.fm/archives/10332#%E5%B7%B2%E6%9C%89%E6%96%B9%E6%A1%88">#</a></h2>

<p>It is worth mentioning that the popular blog framework Hexo also uses Marked by default to render Markdown. Therefore, if we search for "MathJax Marked conflict," we can find quite a bit of materials, most of which are based on Hexo. One detailed summary is <a href="https://www.lizhechen.com/2017/03/08/Hexo%E4%B8%8EMathjax%E7%9A%84%E5%86%B2%E7%AA%81%E5%8F%8A%EF%BC%88%E9%83%A8%E5%88%86%EF%BC%89%E8%A7%A3%E5%86%B3/">"Tuning Hexo [2] — Conflicts and Solutions between Hexo and MathJax"</a>, which summarizes the approaches into four types:</p>

<blockquote>
<p>1. <strong>Manual Escaping</strong>: Do not write valid LaTeX code when writing formulas; instead, write LaTeX code that "becomes correct after being rendered by Marked." For example, if the original LaTeX code uses double backslashes <code>\\</code>, it becomes a single backslash <code>\</code> after Marked. Thus, you would write four backslashes <code>\\\\</code> from the start, which becomes <code>\\</code> after Marked.</p>
<p>2. <strong>Formula Protection</strong>: This logic is simpler. Utilize the fact that Marked does not render code blocks to protect the formula with code tags. After Marked rendering, extract the formula and parse it with MathJax. For example, <a href="https://liam0205.me/2015/09/09/fix-conflict-between-mathjax-and-markdown/">"Solving the Conflict between MathJax and Markdown"</a>. The downside is it easily conflicts with normal code blocks.</p>
<p>3. <strong>Changing Engines</strong>: Switch to a rendering engine that better supports the mixture of Markdown and LaTeX, such as Pandoc, which is commonly recommended under Hexo. See <a href="https://piggerzzm.github.io/2019/04/22/%E8%A7%A3%E5%86%B3Hexo%E5%92%8CMathjax%E7%9A%84%E5%86%B2%E7%AA%81/">"Solving the Conflict between Hexo and MathJax"</a>. However, Pandoc is a backend engine, and the author has not found a better frontend alternative.</p>
<p>4. <strong>Modifying the Engine</strong>: Modify the Marked code so that it does not render certain LaTeX patterns, thereby solving the problem to some extent, as in <a href="https://qinjiangbo.com/solution-to-coexistance-of-markerjs-and-mathjax.html">"Marked.js and MathJax Coexistence Issue in Hexo"</a>. This requires us to summarize rules prone to mis-rendering by Marked and handle them one by one.</p>
</blockquote>

<p>Solutions 1 and 2 require manual modification of formula code, but since the formulas in Cool Papers are generated by Kimi, they cannot be modified; thus, these are basically ruled out. Since I haven't found a better frontend Markdown engine, solution 3 was also rejected. While solution 4 can solve the problem to a degree, it is too rule-based, insufficiently elegant, and essentially "treating the symptoms but not the disease," with no way to know if there are still unhandled rules.</p>

<h2>Reverse Thinking <a id="reverse-thinking" href="https://kexue.fm/archives/10332#%E9%80%86%E5%90%91%E6%80%9D%E8%B7%AF">#</a></h2>

<p>In fact, there is a very simple solution to this problem: essentially, the conflict arises from running Marked before MathJax. What if we reverse it: use MathJax to render the formulas first, and then use Marked to render the Markdown? Because MathJax can identify mathematical formulas quite strictly and the rendering result almost never contains Markdown syntax, running MathJax before Marked can fundamentally solve the conflict.</p>

<p>Reference code is as follows:</p>

<pre><code class="language-html">&lt;div id="content"&gt;Loading...&lt;/div&gt;

&lt;script&gt;
var md_text = "..."; // Markdown text with LaTeX
var content = document.getElementById('content');
content.innerHTML = md_text;
// Run MathJax first
MathJax.Hub.Queue(["Typeset", MathJax.Hub, "content"], function() {
    // After MathJax is done, run Marked
    content.innerHTML = marked.parse(content.innerHTML);
});
&lt;/script&gt;
</code></pre>

<h2>Perfectionist Tendencies <a id="perfectionist-tendencies" href="https://kexue.fm/archives/10332#%E5%BC%BA%E8%BF%AB%E4%B9%8B%E7%97%87">#</a></h2>

<p>The final display effect of the above code is exactly what we expect, but for readers with perfectionist tendencies, there are still two minor flaws.</p>

<p>The first flaw is that it initially displays the raw Markdown text, and only after a short delay (depending on rendering speed) does it show the final rendered effect. Note that raw Markdown output directly to the browser looks nearly like gibberish. Users see a chaotic page first, which affects the reading experience. To address this, we can create another element to handle the rendering and only assign it to the current page after rendering is complete:</p>

<pre><code class="language-html">&lt;div id="content"&gt;Loading...&lt;/div&gt;
&lt;div id="hidden_content" style="display:none"&gt;&lt;/div&gt;

&lt;script&gt;
var md_text = "...";
var hidden = document.getElementById('hidden_content');
hidden.innerHTML = md_text;
MathJax.Hub.Queue(["Typeset", MathJax.Hub, "hidden_content"], function() {
    document.getElementById('content').innerHTML = marked.parse(hidden.innerHTML);
});
&lt;/script&gt;
</code></pre>

<p>This way, users see the rendered effect directly, without transitional gibberish. The second flaw is that if you right-click the formula now, you will notice that the MathJax menu shown below does not appear:</p>

<p style="text-align:center;">
    <a href="https://kexue.fm/usr/uploads/2024/08/692170630.png">
        <img src="https://kexue.fm/usr/uploads/2024/08/692170630.png" alt="Normally, right-clicking a formula reveals the MathJax menu" title="Normally, right-clicking a formula reveals the MathJax menu" />
    </a>
    <br />
    <em>Normally, right-clicking a formula reveals the MathJax menu</em>
</p>

<p>This is easily understood once you know the principle of custom right-click menus. Simply put, a custom menu requires an event listener bound to the element, but once the element's <code>innerHTML</code> is edited, the listener becomes invalid. I thought about this for a long time and eventually discovered by chance that when we call <code>MathJax.Hub.Typeset</code> again, MathJax automatically re-renders the formulas. So, we just need to delete the original formulas based on the code above and then re-render them:</p>

<pre><code class="language-html">&lt;script&gt;
// ... (previous logic)
MathJax.Hub.Queue(["Typeset", MathJax.Hub, "hidden_content"], function() {
    document.getElementById('content').innerHTML = marked.parse(hidden.innerHTML);
    // Delete original formula cache and re-render to restore right-click menu
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, "content"]);
});
&lt;/script&gt;
</code></pre>

<p>This restores the right-click menu. But it's not over yet. I looked into the logic and found that after the first <code>Typeset</code>, the original formula code is stored in a <code>script</code> tag, which allows subsequent calls to <code>Typeset</code> for re-rendering. However, I discovered that Marked actually renders the content inside <code>script</code> tags!! To prevent Marked from modifying the formulas, we can save the original code of the formula before <code>marked.parse</code> and overwrite it back after <code>marked.parse</code>:</p>

<pre><code class="language-html">&lt;script&gt;
// ... (previous logic)
MathJax.Hub.Queue(["Typeset", MathJax.Hub, "hidden_content"], function() {
    var scripts = hidden.getElementsByTagName('script');
    var script_codes = [];
    for (var i = 0; i &lt; scripts.length; i++) {
        script_codes.push(scripts[i].innerHTML);
    }
    
    document.getElementById('content').innerHTML = marked.parse(hidden.innerHTML);
    
    var new_scripts = document.getElementById('content').getElementsByTagName('script');
    for (var i = 0; i &lt; new_scripts.length; i++) {
        new_scripts[i].innerHTML = script_codes[i];
    }
    
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, "content"]);
});
&lt;/script&gt;
</code></pre>
<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="translation_10332.html" style="color: #005fcc;">https://kexue.fm/archives/10332</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
