
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    tags: 'ams',
    packages: {'[+]': ['ams']}
  },
  options: {
    renderActions: {
      findScript: [10, function (doc) {
        for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
          const display = !!node.type.match(/; *mode=display/);
          const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
          const text = document.createTextNode('');
          node.parentNode.replaceChild(text, node);
          math.start = {node: text, delim: '', n: 0};
          math.end = {node: text, delim: '', n: 0};
          doc.math.push(math);
        }
      }, '']
    }
  }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<h1><a href="https://kexue.fm/archives/9588">Entropy-Invariant Attention from the Perspective of the JL Lemma</a></h1>

<p>By 苏剑林 | April 10, 2023</p>

<p>In the articles <a href="translation_8823.html">"Entropy Invariance: Looking at the Scaling Operation of Attention"</a> and <a href="translation_9034.html">"A Fast Derivation of Entropy-Invariant Softmax,"</a> the author proposed Entropy-Invariant Softmax. Simply put, this involves multiplying the Attention matrix before Softmax by an additional factor of $\log n$, which theoretically helps improve length extrapolation, where $n$ is the sequence length. This $\log n$ factor reminded me of the JL Lemma (<a href="translation_8679.html">Johnson-Lindenstrauss Lemma</a>). Since the JL Lemma tells us that encoding $n$ vectors only requires a dimension of $\mathcal{O}(\log n)$, and both involve $\log n$, is there a connection between the two?</p>

<h2>Entropy Invariance</h2>

<p>We know that entropy is a measure of uncertainty. In the attention mechanism, we use it as the "degree of focused attention." So-called entropy invariance means that regardless of the sequence length $n$, we want the attention to remain concentrated on a few key tokens rather than becoming too dispersed. To this end, the proposed form of Entropy-Invariant Attention is:</p>

\begin{equation}Attention(Q,K,V) = softmax\left(\frac{\log_{512} n}{\sqrt{d}}QK^{\top}\right)V\label{eq:core}\end{equation}

<p>Here $Q,K \in \mathbb{R}^{n \times d}$. Compared to conventional Attention, the scaling factor includes an extra $\log_{512} n$, where the base is taken as 512, assuming that all our hyperparameters (such as $d$) are tuned for a training length of 512. Of course, even if your planned pre-training length is not 512, you can take the base as 512 without much consequence; the results will remain largely unaffected.</p>

<p>The principle behind this form is quite intuitive. When $n$ increases, it means there are more tokens to "dilute" the attention, resulting in less focused attention. At this point, we multiply by a factor that is monotonically increasing with respect to $n$. After Softmax, this is equivalent to a power operation on the original probabilities. Since probabilities are less than 1, smaller probabilities become even smaller after the power operation, thus making the attention concentrated again. As for why this factor takes a logarithmic form, one would need to refer to the derivation process in the articles mentioned at the beginning.</p>

<h2>JL Lemma</h2>

<p>The JL Lemma, full name "Johnson-Lindenstrauss Lemma," is an important conclusion regarding vector embedding. Simply put, it tells us that "to fit $n$ vectors, only $\mathcal{O}(\log n)$ dimensions are needed" (here $\log$ denotes the natural logarithm with base $e$ by default). For a detailed introduction, please refer to <a href="translation_8679.html">"The Amazing Johnson-Lindenstrauss Lemma: Theory Edition."</a></p>

<p>Interestingly, even before I knew about the JL Lemma, I had derived a similar, and perhaps even more specific result in <a href="translation_7695.html">"The Principle of Minimum Entropy (VI): How to Choose the Dimension of Word Vectors?"</a>—namely, that embedding $n$ word vectors requires roughly $8 \log n$ dimensions. This estimation is very close to the dimensions used in practice. For example, when $n$ equals 100,000, $8 \log n$ calculates to approximately 92, and the word vector dimensions we frequently use are on the order of one or two hundred.</p>

<p>Additionally, the JL Lemma can be used to explain the multi-head nature of the attention mechanism. If we substitute $n=512$, then $8 \log n \approx 50$, which is very close to the projection dimensions commonly used for $Q$ and $K$ in Attention (i.e., the <code>key_size</code>, which is 64 in BERT; see <a href="https://kexue.fm/archives/7325#Attention%E9%87%8C%E6%9C%89%E4%B8%AA%E7%93%B6%E9%A2%88">here</a>). This tells us that if the sequence length is 512, then the dimension for calculating Attention $Q$ and $K$ at the level of 50 is sufficient; there is no need to use the full <code>hidden_size</code> (BERT base is 768). The saved dimensions can instead be used for multi-head attention.</p>

<p>For more related discussions, please refer to <a href="translation_8711.html">"Availability Analysis of the Dimension Formula 'n > 8.33 log N'"</a> and <a href="translation_8706.html">"The Amazing Johnson-Lindenstrauss Lemma: Application Edition."</a></p>

<h2>Connecting Them</h2>

<p>Now, we can attempt to connect the JL Lemma with Entropy-Invariant Attention.</p>

<p>Let the <code>key_size</code> of $Q$ and $K$ be $d$. The JL Lemma tells us that the optimal choice for $d$ should be $d_n = \lambda \log n$, where $\lambda$ is a proportionality constant whose specific value is not important. That is to say, ideally, $d$ should change as $n$ changes. However, it is obvious that such a design is not easy to implement and is not conducive to computational parallelization. Therefore, in practice, we can only use a fixed $d$.</p>

<p>Assuming we have selected a fixed $d$ and that this $d$ is designed for a training length of 512, we can conclude that $d = \lambda \log 512$, which means $\lambda = \frac{d}{\log 512}$, and:</p>

\begin{equation}d_n = \frac{d}{\log 512}\log n=d\log_{512} n\end{equation}

<p>For $n \neq 512$, ideally, a projection dimension of $d_n$ should be used. But in practice, $d$ dimensions are used. According to the definition of the inner product $\langle q,k\rangle = \sum_{i=1}^d q_i k_i$, the number of terms in the sum is exactly equal to the dimension $d$. That is, in the ideal case, there should be a sum of $d_n$ terms, but in reality, it becomes a sum of $d$ terms. Intuitively, then, if the contribution of each term is similar, multiplying the result by $\frac{d_n}{d}$ will make the result closer to the ideal case of a $d_n$-term sum. Therefore, we conclude that we should multiply $\langle q,k\rangle$ by the factor:</p>

\begin{equation}\frac{d_n}{d} = \log_{512} n\end{equation}

<p>to compensate for the gap between the actual and ideal situations. When conventional Scaled-Dot Attention is multiplied by $\log_{512} n$, it yields exactly the Entropy-Invariant Attention shown in equation $\eqref{eq:core}$.</p>

<p>In this way, we have linked the JL Lemma to Entropy-Invariant Attention. Note that this is only an intuitive, qualitative understanding process; it is difficult to further formalize it strictly from a quantitative perspective. In fact, there is no need for further quantification, as the JL Lemma itself is more of a qualitative conclusion.</p>

<h2>Summary</h2>

<p>This article constructs a simple connection between the JL Lemma and Entropy-Invariant Attention.</p>
<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="https://kexue.fm/archives/9588" style="color: #005fcc;">https://kexue.fm/archives/9588</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
