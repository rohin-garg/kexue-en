
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\]']],
    tags: 'ams',
    packages: {'[+]': ['ams', 'extpfeil']}
  },
  options: {
    renderActions: {
      findScript: [10, function (doc) {
        for (const node of document.querySelectorAll('script[type^="text/x-mathjax-config"]')) {
          const content = node.text;
          if (content.match(/MathJax\.Hub\.Config/)) {
            // This is a legacy v2 config, we handle the intent in v3 config above
          }
        }
      }, '']
    }
  }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<h1><a href="https://kexue.fm/archives/10320">Making MathJax Better Compatible with Google Translate and Lazy Loading</a></h1>

    <p>By 苏剑林 | August 15, 2024</p>


<p>A long time ago, readers suggested rendering the mathematical formulas on Cool Papers. Many math-heavy papers have abstracts or even titles containing LaTeX code. If these formulas aren't rendered, they look like a jumble of garbled code, which significantly impacts the reading experience. However, previous tests showed that MathJax, the library responsible for rendering formulas, was quite incompatible with Google Translate and lazy loading. Consequently, despite the long-standing demand, I hadn't implemented it. But there’s good news: after repeated research and debugging over the past few days, I have finally resolved the compatibility issues. Cool Papers can now render mathematical formulas. This article summarizes the solution for your reference.</p>

<h2>Formula Rendering</h2>

<p>For displaying mathematical formulas (LaTeX) on web pages, there are currently two mainstream solutions: MathJax and KaTeX. KaTeX is relatively more lightweight, but its support for LaTeX is not as comprehensive as MathJax. Furthermore, since this blog has always used MathJax, it was my first choice when considering adding math formula support to Cool Papers.</p>

<p>Similar to Python, MathJax 3.x and 2.x are two significantly different systems (the latest version is 3.2.2, and version 4.0 is already in testing). However, most MathJax-related materials searchable today are for version 2.x. Therefore, I implemented the latest 2.x version, 2.7.9, on Cool Papers (which is also the version used by this blog; specifically, the official arXiv website also uses MathJax, version 2.7.3).</p>

<p>For an ordinary webpage, adding math formula rendering is not difficult. You just need to add two segments of code. The following is the reference code used by this blog:</p>

<pre><code>&lt;script type="text/x-mathjax-config"&gt;
 MathJax.Hub.Config({
 tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
 TeX: {equationNumbers: {autoNumber: ["AMS"], useLabelIds: true}, extensions: ["AMSmath.js", "AMSsymbols.js", "extpfeil.js"]},
 "HTML-CSS": {linebreaks: {automatic: true, width: "95% container"}, noReflows: false, availableFonts: ["tex"], styles: {".MathJax_Display": {margin: "1em 0em 0.7em;", display: "inline-block!important;"}}},
 "CommonHTML": {linebreaks: {automatic: true, width: "95% container"}, noReflows: false, availableFonts: ["tex"], styles: {".MJXc-display": {margin: "1em 0em 0.7em;", display: "inline-block!important;"}}},
 "SVG": {linebreaks: {automatic: true, width: "95% container"}, styles: {".MathJax_SVG_Display": {margin: "1em 0em 0.7em;", display: "inline-block!important;"}}},
 "PreviewHTML": {linebreaks: {automatic: true, width: "95% container"}}
 });
&lt;/script&gt;
&lt;script src="/static/MathJax-2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"&gt;&lt;/script&gt;</code></pre>

<h2>The Bane of Translation</h2>

<p>The code above is effective for ordinary needs and can successfully convert LaTeX code into displayable mathematical formulas. But for Cool Papers, it encountered two "roadblocks": web translation and lazy loading. In this section, we first solve the first roadblock—web translation, specifically referring to the Google Translate feature built into the Chrome browser.</p>

<p>As everyone knows, the main purpose of Cool Papers is to browse papers. The titles and abstracts of the papers are in English. For those of us whose native language is Chinese, we often turn on the web translation function to speed up reading. Although some readers might "look down" on this, believing that reading the original English descriptions is more accurate, it is undeniable that the demand for web translation exists. For the goal of "browsing papers," machine-translated Chinese content is often sufficient.</p>

<p>However, for pages containing mathematical formulas rendered via MathJax, the result after Google Translate is "unrecognizable," nearly garbled to the point of being unreadable. Readers can go to arXiv and find a paper with formulas to try it out, such as the result for <a href="https://arxiv.org/abs/2408.07010">2408.07010</a>:</p>

<p>[Effect of a page with formulas before translation]<br>
[Effect of a page with formulas after translation]</p>

<h2>Exemption Pass</h2>

<p>The idea to solve this problem is to give the formulas an "exemption pass"—that is, do not translate the formulas. After searching, I found two ways to prevent Google Translate from translating a certain element: one is to add a class name <code>class="notranslate"</code> to the element, and the other is to add an attribute <code>translate="no"</code>. There are two ways to add these: one is on the backend, modifying the webpage content before the server outputs it; the other is on the frontend, using JS to modify it after the browser receives the content.</p>

<p>For MathJax, mathematical formulas are rendered in real-time on the frontend. The backend cannot access the rendered formulas, so we can only choose the frontend modification plan. Testing showed that MathJax adds a <code>MathJax</code> class name to rendered formulas. Therefore, we can extract all formulas based on that class name and then append <code>class="notranslate"</code> via JS. The reference code is as follows:</p>

<pre><code>document.querySelectorAll('.MathJax').forEach(element =&gt; element.classList.add('notranslate'));</code></pre>

<p>However, note that this line of code must be executed after all mathematical formulas have finished rendering to be effective. How can we ensure the formulas have finished rendering? The most reliable solution is to place this code in MathJax's Queue (refer to <a href="https://docs.mathjax.org/en/v2.7-latest/advanced/queues.html">here</a>):</p>

<pre><code>&lt;script type="text/x-mathjax-config"&gt;
 MathJax.Hub.Config({
 tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
 TeX: {equationNumbers: {autoNumber: ["AMS"], useLabelIds: true}, extensions: ["AMSmath.js", "AMSsymbols.js", "extpfeil.js"]},
 "HTML-CSS": {linebreaks: {automatic: true, width: "95% container"}, noReflows: false, availableFonts: ["tex"], styles: {".MathJax_Display": {margin: "1em 0em 0.7em;", display: "inline-block!important;"}}},
 "CommonHTML": {linebreaks: {automatic: true, width: "95% container"}, noReflows: false, availableFonts: ["tex"], styles: {".MJXc-display": {margin: "1em 0em 0.7em;", display: "inline-block!important;"}}},
 "SVG": {linebreaks: {automatic: true, width: "95% container"}, styles: {".MathJax_SVG_Display": {margin: "1em 0em 0.7em;", display: "inline-block!important;"}}},
 "PreviewHTML": {linebreaks: {automatic: true, width: "95% container"}}
 });
 MathJax.Hub.Queue(function() {
 document.querySelectorAll('.MathJax').forEach(element =&gt; element.classList.add('notranslate'));
 });
&lt;/script&gt;
&lt;script src="/static/MathJax-2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"&gt;&lt;/script&gt;</code></pre>

<p>This tells MathJax to execute the function defined in <code>MathJax.Hub.Queue</code> after it ensures the formulas are rendered. With this processing, if you turn on Google Translate after the formulas are rendered, the formulas will not be translated.</p>

<h2>Lazy Loading</h2>

<p>The second "roadblock" for MathJax is lazy loading. In the list page of Cool Papers, because there may be many papers to display (hundreds or even thousands), it doesn't load all papers at once when the page is first opened. Instead, it only displays the first 25. Only when you slide near the bottom does it continue to load the next 25. This improves response speed and barely affects user experience. This is lazy loading.</p>

<p>Many content-heavy websites use lazy loading; it is a mature technology. However, MathJax only renders the formulas present when the page is initially opened. Formulas in content loaded via lazy loading later will not be actively rendered. Therefore, we need to manually trigger rendering after lazy loading. This is not difficult; the function to manually trigger rendering is <code>MathJax.Hub.Typeset</code>. We just need to add this function after the lazy loading function, similar to:</p>

<pre><code>loadMorePapers();
MathJax.Hub.Typeset();</code></pre>

<p>Note that simple <code>MathJax.Hub.Typeset</code> does not include adding <code>notranslate</code> to the formulas. To include that operation, it needs to be changed to:</p>

<pre><code>loadMorePapers();
MathJax.Hub.Queue(
 ['Typeset', MathJax.Hub],
 function() {
 document.querySelectorAll('.MathJax').forEach(element =&gt; element.classList.add('notranslate'));
 }
);</code></pre>

<h2>Hybrid Woes</h2>

<p>Above, we separately solved the compatibility issues between MathJax and Google Translate, and lazy loading. However, when Google Translate and lazy loading appear together, a new problem arises.</p>

<p>Suppose we turn on Google Translate as soon as we enter the page. When we browse near the bottom, new papers are lazy-loaded, and then Google Translate is triggered again, subsequently translating the newly loaded papers. If we also set up the manual rendering code from the previous section, the formulas will also be rendered by MathJax. Since Google Translate and MathJax are triggered simultaneously, but <code>notranslate</code> is only added after the formulas are rendered, the translation starts before the formulas have had time to get the <code>notranslate</code> class. Consequently, the formulas still end up being translated.</p>

<p>To solve this problem, we must find a way to ensure that Google Translate is executed only after the formulas are rendered and <code>notranslate</code> has been added. However, Google Translate is built into Chrome, and we cannot manipulate the browser's behavior through the website. It seems like a dead end, but my testing found that Google Translate constantly monitors changes in the page to decide whether to trigger new translations. Based on this characteristic, we can use "reverse thinking."</p>

<p>What is this reverse approach? We know that for Cool Papers, what needs to be translated are the titles and abstracts of the papers. We can add <code>class="notranslate"</code> to them at the very beginning. Once added, Google Translate will not actively translate them, regardless of whether it's the initial view or a lazy load. Then, after the formulas are rendered, we can remove the <code>class="notranslate"</code> from the titles and abstracts. At this point, the browser will identify the titles and abstracts as translatable content, and translation will be triggered.</p>

<p>In this way, we successfully ensure that translation is only triggered after the formula rendering is complete. The reference code is as follows:</p>

<pre><code>loadMorePapers();
MathJax.Hub.Queue(
 ['Typeset', MathJax.Hub],
 function() {
 document.querySelectorAll('.MathJax').forEach(element =&gt; element.classList.add('notranslate'));
 document.querySelectorAll('a.title-link, p.summary').forEach(element =&gt; element.classList.remove('notranslate'));
 }
);</code></pre>

<h2>Summary</h2>

<p>Finally, let's summarize our solution. If your website needs to display mathematical formulas, has lazy loading functionality, and users have a demand for web translation, you can follow these steps to achieve maximum compatibility:</p>

<p>1. Add <code>class="notranslate"</code> to all content blocks containing formulas;</p>

<p>2. Load MathJax in the following way (where "a.title-link" and "p.summary" are among the class names of the blocks containing math formulas):</p>

<pre><code>&lt;script type="text/x-mathjax-config"&gt;
 MathJax.Hub.Config({
 tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
 TeX: {equationNumbers: {autoNumber: ["AMS"], useLabelIds: true}, extensions: ["AMSmath.js", "AMSsymbols.js", "extpfeil.js"]},
 "HTML-CSS": {linebreaks: {automatic: true, width: "95% container"}, noReflows: false, availableFonts: ["tex"], styles: {".MathJax_Display": {margin: "1em 0em 0.7em;", display: "inline-block!important;"}}},
 "CommonHTML": {linebreaks: {automatic: true, width: "95% container"}, noReflows: false, availableFonts: ["tex"], styles: {".MJXc-display": {margin: "1em 0em 0.7em;", display: "inline-block!important;"}}},
 "SVG": {linebreaks: {automatic: true, width: "95% container"}, styles: {".MathJax_SVG_Display": {margin: "1em 0em 0.7em;", display: "inline-block!important;"}}},
 "PreviewHTML": {linebreaks: {automatic: true, width: "95% container"}}
 });
 MathJax.Hub.Queue(function() {
 document.querySelectorAll('.MathJax').forEach(element =&gt; element.classList.add('notranslate'));
 document.querySelectorAll('a.title-link, p.summary').forEach(element =&gt; element.classList.remove('notranslate'));
 });
&lt;/script&gt;
&lt;script src="/static/MathJax-2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"&gt;&lt;/script&gt;</code></pre>

<p>3. Add the following code after the lazy loading code:</p>

<pre><code>MathJax.Hub.Queue(
 ['Typeset', MathJax.Hub],
 function() {
 document.querySelectorAll('.MathJax').forEach(element =&gt; element.classList.add('notranslate'));
 document.querySelectorAll('a.title-link, p.summary').forEach(element =&gt; element.classList.remove('notranslate'));
 }
);</code></pre>

<p>You are welcome to test the specific effects in Cool Papers. The above solution has been tested and passed by me in Chrome and Safari. it is suitable for Chrome's built-in translation, Safari's built-in translation, and Cool Papers' own translation function.</p>

<p>
Please include the address of this article when reposting: <a href="translation_10320.html">https://kexue.fm/archives/10320</a>
<br>
For more detailed information on reposting, please refer to: <a href="https://kexue.fm/faq.html">Scientific Space FAQ</a>
</p>

<p>If you have any doubts or suggestions, please feel free to continue the discussion in the comments section below.</p>

<p>If you find this article helpful, you are welcome to Share / Donate to this post. Donating is not about making a profit, but rather to know how much sincere attention Scientific Space has gained from readers. Of course, if you ignore it, it will not affect your reading. Welcome and thank you again!</p>

<p>If you need to cite this article, please refer to:</p>
<p>Su Jianlin. (Aug. 15, 2024). "Making MathJax Better Compatible with Google Translate and Lazy Loading" [Blog post]. Retrieved from https://kexue.fm/archives/10320</p>

<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="translation_10320.html" style="color: #005fcc;">https://kexue.fm/archives/10320</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
