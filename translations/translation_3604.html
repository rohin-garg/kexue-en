
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
window.MathJax = {
  tex: {
    tags: 'ams',
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<article>
    <nav style="margin-bottom: 1.5em;">
    <a href="../index.html" style="display: inline-flex; align-items: center; color: #555; text-decoration: none; font-size: 0.95em;">
        <span style="margin-right: 0.3em;">&larr;</span> Back to Index
    </a>
</nav>

    <h1><a href="https://kexue.fm/archives/3604">Tinkering with HiWiFi on New Year's Eve: SSH Reverse Proxy</a></h1>
    <p>By 苏剑林 | February 07, 2016</p>

    <p>Happy Year of the Monkey!</p>
    <p><strong>Today is New Year's Eve. I would like to briefly wish everyone a Happy New Year's Eve and a Happy New Year! I hope everyone becomes a "study god" in the coming year. ^_^</strong></p>

    <p>I've spent the last couple of days tinkering with the router at home. Usually, only my parents are home, so to save money, we just bridge the neighbor's network to access the internet. Originally, we used a Xiaomi Router mini, but its functionality is extremely limited in relay mode, and I didn't want to flash third-party firmware (because I'd lose the app control features, which is inconvenient). So, I simply swapped it for a HiWiFi 3 (JeeWiFi). The HiWiFi retains most of its functions even in relay mode (which I think is how it should be; I don't understand the logic behind Xiaomi mini losing so many features after entering relay mode).</p>

    <p>As a tinkerer, once a new router arrives, there's a lot to configure. HiWiFi is based on OpenWrt, so it has high playability. First, complete the relay and get online—this is simple and won't be detailed here. Next is obtaining SSH permissions, which HiWiFi calls "applying for Developer Mode," or root (it feels like HiWiFi wants to be the Apple of routers, but in this day and age, that kind of development model is hard to sustain). This step isn't difficult either, though applying will void the HiWiFi warranty (I don't understand the logic behind that either).</p>

    <p>This article primarily introduces how to install Python on OpenWrt (HiWiFi) and how to establish an SSH reverse proxy (to achieve intranet penetration).</p>

    <h3>Installing Python to SD card</h3>
    <p>Once you have SSH permissions, you can do many things. The first thing to do is install Python, which opens up many possibilities. This took a bit of effort. First, you need to modify the OpenWrt software sources by editing the following three files:</p>
    <blockquote>/etc/opkg.conf /etc/opkg.d/opkg-secure.conf /etc/opkg.d/opkg-fast.conf</blockquote>
    <p>Comment out the first line:</p>
    <pre><code># src/gz barrier_breaker https://upgrade.hiwifi.com/upgrade_file/ralink-HC5861/0.9017.1.11380s/packages</code></pre>
    <p>Then add the following at the bottom:</p>
    <pre><code>src/gz barrier_breaker http://downloads.openwrt.org.cn/PandoraBox/ralink/mt7620_old/packages/</code></pre>
    <p>After deleting the cache files, you can update the sources and install software:</p>
    <pre><code>rm /var/opkg-lists/barrier_breaker
opkg update</code></pre>
    <p>Note that the HiWiFi 3 ROM has very little remaining space, so it's best to install Python on the SD card. To do this, first check the SD card mount point using <code>df -h</code> (mine is <code>/tmp/storage/mmcblk0p2</code>). Then, modify the same three files again:</p>
    <blockquote>/etc/opkg.conf /etc/opkg.d/opkg-secure.conf /etc/opkg.d/opkg-fast.conf</blockquote>
    <p>Below the line:</p>
    <pre><code>dest root /</code></pre>
    <p>Add:</p>
    <pre><code>dest usb /tmp/storage/mmcblk0p2</code></pre>
    <p>Additionally, you need to modify the system environment variables by editing <code>/etc/profile</code>, as follows (notice the highlighted parts):</p>
    <pre><code>export PATH=<span style="color: red;">/tmp/storage/mmcblk0p2/usr/bin:/tmp/storage/mmcblk0p2/usr/sbin:</span>/bin:/sbin:/usr/bin:/usr/sbin:$HIWIFI_CRYPTDA
export LD_LIBRARY_PATH=<span style="color: red;">/tmp/storage/mmcblk0p2/lib:/tmp/storage/mmcblk0p2/usr/lib:</span>$HIWIFI_CRYPTDATA/lib:$HIWIFI_CRYPTDATA</code></pre>
    <p>Now, you can use the following command to install Python to the SD card:</p>
    <pre><code>opkg install python -d usb</code></pre>
    <p>Then install <code>setuptools</code> to get <code>easy_install</code>, followed by <code>pip</code> and the <code>requests</code> library. At this point, my Python environment configuration is complete.</p>

    <h3>Configuring SSH Reverse Proxy</h3>
    <p>Next, I wanted to find a way to penetrate the intranet so that I could manage the home router from school. There are many methods for this, such as ngrok (I haven't tried it, but looking at tutorials, the configuration seems slightly cumbersome), n2n (this is P2P-based, which I like, and it works on OpenWrt; I successfully configured it on my school router, but it failed on the HiWiFi, so I gave up), and PeanutHull Intranet version (HiWiFi has a PeanutHull plugin, which is okay, but the free version is too restrictive). With the first three being unsatisfactory, SSH reverse proxy was the remaining choice.</p>
    <p>The principle of SSH reverse proxy is the inverse use of SSH, exactly the opposite order of a normal SSH login:</p>
    <blockquote>
        <strong>Normal SSH:</strong> My Computer ----&gt; Intranet Router ----&gt; My VPS<br>
        <strong>Reverse Proxy:</strong> My Computer ----&gt; Your VPS ----&gt; Intranet Router
    </blockquote>
    <p>Implementation is very simple—just one line of code—and it works on almost all platforms (as long as they support SSH). Of course, the preparation takes some work.</p>
    <p>To use an SSH reverse proxy, you need your own VPS with a public IP. I use an Alibaba Cloud server, which is very affordable at 9.9 RMB/month for students. First, configure the VPS by modifying <code>/etc/ssh/sshd_config</code> to include:</p>
    <pre><code>GatewayPorts yes</code></pre>
    <p>Then restart SSH with <code>/etc/init.d/ssh restart</code>. Next, on the HiWiFi OpenWrt, establish the reverse tunnel to the VPS using the following code:</p>
    <pre><code>ssh -Nfg -R 11111:192.168.199.1:1022 root@1.1.1.1</code></pre>
    <p>This is just like a normal SSH login, where <code>1.1.1.1</code> is the VPS public IP, <code>192.168.199.1</code> is the HiWiFi management IP, and <code>1022</code> is the HiWiFi SSH port (since I only want to SSH into the router). Once the login is successful, accessing <code>1.1.1.1:11111</code> from anywhere is equivalent to accessing <code>192.168.199.1:1022</code> on the router. For example, you can try <code>ssh root@1.1.1.1 -p 11111</code> to see if you can log into the router. (You can also run <code>netstat -nlp|grep sshd</code> on the VPS to see if the port proxy was established successfully.) The meaning of the parameters above can be found via <code>ssh -h</code>.</p>
    <p>At this point, the problem is basically solved, but there are a few issues. First, SSH requires manual password entry interactively. For passwordless login, you need to generate a key locally and upload it to the VPS (the private-public key mechanism). The specific step is to generate the public key first (this is the built-in method on OpenWrt; a standard Linux system should use <code>ssh-keygen</code>):</p>
    <pre><code>dropbearkey -t rsa -f /etc/dropbear/id_rsa
dropbearkey -y -f /etc/dropbear/id_rsa | grep ssh-rsa &gt; /tmp/id_rsa.pub</code></pre>
    <p>Next, add the content of <code>/tmp/id_rsa.pub</code> to the <code>~/.ssh/authorized_keys</code> file on the VPS server (create it if it doesn't exist). Then, log in using:</p>
    <pre><code>ssh -i /etc/dropbear/id_rsa -Nfg -R 11111:192.168.199.1:1022 root@1.1.1.1</code></pre>
    <p>You will find that no password is required.</p>

    <p>Second, SSH itself isn't very stable; it will automatically disconnect after a long period of inactivity. One way to solve this is to use <code>autossh</code> instead of the built-in <code>ssh</code> (<code>opkg install autossh -d usb</code>). <code>autossh</code> is an SSH client with monitoring capabilities. The code for <code>autossh</code> is similar:</p>
    <pre><code>autossh -i /etc/dropbear/id_rsa -M 11112 -Nfg -R 11111:192.168.199.1:1022 1.1.1.1</code></pre>
    <p>Its principle is adding an additional port 11112 to monitor the connectivity status of port 11111; if it disconnects, it automatically reconnects.</p>

    <p>Third, how to start with the router. The router might restart at any time due to power loss, so the command needs to be added to the startup items. This is also simple: just add it to <code>/etc/rc.local</code>. However, there are two minor problems: (1) My router accesses the internet via relay, so it's likely that when the script runs, the network hasn't connected yet. Connecting to SSH without internet is pointless, so I need to check if the network is up before executing (I could also use <code>sleep</code> to wait long enough, but that's not very reliable). My method for checking network connectivity is simple: I created a <code>test.html</code> on my own website with the content <code>pass</code>; if accessing this page returns <code>pass</code>, the connection is up. (2) If a tunnel was successfully established and then the router restarts, the corresponding tunnel might still be cached on the VPS. Thus, the next time the code runs, it might default to the cached tunnel, showing success while actually failing when you try to <code>ssh root@1.1.1.1 -p 11111</code> (this action would then clear the VPS cache). Therefore, after establishing the SSH tunnel, I need to test if it's usable; if not, I need to re-establish it. Since SSH itself runs blocking, we can utilize that.</p>

    <p>The code is as follows:</p>
    <pre><code>#!/bin/sh

local_ip=`ifconfig br-lan|grep 'inet addr'|awk '{print $2}'|awk -F: '{print $2}'`
vps_ip=1.1.1.1

while true
do
 wget http://kexue.fm/test.html
 a=`cat test.html`
 rm test.html
 if [ "$a" = 'pass' ]
 then
 autossh -i /etc/dropbear/id_rsa -M 11112 -Nfg -R 11111:$local_ip:1022 $vps_ip
 ssh -i /etc/dropbear/id_rsa -N $vps_ip -p 11111
 fi
 sleep 10
done</code></pre>
    <p>This script integrates LAN IP detection, network connectivity detection, usability checks, and automatic reconnection. Save this code as <code>run.sh</code>, place it in the root directory, and run <code>chmod +x run.sh</code> to grant execution rights. Then, in <code>/etc/rc.local</code> before <code>exit 0</code>, add:</p>
    <pre><code>source /etc/profile
/run.sh &amp;</code></pre>
    <p>The first line is very important because my <code>autossh</code> and other tools are installed on the SD card and require the system environment variables to be loaded. When this script runs at boot, the environment variables might not be loaded yet, so it's best to import them manually to ensure everything runs correctly.</p>

    <p>Finally, everything is configured. For easy access, I even bound one of my subdomains to the VPS. This creates a relatively perfect intranet penetration platform, which essentially beats the PeanutHull intranet version.</p>

    <h3>Reference Links</h3>
    <p>
        <a href="https://yxz.me/archives/881.html">https://yxz.me/archives/881.html</a><br>
        <a href="http://blog.csdn.net/jk110333/article/details/11920163">http://blog.csdn.net/jk110333/article/details/11920163</a><br>
        <a href="https://blog.phpgao.com/ssh-reverse-tunnel.html">https://blog.phpgao.com/ssh-reverse-tunnel.html</a><br>
        <a href="http://www.cage.tk/2015/01/22/openwrt-use-ssh-connect-access/">http://www.cage.tk/2015/01/22/openwrt-use-ssh-connect-access/</a>
    </p>

    </article>
<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="https://kexue.fm/archives/3604" style="color: #005fcc;">https://kexue.fm/archives/3604</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
