
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\(']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    tags: 'ams'
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<h1><a href="https://kexue.fm/archives/7867">The T5 Model That Dominated the Leaderboards Can Now Be Used in Chinese</a></h1>

    <p>By 苏剑林 | November 06, 2020</p>


<p>I wonder if everyone still has an impression of Google's chart-topping work T5 from last year? That's the model that, under the banner of "Everything is Seq2Seq," scaled up to 11 billion parameters and swept multiple NLP leaderboards like GLUE and SuperGLUE. Even after a year, T5 still holds the top spot on the <a href="https://super.gluebenchmark.com/">SuperGLUE</a> leaderboard, currently maintaining a steady 2% lead over second place. However, for friends in the Chinese NLP community, T5 might not have had much presence for a simple reason: there was no Chinese version of T5 available. But this situation is about to change, because Google recently released the multilingual version of T5 (mT5), which naturally includes Chinese. Although it’s not a "pure" Chinese version, it’s good enough to make do with.</p>

<p align="center">
    <img src="https://coder-1251347318.cos.ap-guangzhou.myqcloud.com/20201106114115.png" width="400" alt="T5: Everything is Seq2Seq" /><br />
    <em>"Everything is Seq2Seq" T5</em>
</p>

<p>This article will provide a brief review and introduction to the T5 model, and then explain how to call the mT5 model in <code>bert4keras</code> for Chinese tasks. As a native Seq2Seq pre-trained model, mT5 performs quite well on text generation tasks and is well worth a try.</p>

<h2 id="T5">T5</h2>

<p>Like BERT, T5 is also produced by Google, coming from the paper <a href="https://papers.cool/arxiv/1910.10683">"Exploring the Limits of Transfer Learning with a Unified Text-to-Text Transformer"</a>, with the GitHub repository at <a href="https://github.com/google-research/text-to-text-transfer-transformer">text-to-text-transfer-transformer</a>. The core philosophy of T5 is "Everything is Seq2Seq." It uses a standard Encoder-Decoder model and constructs unsupervised/supervised text generation pre-training tasks, ultimately pushing performance to a new height.</p>

<h3 id="Training">Training</h3>

<p>T5's pre-training includes both unsupervised and supervised parts. The unsupervised part uses nearly 800G of corpus constructed by Google (referred to in the paper as C4), and the training objective is similar to BERT, but modified into a Seq2Seq version. We can think of it as an advanced version of fill-in-the-blanks:</p>

<blockquote>
    <strong>Input:</strong> When will the bright moon be here? [M0] ask the blue sky, not knowing [M1], what year is it tonight? I desire [M2] return, yet fear the jade towers and palace of pearl, where the high altitude [M3]; dancing to [M4] clear shadow, what is it like in the human world.<br />
    <strong>Output:</strong> [M0] holding a wine cup [M1] the palace in the heavens [M2] riding the wind [M3] is unbearably cold [M4] playing with
</blockquote>

<p>The supervised part involves collecting common NLP supervised task data and uniformly transforming them into Seq2Seq tasks for training. For example, sentiment classification can be transformed like this:</p>

<blockquote>
    <strong>Input:</strong> Identify the sentiment tendency of this sentence: I felt very good about this trip to Beijing. <br />
    <strong>Output:</strong> Positive
</blockquote>

<p>Topic classification can be transformed like this:</p>

<blockquote>
    <strong>Input:</strong> What kind of news is the following? After eight months, we can finally see the volleyball girls on the court again. <br />
    <strong>Output:</strong> Sports
</blockquote>

<p>Reading comprehension can be transformed like this:</p>

<blockquote>
    <strong>Input:</strong> Reading Comprehension: Trump and Biden are running together for the next US president. Answer the question based on the above information: What nationality is Trump? <br />
    <strong>Output:</strong> American
</blockquote>

<p>As can be seen, this transformation is consistent with the ideas of GPT2, GPT3, and PET—all aiming to use text to express the tasks we want to perform and then transforming them into text prediction. Readers can also refer to the previous post <a href="translation_7764.html">"Do We Really Need GPT3? No, BERT’s MLM Model Can Also Do Few-shot Learning"</a> to understand related content. In general, based on our internal experiments, the large model size, massive data, and supervised pre-training are all key factors in T5's success. "Everything is Seq2Seq" provides an effective scheme to integrate these key factors.</p>

<h3 id="Results">Results</h3>

<p>T5's main achievements are summarized in the table below:</p>

<p align="center">
    <img src="https://coder-1251347318.cos.ap-guangzhou.myqcloud.com/20201106120401.png" width="800" alt="T5 Score Summary" /><br />
    <em>T5 Score Summary</em>
</p>

<p>In addition to dominating multiple leaderboards, T5 also tuned many adjustable hyperparameters throughout the entire training process—for instance, whether a standard Encoder-Decoder or a UniLM-style architecture is better, whether BERT’s method or others are better for unsupervised pre-training tasks, whether a random Mask ratio of 15% is best, and so on. Finally, they provided the following table, and even expressed a regretful "In fact, we feel that T5's experiments are not thorough enough," which felt a bit like "taking every path so others have no path left to take." Regardless, these "alchemy" results are worth reading for every student who wants to build language models; they might allow us to take fewer detours.</p>

<p align="center">
    <img src="https://coder-1251347318.cos.ap-guangzhou.myqcloud.com/20201104193554.png" width="800" alt="T5 Alchemy Bible" /><br />
    <em>T5's exhaustive "Alchemy Bible" (Click to enlarge)</em>
</p>

<h2 id="mT5">mT5</h2>

<p>As for mT5, which is Multilingual T5, the multilingual version of T5, it comes from the recent paper <a href="https://papers.cool/arxiv/2010.11934">"mT5: A massively multilingual pre-trained text-to-text transformer"</a>, with the GitHub repository at <a href="https://github.com/google-research/multilingual-t5" >multilingual-t5</a>. This has once again pushed the leaderboard scores for multilingual NLP tasks to a new height. Of course, for us, the most important thing is that mT5 includes Chinese, so we finally have the opportunity to try T5 on Chinese tasks.</p>

<h3 id="T5.1.1">T5.1.1</h3>

<p>Overall, mT5 follows the same lineage as T5 and is basically the same, but in terms of model structure, mT5 uses the T5.1.1 scheme. Here is a basic introduction to it.</p>

<p>What many people don’t know is that since its release last October, T5 underwent a low-key minor upgrade earlier this year. Specific details can be found at the <a href="https://github.com/google-research/text-to-text-transfer-transformer/blob/master/released_checkpoints.md">GitHub link</a>. The official name for T5 before the upgrade is T5.1.0, and after the upgrade, it's called T5.1.1. Its main changes come from the paper <a href="https://papers.cool/arxiv/2002.05202">"GLU Variants Improve Transformer"</a>, mainly borrowing the GLU (Gated Linear Unit) from <a href="https://papers.cool/arxiv/1612.08083">"Language Modeling with Gated Convolutional Networks"</a> to enhance the performance of the FFN (Feed-Forward Network) part. Specifically, the original T5 FFN was (T5 has no Bias):
\begin{equation}\text{FFN}(x)=\text{relu}(xW_1)W_2\end{equation}
This has now been changed to:
\begin{equation}\text{FFN}_{\text{GEGLU}}(x)=\big(\text{gelu}(xW_1)\otimes xW_2\big)W_3\end{equation}
That is, the first transformation layer activated by ReLU was changed to a gated linear unit activated by GeLU. This increases the FFN layer parameters by 50%, but according to the paper, the effect is significantly improved. Additionally, T5.1.1 changed the Embedding layer. In T5.1.0, the Encoder and Decoder’s Embedding layers, and the Softmax layer for the Decoder’s final probability distribution prediction, all shared the same Embedding matrix. Now, T5.1.1 only shares the Embedding layer between the Encoder and Decoder, while the Softmax layer for final probability prediction uses an independent Embedding matrix. This naturally increases the number of parameters significantly, but Google's conclusion states that this performs better, a conclusion summarized in the recent paper <a href="https://papers.cool/arxiv/2010.12821">"Rethinking embedding coupling in pre-trained language models"</a>. One last change: T5.1.1 removed Dropout during the pre-training phase, only using it during the downstream fine-tuning phase.</p>

<p>After these adjustments, Google re-trained and opened up the full series of T5.1.1 models. Download links can be found at the GitHub link mentioned above. Note that T5.1.1 only underwent unsupervised pre-training, but its performance is still outstanding. Since T5.1.1 shows significant improvements, mT5 continued to use the T5.1.1 structure.</p>

<h3 id="mT5_Results">Results</h3>

<p>mT5 is essentially a re-construction of a multilingual dataset mC4, followed by a round of training using the T5.1.1 scheme; there is no significant technical innovation in the roadmap. Regarding training details, readers can look at the original paper, which isn't very long since T5 already paved the way.</p>

<p>As for mT5’s performance, it is mainly concentrated in the following table:</p>

<p align="center">
    <img src="https://coder-1251347318.cos.ap-guangzhou.myqcloud.com/20201106121544.png" width="600" alt="mT5 Score Summary" /><br />
    <em>mT5 "Record"</em>
</p>

<p>Readers might wonder how such a multilingual version is evaluated. Simply put, we could directly fine-tune a cross-lingual machine translation task on this basis to see the improvement. However, for multilingual models, researchers are more concerned with their Zero-Shot performance in cross-lingual tasks. To put it bluntly, for the same task, if we fine-tune on one language, can the model be used directly on other languages? This is the meaning of "Cross-lingual zero-shot transfer (models fine-tuned on English data only)" in the table above. It can be seen that mT5's performance is quite impressive.</p>

<h2 id="Practice">Practice</h2>

<p>Finally, we come to the part everyone loves: practice. Here we will briefly introduce the process and techniques of using the mT5 model for Chinese text generation tasks in bert4keras. bert4keras started supporting mT5 from version 0.9.1. Readers who wish to conduct the following experiments should first upgrade bert4keras to version 0.9.1 or higher.</p>

<p><strong>GitHub Link: <a href="https://github.com/bojone/t5_in_bert4keras">https://github.com/bojone/t5_in_bert4keras</a></strong></p>

<h3 id="Basic">Basic</h3>

<p>The basic code to load the mT5 model into Keras using bert4keras is:</p>

<pre><code># Model paths
config_path = '/root/kg/bert/mt5/mt5_small/t5_config.json'
checkpoint_path = '/root/kg/bert/mt5/mt5_small/model.ckpt-1000000'
spm_path = '/root/kg/bert/mt5/sentencepiece.model'

# Load tokenizer
tokenizer = SpTokenizer(spm_path, token_start=None, token_end=' ')

# Load model
t5 = build_transformer_model(
    config_path=config_path,
    checkpoint_path=checkpoint_path,
    model='t5.1.1',
    return_keras_model=False,
    name='T5',
)

encoder = t5.encoder
decoder = t5.decoder
model = t5.model
</code></pre>

<p>It can be seen that there isn't much difference from loading BERT in bert4keras. The construction of <code>t5_config.json</code> and the download of <code>model.ckpt-1000000</code> are detailed on GitHub, so please head there to take a look. Complete code (including training and decoding details) can also be found on GitHub and won't be expanded upon here.</p>

<p>It is worth mentioning that for Chinese, the results given by the tokenizer include words; that is, for Chinese, mT5 uses words as the unit, though the word granularity is relatively small. This further proves that our previous work <a href="translation_7758.html">"Speed Up Without Performance Loss: Chinese WoBERT Based on Word Granularity"</a> was heading in the right direction.</p>

<h3 id="Chinese">Chinese</h3>

<p>I believe most readers of this blog only care about Chinese tasks, some may also care about English tasks, and very few would care about tasks in languages other than Chinese and English. However, mT5 covers 101 languages and has a total vocabulary of 250,000. Furthermore, the Softmax in the T5.1.1 structure does not share parameters, which leads to the Embedding layer occupying a significant number of parameters. For example, the mT5 small model has 300 million parameters, of which 250 million are related to the Embedding. The key point is that most of these parameters are useless to us; they are purely a waste. Therefore, for those of us who mainly care about Chinese tasks, it is necessary to streamline this Embedding layer.</p>

<p>Simplifying the model is easy: you just need to delete unnecessary rows from the two Embedding matrices. The key lies in how to decide which tokens to retain and how to obtain a streamlined SentencePiece model. To decide which tokens to keep, a simple idea is to keep Chinese tokens, but not just Chinese—English ones must also be partially kept. It looks like a simple regular expression problem, but it’s actually not that simple; those using English letters aren't necessarily English, and those using Chinese characters aren't necessarily Chinese. This is a confusing issue. So I thought of another method: use this 250,000-token tokenizer on the tens of gigabytes of Chinese corpus I collected, count the tokenization results, and then select the top portion based on frequency (ultimately, over 30,000 tokens were kept). Although this is more time-consuming, it is more reliable and ensures that the tokens we need most are kept. After deciding on the vocabulary, you have to modify and obtain a new SentencePiece model, which is also a bit troublesome, but after searching, I finally solved it. The processing methods are shared on GitHub.</p>

<p>After this processing, to build a new model, you only need to add three lines of code related to <code>keep_tokens</code>. The required video memory is greatly reduced, and the performance of Chinese generation remains basically unchanged:</p>

<pre><code># Model paths
config_path = '/root/kg/bert/mt5/mt5_base/t5_config.json'
checkpoint_path = '/root/kg/bert/mt5/mt5_base/model.ckpt-1000000'
spm_path = '/root/kg/bert/mt5/sentencepiece_cn.model'
keep_tokens_path = '/root/kg/bert/mt5/sentencepiece_cn_keep_tokens.json'

# Load tokenizer
tokenizer = SpTokenizer(spm_path, token_start=None, token_end=' ')
keep_tokens = json.load(open(keep_tokens_path))

# Load model
t5 = build_transformer_model(
    config_path=config_path,
    checkpoint_path=checkpoint_path,
    keep_tokens=keep_tokens,
    model='t5.1.1',
    return_keras_model=False,
    name='T5',
)

encoder = t5.encoder
decoder = t5.decoder
model = t5.model
</code></pre>

<h3 id="Effect">Performance</h3>

<p>Finally, everyone is likely concerned with whether, after all this effort, the generation effect has improved and if it's worth using. Let's put it this way: a CSL title generation model fine-tuned using the mT5 small version can match the BLEU score of a UniLM model based on WoBERT, while being 130% faster in decoding. A CSL title generation model fine-tuned with the mT5 base version can exceed the WoBERT-based UniLM model by more than 1% in metrics, and the decoding speed is also 60% faster.</p>

<div style="overflow-x: auto;">
\[\begin{array}{c}
\text{CSL Abstract Generation Results (beam size=1)}\\
{\begin{array}{c|cccc|c}
\hline
& \text{Rouge-L} & \text{Rouge-1} & \text{Rouge-2} & \text{BLEU} & \text{Decoding Speed}\\
\hline
\text{BERT base} & 63.81 & 65.45 & 54.91 & 45.52 & \text{1x}\\
\text{WoBERT base} & 66.38 & 68.22 & 57.83 & 47.76 & \text{1.1x}\\
\hline
\text{mT5 small} & 65.14 & 67.08 & 56.71 & 47.69 & \text{2.3x}\\
\text{mT5 base} & \textbf{66.81} & \textbf{68.94} & \textbf{58.49} & \textbf{49.49} & \text{1.6x}\\
\hline
\end{array}}
\end{array}\]
</div>

<p>Simply put, it is indeed both faster and better. As for hardware requirements, students who have successfully run BERT base before should basically be able to run mT5 small/base, and can even try the large version. As for XL and XXL, those are difficult to handle, and I suggest giving up on them. More surprises are waiting for everyone to discover for themselves... Oh, by the way, I need to remind you that when fine-tuning the T5 model, the learning rate should be more than 10 times larger than when fine-tuning BERT (i.e., at the $10^{-4}$ level, while BERT is generally at $10^{-5}$). This is determined by the architectural differences between the two models.</p>

<h2 id="Summary">Summary</h2>

<p>This article reviewed the T5 model released by Google last year, then introduced the recently released multilingual mT5, and finally explained how to fine-tune mT5 for Chinese tasks in bert4keras. The results show that mT5 performs very well in Chinese generation and is worth a try for anyone working on text generation tasks.</p>
<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="https://kexue.fm/archives/7867" style="color: #005fcc;">https://kexue.fm/archives/7867</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
