
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    tags: 'ams',
    packages: {'[+]': ['ams']}
  }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<article>
    <nav style="margin-bottom: 1.5em;">
    <a href="../index.html" style="display: inline-flex; align-items: center; color: #555; text-decoration: none; font-size: 0.95em;">
        <span style="margin-right: 0.3em;">&larr;</span> Back to Index
    </a>
</nav>

    <h1><a href="https://kexue.fm/archives/7124">Conditional Text Generation Based on Conditional Layer Normalization</a></h1>
    
    <p>By 苏剑林 | December 14, 2019</p>

    <p>From the article <a href="translation_6933.html">"From Language Models to Seq2Seq: Transformer as a Play, Relying Entirely on Masking"</a>, we know that as long as it is paired with the appropriate Attention Mask, Bert (or other Transformer models) can be used for unconditional generation (Language Model) and sequence translation (Seq2Seq) tasks.</p>

    <p>But what if it is conditional generation? For example, controlling the category of text to generate text randomly based on a category, which is a Conditional Language Model; or another example, passing in an image to generate a related text description, which is Image Captioning.</p>

    <h2>Related Work</h2>

    <p>The August paper <a href="https://papers.cool/arxiv/1908.06938">"Encoder-Agnostic Adaptation for Conditional Language Generation"</a> systematically analyzes several schemes for using pre-trained models for conditional generation; a September paper <a href="https://papers.cool/arxiv/1909.05858">"CTRL: A Conditional Transformer Language Model for Controllable Generation"</a> provides a model pre-trained based on conditional generation, but this is essentially a language model like GPT that can only take text input as a condition; and the recent paper <a href="https://papers.cool/arxiv/1912.02164">"Plug and Play Language Models: a Simple Approach to Controlled Text Generation"</a> transforms $p(x|y)$ into $p(x)p(y|x)$ to explore conditional generation based on pre-trained models.</p>

    <p>However, these classic works are not what this article is about. This article focuses on a scenario where a fixed-length vector is used as the condition for text generation, and the method is <strong>Conditional Layer Normalization</strong>—integrating the condition into the \(\beta\) and \(\gamma\) of Layer Normalization.</p>

    <h2>Idea Details</h2>

    <p>The idea of Conditional Layer Normalization originates from the popular Conditional GAN approach in image processing—Conditional Batch Normalization (Conditional BN). Related content can be found in <a href="translation_6549.html">"An Overview of GAN Architecture Development: From DCGAN to SELF-MOD"</a>. Conditional BN also has a variant called AdaIN (Adaptive Instance Normalization). Both Conditional BN and AdaIN turn the \(\beta\) and \(\gamma\) in existing Normalization methods into functions of the input condition, thereby allowing the condition to control the generative behavior.</p>

    <p>In Transformer models like Bert, the main Normalization method is Layer Normalization. Therefore, it is natural to think of turning the corresponding \(\beta\) and \(\gamma\) into functions of the input condition to control the generative behavior of the Transformer model. This is the core logic of Conditional Layer Normalization. (However, as of now, I haven't seen other work appearing with the same approach, so this can be considered a bit of "reinventing the wheel" on my part.)</p>

    <p style="text-align:center;">
        <a href="https://kexue.fm/usr/uploads/2019/12/2102002684.png">
            <img src="https://kexue.fm/usr/uploads/2019/12/2102002684.png" alt="Conditional Normalization Diagram" />
        </a>
        <br />
        <em>Conditional Normalization Diagram</em>
    </p>

    <p>For models that have already been pre-trained, there are already ready-made, unconditional \(\beta\) and \(\gamma\), which are both fixed-length vectors. We can use two different transformation matrices to transform the input condition into the same dimension as \(\beta\) and \(\gamma\), and then add the two transformation results separately to \(\beta\) and \(\gamma\). To prevent disturbing the original pre-trained weights, the two transformation matrices can be initialized to all zeros (single-layer neural networks can use zero initialization; only continuous multi-layer neural networks should avoid zero initialization). In this way, in the initial state, the model remains consistent with the original pre-trained model.</p>

    <h2>Code Implementation</h2>

    <p>Intuitively, this type of fine-tuning for text generation should use autoregressive pre-trained models like GPT to improve effectiveness. But in fact, as shown in the previous article <a href="translation_6933.html">"From Language Models to Seq2Seq: Transformer as a Play, Relying Entirely on Masking"</a>, even if you load Bert's pre-trained weights to perform generation tasks, performance remains good. Therefore, regardless of the type of Transformer-based pre-trained model, it can be considered for fine-tuning as a text generation model. This article uses the pre-trained BERT as the base model for experiments.</p>

    <p>As for the code, the Conditional Layer Normalization technique described in this article has already been integrated into <a href="https://github.com/bojone/bert4keras">bert4keras</a>, which I developed. Now, the base function <code>build_transformer_model</code> has been updated with the following parameters:</p>

    <blockquote>
        <p>1. <code>layer_norm_cond</code>: If this parameter is not None, it means it is a tensor with <code>shape=[batch_size, cond_size]</code>, used as the condition for Layer Normalization;</p>
        <p>2. <code>layer_norm_cond_size</code>: If this parameter is not None and <code>layer_norm_cond</code> is None, it means it is an integer, and an input layer with <code>shape=[batch_size, layer_norm_cond_size]</code> will be automatically constructed as the condition for Layer Normalization;</p>
        <p>3. <code>layer_norm_cond_hidden_size</code>: If this parameter is not None, it means it is an integer, used to project the input condition into a lower-dimensional space first. This is because the input condition might have a very high dimension; projecting it directly to <code>hidden_size</code> (e.g., 768) might involve too many parameters, so it can be projected to a lower dimension first and then up-sampled;</p>
        <p>4. <code>layer_norm_cond_hidden_act</code>: The activation function used when projecting to the lower-dimensional space. If it is None, no activation function is applied (linear activation);</p>
        <p>5. <code>additional_input_layers</code>: Additional input layers. If a tensor is passed externally as a condition, all input layers that the condition tensor depends on need to be added to build the final model.</p>
    </blockquote>

    <h2>Experimental Results</h2>

    <p>No matter how much I introduce it, it's better to look at examples. I conducted two experiments to verify the effectiveness of Conditional Layer Normalization. One is controlling text generation via sentiment polarity (the inverse of sentiment classification), which uses class Embeddings as the Layer Normalization condition; the other is Image Captioning, where a fixed-length vector encoded from an image using a pre-trained Imagenet model is used as the Layer Normalization condition.</p>

    <p>These two codes are located in <a href="https://github.com/bojone/bert4keras/blob/master/examples/task_conditional_language_model.py">task_conditional_language_model.py</a> and <a href="https://github.com/bojone/bert4keras/blob/master/examples/task_image_caption.py">task_image_caption.py</a> respectively.</p>

    <h3>Sentiment Text Generation</h3>

    <p>The sentiment text generation uses the <a href="https://github.com/bojone/bert4keras/blob/master/examples/datasets/sentiment.zip">sentiment classification corpus</a> I collected and organized previously, simply reversing the input text and labels. Finally, sampling the output randomly according to probabilities allows for the generation of different texts.</p>

    <p>Partial output:</p>

    <blockquote>
        <p><strong>Positive samples:</strong></p>
        <p>['The appearance is stylish, beautiful, and the cost-performance ratio is high.', 'Beautiful appearance, balanced configuration, quite satisfied, high cost-performance ratio, beautiful appearance, high performance.', 'I saw this book when I was in university, so I have been buying it. The author of the book is Lin Jinglei, who wrote about the psychological journey of a child’s growth in her own voice, allowing me to see the different aspects of their growth and the different realms of their growth process. I really appreciate it!', 'I think this is a book that can tell readers what is bad, rather than teaching you how to speak or telling me what is wrong. Here I recommend "I Want to Tell a Story". This book is one of my favorites, I think there are many reasons for it, but I believe in myself. If you get some improvement from it, or you have already made a wise decision.', 'Our family of five stayed in a standard room, a king room, the king bed was very comfortable; and we booked two sets of king rooms on Ctrip, the price of this hotel is quite reasonable; but the soundproofing of the room is not ideal, there is a bit of noise; the subway at the hotel entrance is under construction, which is inconvenient; but the taxis at the hotel entrance don't know whose they are, taking a taxi is not very convenient; outside the hotel...']</p>
        <p><strong>Negative samples:</strong></p>
        <p>['I don't know if it's because the battery is not very good, it's not that I don't like it.', 'I bought it after reading the reviews. It turns out it's not that cheap, and the price is not cheap either.', '1. The shell is not easy to leave fingerprints on, but not easy to wash 2. The screen is a bit old and ringtones cannot be downloaded', 'I ordered "A Story of Lala's Promotion" on July 6th and paid via bank transfer. Why has it been more than two weeks and the order hasn't arrived? Is the delivery time too fast? Maybe it just passed by like that?', 'I read this book online first, then I read it again. I feel like the author's writing is really terrible, especially when writing his blog, it feels very awkward and unprofessional, especially the little boy who regulates emotions when he writes about stocks, it's just self-righteous, it's simply a manifestation of being self-righteous!']</p>
    </blockquote>

    <h3>Image Caption</h3>

    <p>The Image Captioning uses the <a href="http://cocodataset.org/#download">COCO dataset</a> as an example, as the image scenes in this dataset are quite rich. In addition, challenger.ai held an <a href="https://challenger.ai/dataset/caption?lan=zh">Image Chinese Description Generation Competition</a> in 2017, which also included a good dataset (readers can find ways to collect it themselves), though the image scenes are relatively monotonous.</p>

    <p>Partial output:</p>

    <p style="text-align:center;">
        <a href="https://kexue.fm/usr/uploads/2019/12/3163471200.jpg">
            <img src="https://kexue.fm/usr/uploads/2019/12/3163471200.jpg" alt="Model prediction: a baseball game in progress with the batter up to plate." />
        </a>
        <br />
        <em>Model prediction: a baseball game in progress with the batter up to plate.</em>
    </p>

    <p style="text-align:center;">
        <a href="https://kexue.fm/usr/uploads/2019/12/3673525199.jpg">
            <img src="https://kexue.fm/usr/uploads/2019/12/3673525199.jpg" alt="Model prediction: a train that is sitting on the tracks." />
        </a>
        <br />
        <em>Model prediction: a train that is sitting on the tracks.</em>
    </p>

    <blockquote>
        <p><strong>image_id:</strong> COCO_val2014_000000524611.jpg</p>
        <p><strong>url:</strong> <a href="http://images.cocodataset.org/val2014/COCO_val2014_000000524611.jpg">http://images.cocodataset.org/val2014/COCO_val2014_000000524611.jpg</a></p>
        <p><strong>predict:</strong> a train that is sitting on the tracks.</p>
        <p><strong>references:</strong> [u'A train carrying chemical tanks traveling past a water tower.', u'Dual train tracks with a train on one of them and a water tower in the background.', u'a train some trees and a water tower ', u'Train on tracks with water tower for Davis Junction in the rear.', u'A train on a train track going through a bunch of trees.']</p>
        <p><strong>image_id:</strong> COCO_val2014_000000202923.jpg</p>
        <p><strong>url:</strong> <a href="http://images.cocodataset.org/val2014/COCO_val2014_000000202923.jpg">http://images.cocodataset.org/val2014/COCO_val2014_000000202923.jpg</a></p>
        <p><strong>predict:</strong> a baseball game in progress with the batter up to plate.</p>
        <p><strong>references:</strong> [u'Batter, catcher, and umpire anticipating the next pitch.', u'A baseball player holding a baseball bat in the game.', u'A baseball player stands ready at the plate.', u'Baseball players on the field ready for the pitch.', u'A view from behind a mesh fence of a baseball game.']</p>
    </blockquote>

    <h2>Conclusion</h2>

    <p>This article proposes the idea of using Conditional Layer Normalization to integrate external conditions into pre-trained models. Its direct application is conditional text generation, but it is not limited to generative models; it can also be used in classification models and other scenarios (external conditions might be information from other modalities to assist classification). Finally, code implementation based on bert4keras and two examples are provided.</p>
</article>
<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="https://kexue.fm/archives/7124" style="color: #005fcc;">https://kexue.fm/archives/7124</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
