
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    tags: 'ams',
    macros: {
      text: ["\\text{#1}", 1]
    }
  }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<article>
    <h1><a href="https://kexue.fm/archives/9632">Some Supplementary Explanations and Analyses of the NBCE Method</a></h1>
    <p>By 苏剑林 | May 31, 2023</p>

    <p>Last week, in <a href="translation_9617.html">"NBCE: Expanding the Context Length of LLMs using Naive Bayes"</a>, we introduced a scheme called NBCE (Naive Bayes-based Context Extension) to extend the context length of LLMs based on Naive Bayes. Because it has advantages such as being plug-and-play, model-independent, and requiring no fine-tuning, it has received recognition from several readers. Overall, the testing feedback so far has been quite positive. Of course, some readers raised questions while using it. This article combines readers' queries and the author's subsequent reflections to provide some supplementary explanations and analyses of the NBCE method.</p>

    <h2>Method Review</h2>
    <p>Suppose $T$ is the token sequence to be generated, and $S_1, S_2, \cdots, S_n$ are several given contexts. We need to generate $T$ based on $S_1, S_2, \cdots, S_n$, which requires estimating $p(T|S_1, S_2, \cdots, S_n)$. According to the Naive Bayes principle, we obtain:</p>

    \begin{equation}\log p(T|S_1, S_2,\cdots,S_n) = \color{red}{(\beta + 1)\overline{\log p(T|S)}} - \color{green}{\beta\log p(T)} + \color{skyblue}{\text{constant}}\label{eq:nbce-2}\end{equation}

    <p>Where $\beta = n - 1$, $\overline{\log p(T|S)} = \frac{1}{n}\sum\limits_{k=1}^n \log p(T|S_k)$; details can be found in the previous article. NBCE made two changes: 1. It treats $\beta$ as a tunable hyperparameter; 2. It replaces $\overline{\log p(T|S)}$ with a general pooling method $\mathcal{P}$. The result becomes:</p>

    \begin{equation}\log p(T|S_1, S_2,\cdots,S_n) = \color{red}{(\beta + 1)\mathcal{P}[\log p(T|S)]} - \color{green}{\beta\log p(T)} + \color{skyblue}{\text{constant}}\label{eq:nbce-3}\end{equation}

    <p>Finally, the pooling scheme chosen by NBCE is "selecting the one with minimum entropy":</p>

    \begin{equation}\begin{aligned} 
    &\mathcal{P}[\log p(T|S)] = \log p(T|S_{\color{red}{k}}) \\[5pt] 
    &\color{red}{k} = \mathop{\text{argmin}} \big\{H_1,H_2,\cdots,H_n\big\} \\[5pt] 
    &H_i = -\sum_T p(T|S_i)\log p(T|S_i) 
    \end{aligned}\label{eq:min-h}\end{equation}

    <h2>Truncated Prediction</h2>
    <p>Equation $\eqref{eq:nbce-2}$ is the standard Naive Bayes result, but when I implemented it, I found that as $n$ increased, the effect of equation $\eqref{eq:nbce-2}$ gradually worsened until it became completely garbled. Therefore, after repeated adjustments, I eventually chose "selecting the one with minimum entropy" as the pooling scheme for NBCE. However, thinking about it carefully later, this behavior of equation $\eqref{eq:nbce-2}$ is abnormal. Since the only assumption of Naive Bayes is that contexts are independent of each other, and the contexts I tested were several randomly found news articles, this assumption is satisfied to some extent. Thus, equation $\eqref{eq:nbce-2}$ should not be so poor that it produces garbled code.</p>

    <p>While I was struck with confusion, @孔某人 (Kong Mouren) on WeChat reminded me: The training labels for language models are all One-Hot, so the prediction results are actually unreliable except for the head (the parts with the highest probability).</p>

    <p>This hint hit the nail on the head, and the answer became clear instantly: since equation $\eqref{eq:nbce-2}$ includes the $-\beta\log p(T)$ term, it amplifies the tail prediction results. If the tail predictions are unreliable, this amplification effect can even completely disrupt the accurate results of the head. Why doesn't it affect "selecting the one with minimum entropy"? Because in the minimum entropy result, the head probabilities tend to be larger and the tail probabilities smaller, so even if the $-\beta\log p(T)$ term amplifies the tail, it still cannot overcome the head. For equation $\eqref{eq:nbce-2}$, which is the average of all predictions, it weakens the head such that after adding $-\beta\log p(T)$, the tail overcomes the head.</p>

    <p>With this clue, the solution is obvious: add Top-P or Top-K truncation to each prediction result. In the Github code, I chose Top-P truncation.</p>

    <h2>Handling Infinity</h2>
    <p>However, that's not the end of it. After truncation, the tails of $\log p(T|S_k)$ and $\log p(T)$ both become $-\infty$. At this time, either equation $\eqref{eq:nbce-2}$ or equation $\eqref{eq:nbce-3}$ might result in meaningless operations like $(-\infty)-(-\infty)$. In general, there are the following situations:</p>

    \[\begin{array}{c|cc|c} 
    \hline 
    & \log p(T|S_k) & \log p(T) & \log p(T|S_k) - \log p(T) \\ 
    \hline 
    \text{Case 1} & > -\infty & > -\infty & > -\infty\\ 
    \text{Case 2} & > -\infty & = -\infty & = +\infty \\ 
    \text{Case 3} & = -\infty & > -\infty & = -\infty \\ 
    \text{Case 4} & = -\infty & = -\infty & \text{NaN}\\ 
    \hline 
    \end{array}\]

    <p>Among these, "Case 1" and "Case 3" can operate normally. Although "Case 2" can also operate normally, its result of positive infinity is unreasonable, and "Case 4" is an ill-defined meaningless operation. That is to say, we need to find a way to correct "Case 2" and "Case 4". These two cases exactly correspond to $\log p(T)=-\infty$, so we change equation $\eqref{eq:nbce-3}$ to:</p>

    \begin{equation}\log p(T|S_1, S_2,\cdots,S_n) =\left\{ 
    \begin{aligned} 
    &\color{red}{\mathcal{P}[\log p(T|S)]}, \quad \text{if }\color{green}{\log p(T) = -\infty} \\[5pt] 
    &\color{red}{(\beta + 1)\mathcal{P}[\log p(T|S)]} - \color{green}{\beta\log p(T)}, \quad \text{otherwise}\\ 
    \end{aligned}\right\} + \color{skyblue}{\text{constant}}\label{eq:nbce-4}\end{equation}

    <p>After the above processing, the standard Naive Bayes equation $\eqref{eq:nbce-2}$ can also output normal results (although the final effect is still not as good as selecting the minimum entropy, at least it won't produce garbled code), and the modified code is more robust to the pooling method and $\beta$.</p>

    <h2>Transfer Probabilities</h2>
    <p>When used to answer opinion-based questions or questions biased toward free creation, NBCE may experience issues with jumping back and forth between contexts. Specifically, because the model does not confidently focus on a particular context, the differences between $H_1, H_2, \cdots, H_n$ are small. Consequently, the $\mathop{\text{argmin}}$ result in equation $\eqref{eq:min-h}$ becomes unstable, selecting a different context for each generation step, which leads to semantic discontinuity or even complete irrelevance to the contexts, exacerbating the "hallucination" phenomenon of the LLM.</p>

    <p>To alleviate this problem, we can imitate the concept of transition probability by appropriately weighting the context selected in the previous step, making the model "not jump unless necessary." The specific method is to introduce a parameter $\eta > 0$ and change equation $\eqref{eq:min-h}$ to:</p>

    \begin{equation}\color{red}{k} = \mathop{\text{argmin}} \big\{H_1,\cdots,H_{k'-1},H_{k'}\color{red}{-\eta},H_{k'+1},\cdots,H_n\big\}\end{equation}

    <p>Where $k'$ is the index of the context selected during the previous generation step. In this way, a context jump will only occur when $H_k < H_{k'} - \eta$, reducing the probability of jumping.</p>

    <p>All the modifications mentioned above have been synchronized to GitHub.</p>

    <h2>Applicable Scenarios</h2>
    <p>Due to the independence assumption made by Naive Bayes, many readers might suspect: when there is obvious semantic overlap between contexts, will the effect of NBCE drop significantly? Or, what are the applicable scenarios for NBCE?</p>

    <p>In fact, it is the standard Naive Bayes, equation $\eqref{eq:nbce-2}$, that is limited by the independence assumption. The generalized equation $\eqref{eq:nbce-3}$ and equation $\eqref{eq:min-h}$ are basically no longer limited by the independence assumption. In essence, the "minimum entropy" version of NBCE uses the entropy of the LLM as a similarity measure to retrieve contexts, and the retrieval results are updated at each generation step. Therefore, the applicable scenario for NBCE is:</p>

    <p><strong>Assume the answer to be predicted can be divided into several segments, each segment depending only on one context.</strong></p>

    <p>Based on this conclusion, when we have only one piece of long text as a context (such as a novel), we can automatically divide the long context into multiple short contexts through overlapping sliding windows, rather than necessarily manually segmenting it into relatively independent parts. This is because the conclusion just mentioned tells us that the applicability of NBCE is unrelated to the overlap of the contexts. As for why overlapping sliding windows are used, it is simply to ensure that a complete result can be output by relying as much as possible on a single context.</p>

    <p>NBCE's performance will likely not be good in the following two scenarios:</p>
    <ol>
        <li><strong>Ordered Contexts</strong>: This refers to when the generation result strongly depends on the input order of the contexts (or even more complex nested structures). NBCE usually performs poorly because it retains the unordered nature of Naive Bayes. A typical example of this scenario is writing a summary for a novel (where the novel is cut into multiple contexts). A temporary solution is to manually add markers identifying the order to each context, such as "Chapter xx".</li>
        <li><strong>Coupled Contexts</strong>: This refers to when the output must be constructed by combining two or more contexts. NBCE performs poorly because it only selects one context at a time. @孔某人 gave a typical example: "Given $x > 1$ and $x < 0$, find the solution set for $x$". Assuming the two conditions are divided into two contexts, one must combine both contexts to output the correct answer "empty set"; looking at a single context alone cannot determine it is an empty set.</li>
    </ol>

    <p>If NBCE is to be further developed, it will generally revolve around improvements for these two scenarios.</p>

    <h2>Article Summary</h2>
    <p>This article introduced some subsequent updates and analyses of the context length extension scheme NBCE and further discussed its applicable scenarios.</p>
</article>
<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="https://kexue.fm/archives/9632" style="color: #005fcc;">https://kexue.fm/archives/9632</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
