
    <style type="text/css">

    body {
    margin: 48px auto;
    max-width: 68ch;              /* character-based width reads better */
    padding: 0 16px;

    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    line-height: 1.65;
    color: #333;
    background: #fafafa;
    }

    h1, h2, h3, h4 {
    line-height: 1.25;
    margin-top: 2.2em;
    margin-bottom: 0.6em;
    font-weight: 600;
    }

    h1 {
    font-size: 2.1em;
    margin-top: 0;
    }

    h2 {
    font-size: 1.6em;
    border-bottom: 1px solid #e5e5e5;
    padding-bottom: 0.3em;
    }

    h3 {
    font-size: 1.25em;
    }

    h4 {
    font-size: 1.05em;
    color: #555;
    }

    /* Paragraphs and lists */
    p {
    margin: 1em 0;
    }

    ul, ol {
    margin: 1em 0 1em 1.5em;
    }

    li {
    margin: 0.4em 0;
    }

    a {
    color: #005fcc;
    text-decoration: none;
    }

    a:hover {
    text-decoration: underline;
    }

    code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.95em;
    background: #f2f2f2;
    padding: 0.15em 0.35em;
    border-radius: 4px;
    }

    pre {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1em 1.2em;
    overflow-x: auto;
    border-radius: 6px;
    line-height: 1.45;
    }

    pre code {
    background: none;
    padding: 0;
    }

    blockquote {
    margin: 1.5em 0;
    padding-left: 1em;
    border-left: 4px solid #ddd;
    color: #555;
    }

    hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 3em 0;
    }

    table {
    border-collapse: collapse;
    margin: 1.5em 0;
    width: 100%;
    font-size: 0.95em;
    }

    th, td {
    padding: 0.5em 0.7em;
    border-bottom: 1px solid #e5e5e5;
    text-align: left;
    }

    th {
    font-weight: 600;
    }

    img {
    max-width: 100%;
    display: block;
    margin: 1.5em auto;
    }

    small {
    color: #666;
    }

    mjx-container {
    margin: 1em 0;
    }

    ::selection {
    background: #cce2ff;
    }

    </style>
    

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    tags: 'ams',
    packages: {'[+]': ['ams']}
  }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<article>
  <nav style="margin-bottom: 1.5em;">
    <a href="../index.html" style="display: inline-flex; align-items: center; color: #555; text-decoration: none; font-size: 0.95em;">
        <span style="margin-right: 0.3em;">&larr;</span> Back to Index
    </a>
</nav>

  <h1><a href="https://kexue.fm/archives/4231">Python Multiprocessing Programming Tips</a></h1>
  <p>By 苏剑林 | February 19, 2017</p>

  <h2>The Process</h2>
  <p>In Python, if you want to perform multiprocessing calculations, it is generally implemented through <code>multiprocessing</code>. The most commonly used feature is the process pool in <code>multiprocessing</code>, for example:</p>

<pre><code class="language-python"></code></pre>

  <p>Writing it this way is concise and clear, which is indeed convenient. Interestingly, you only need to replace <code>multiprocessing</code> with <code>multiprocessing.dummy</code> to change the program from multi-processing to multi-threading.</p>

  <h2>Objects</h2>
  <p>Python is an object-oriented programming language, and we often encapsulate certain programs into a class. However, within a class, the above method no longer works. For example:</p>

<pre><code class="language-python"></code></pre>

  <p>The code looks quite natural, but it throws an error during execution:</p>
  <blockquote>cPickle.PicklingError: Can't pickle : attribute lookup __builtin__.function failed</blockquote>
  <p>However, if you replace <code>multiprocessing</code> with <code>multiprocessing.dummy</code>, no error is reported. Simply put, this is still due to the issue that variables cannot be shared between multiple processes, whereas multiple threads reside within the same process and naturally do not have this problem.</p>

  <h2>Drawing Inspiration</h2>
  <p>To study multiprocessing programming within objects, I made quite a few attempts. Later, I thought of how many modules in <code>gensim</code> support parallelism, so I decided to imitate them. Sure enough, I found <a href="https://github.com/RaRe-Technologies/gensim/blob/develop/gensim/models/ldamulticore.py">ldamulticore.py</a>. After repeatedly comparing and learning from online materials, I summarized a relatively concise, convenient, and universal way of writing it.</p>
  <p>Like most multiprocessing programming, a <code>Queue</code> object needs to be established for communication between processes. The difference is that most online tutorials use the <code>Process</code> function from <code>multiprocessing</code> combined with loop statements to start multiple processes, while using <code>Pool</code> would fail (unless using <code>multiprocessing.Manager.Queue</code>, refer to <a href="https://my.oschina.net/yangyanxing/blog/296052">this article</a>). However, <code>gensim</code> uses a trick with <code>Pool</code>, allowing multiple processes to be started directly via <code>Pool</code>—the work of experts is truly different. The reference code is as follows:</p>

<pre><code class="language-python"></code></pre>

  <p>In short, it involves establishing two Queues: one responsible for task queuing and the other for fetching results. What's quite magical is that <code>Pool</code> actually has a second and third parameter! For specific explanations, please see the <a href="https://docs.python.org/2/library/multiprocessing.html#module-multiprocessing.pool">official documentation</a> regarding the <code>Pool</code> initialization function, which also runs in parallel automatically.</p>
  <p>Note that after executing the line <code>pool = Pool(4, f, (in_queue, out_queue))</code>, the multiple processes start, but it does not wait for the processes to finish; instead, it immediately executes the subsequent statements. At this point, you can use <code>pool.close()</code> and <code>pool.join()</code> as before to let the processes complete before continuing. The solution used here, however, is to directly execute the statement that retrieves results and then determine whether the processes have finished through that process; once finished, the process pool is closed via <code>pool.terminate()</code>. This writing style is basically universal.</p>
</article>
<hr>
<footer style="margin-top: 3em; padding: 1.5em; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; color: #555;">
    <p style="margin: 0 0 0.5em 0;"><strong>Citation</strong></p>
    <p style="margin: 0 0 0.5em 0;">
        This is a machine translation of the original Chinese article:<br>
        <a href="https://kexue.fm/archives/4231" style="color: #005fcc;">https://kexue.fm/archives/4231</a>
    </p>
    <p style="margin: 0 0 0.5em 0;">
        Original author: 苏剑林 (Su Jianlin)<br>
        Original publication: <a href="https://kexue.fm" style="color: #005fcc;">科学空间 (Scientific Spaces)</a>
    </p>
    <p style="margin: 0; font-style: italic;">
        Translated using Gemini 3 Flash. Please refer to the original for authoritative content.
    </p>
</footer>
